<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>LCOV - PHP Code Coverage - ext/standard/array.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
        <tr>
          <td width="5%"></td>
          <td width="10%" class="headerItem">Current view:</td>
          <td width="35%" class="headerValue"><a href="../../index.html">directory</a> - <a href="index.html">ext/standard</a> - array.c (source / <a href="array.c.func.html">functions</a>)</td>
          <td width="10%"></td>
          <td width="10%" class="headerCovTableHead">Found</td>
          <td width="10%" class="headerCovTableHead">Hit</td>
          <td width="15%" class="headerCovTableHead">Coverage</td>
          <td width="5%"></td>
        </tr>
        <tr>
          <td></td>
          <td class="headerItem">Test:</td>
          <td class="headerValue">PHP Code Coverage</td>
          <td class="headerItem">Lines:</td>
          <td class="headerCovTableEntry">2100</td>
          <td class="headerCovTableEntry">173</td>
          <td class="headerCovTableEntryLo">8.2 %</td>
        </tr>
        <tr>
          <td></td>
          <td class="headerItem">Date:</td>
          <td class="headerValue">2012-06-19</td>
          <td class="headerItem">Functions:</td>
          <td class="headerCovTableEntry">107</td>
          <td class="headerCovTableEntry">20</td>
          <td class="headerCovTableEntryLo">18.7 %</td>
        </tr>
        <tr>
          <td></td>
          <td class="headerItem">Colors:</td>
          <td class="headerValueLeg" colspan=5>
            <span class="coverLegendNoCov">not hit</span>
            <span class="coverLegendCov">hit</span>
          </td>
        </tr>
                <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td><pre class="source">
<a name="1"><span class="lineNum">       1 </span>                : /* </a>
<span class="lineNum">       2 </span>                :    +----------------------------------------------------------------------+
<span class="lineNum">       3 </span>                :    | PHP Version 5                                                        |
<span class="lineNum">       4 </span>                :    +----------------------------------------------------------------------+
<span class="lineNum">       5 </span>                :    | Copyright (c) 1997-2012 The PHP Group                                |
<span class="lineNum">       6 </span>                :    +----------------------------------------------------------------------+
<span class="lineNum">       7 </span>                :    | This source file is subject to version 3.01 of the PHP license,      |
<span class="lineNum">       8 </span>                :    | that is bundled with this package in the file LICENSE, and is        |
<span class="lineNum">       9 </span>                :    | available through the world-wide-web at the following url:           |
<span class="lineNum">      10 </span>                :    | http://www.php.net/license/3_01.txt                                  |
<span class="lineNum">      11 </span>                :    | If you did not receive a copy of the PHP license and are unable to   |
<span class="lineNum">      12 </span>                :    | obtain it through the world-wide-web, please send a note to          |
<span class="lineNum">      13 </span>                :    | license@php.net so we can mail you a copy immediately.               |
<span class="lineNum">      14 </span>                :    +----------------------------------------------------------------------+
<span class="lineNum">      15 </span>                :    | Authors: Andi Gutmans &lt;andi@zend.com&gt;                                |
<span class="lineNum">      16 </span>                :    |          Zeev Suraski &lt;zeev@zend.com&gt;                                |
<span class="lineNum">      17 </span>                :    |          Rasmus Lerdorf &lt;rasmus@php.net&gt;                             |
<span class="lineNum">      18 </span>                :    |          Andrei Zmievski &lt;andrei@php.net&gt;                            |
<span class="lineNum">      19 </span>                :    |          Stig Venaas &lt;venaas@php.net&gt;                                |
<span class="lineNum">      20 </span>                :    |          Jason Greene &lt;jason@php.net&gt;                                |
<span class="lineNum">      21 </span>                :    +----------------------------------------------------------------------+
<span class="lineNum">      22 </span>                : */
<span class="lineNum">      23 </span>                : 
<span class="lineNum">      24 </span>                : /* $Id$ */
<span class="lineNum">      25 </span>                : 
<span class="lineNum">      26 </span>                : #include &quot;php.h&quot;
<span class="lineNum">      27 </span>                : #include &quot;php_ini.h&quot;
<span class="lineNum">      28 </span>                : #include &lt;stdarg.h&gt;
<span class="lineNum">      29 </span>                : #include &lt;stdlib.h&gt;
<span class="lineNum">      30 </span>                : #include &lt;math.h&gt;
<span class="lineNum">      31 </span>                : #include &lt;time.h&gt;
<span class="lineNum">      32 </span>                : #include &lt;stdio.h&gt;
<span class="lineNum">      33 </span>                : #if HAVE_STRING_H
<span class="lineNum">      34 </span>                : #include &lt;string.h&gt;
<span class="lineNum">      35 </span>                : #else
<span class="lineNum">      36 </span>                : #include &lt;strings.h&gt;
<span class="lineNum">      37 </span>                : #endif
<span class="lineNum">      38 </span>                : #ifdef PHP_WIN32
<span class="lineNum">      39 </span>                : #include &quot;win32/unistd.h&quot;
<span class="lineNum">      40 </span>                : #endif
<span class="lineNum">      41 </span>                : #include &quot;zend_globals.h&quot;
<span class="lineNum">      42 </span>                : #include &quot;zend_interfaces.h&quot;
<span class="lineNum">      43 </span>                : #include &quot;php_globals.h&quot;
<span class="lineNum">      44 </span>                : #include &quot;php_array.h&quot;
<span class="lineNum">      45 </span>                : #include &quot;basic_functions.h&quot;
<span class="lineNum">      46 </span>                : #include &quot;php_string.h&quot;
<span class="lineNum">      47 </span>                : #include &quot;php_rand.h&quot;
<span class="lineNum">      48 </span>                : #include &quot;php_smart_str.h&quot;
<span class="lineNum">      49 </span>                : #ifdef HAVE_SPL
<span class="lineNum">      50 </span>                : #include &quot;ext/spl/spl_array.h&quot;
<span class="lineNum">      51 </span>                : #endif
<span class="lineNum">      52 </span>                : 
<span class="lineNum">      53 </span>                : /* {{{ defines */
<span class="lineNum">      54 </span>                : #define EXTR_OVERWRITE                  0
<span class="lineNum">      55 </span>                : #define EXTR_SKIP                               1
<span class="lineNum">      56 </span>                : #define EXTR_PREFIX_SAME                2
<span class="lineNum">      57 </span>                : #define EXTR_PREFIX_ALL                 3
<span class="lineNum">      58 </span>                : #define EXTR_PREFIX_INVALID             4
<span class="lineNum">      59 </span>                : #define EXTR_PREFIX_IF_EXISTS   5
<span class="lineNum">      60 </span>                : #define EXTR_IF_EXISTS                  6
<span class="lineNum">      61 </span>                : 
<span class="lineNum">      62 </span>                : #define EXTR_REFS                               0x100
<span class="lineNum">      63 </span>                : 
<span class="lineNum">      64 </span>                : #define CASE_LOWER                              0
<span class="lineNum">      65 </span>                : #define CASE_UPPER                              1
<span class="lineNum">      66 </span>                : 
<span class="lineNum">      67 </span>                : #define COUNT_NORMAL                    0
<span class="lineNum">      68 </span>                : #define COUNT_RECURSIVE                 1
<span class="lineNum">      69 </span>                : 
<span class="lineNum">      70 </span>                : #define DIFF_NORMAL                     1
<span class="lineNum">      71 </span>                : #define DIFF_KEY                        2
<span class="lineNum">      72 </span>                : #define DIFF_ASSOC                      6
<span class="lineNum">      73 </span>                : #define DIFF_COMP_DATA_NONE    -1
<span class="lineNum">      74 </span>                : #define DIFF_COMP_DATA_INTERNAL 0
<span class="lineNum">      75 </span>                : #define DIFF_COMP_DATA_USER     1
<span class="lineNum">      76 </span>                : #define DIFF_COMP_KEY_INTERNAL  0
<span class="lineNum">      77 </span>                : #define DIFF_COMP_KEY_USER      1
<span class="lineNum">      78 </span>                : 
<span class="lineNum">      79 </span>                : #define INTERSECT_NORMAL                1
<span class="lineNum">      80 </span>                : #define INTERSECT_KEY                   2
<span class="lineNum">      81 </span>                : #define INTERSECT_ASSOC                 6
<span class="lineNum">      82 </span>                : #define INTERSECT_COMP_DATA_NONE    -1
<span class="lineNum">      83 </span>                : #define INTERSECT_COMP_DATA_INTERNAL 0
<span class="lineNum">      84 </span>                : #define INTERSECT_COMP_DATA_USER     1
<span class="lineNum">      85 </span>                : #define INTERSECT_COMP_KEY_INTERNAL  0
<span class="lineNum">      86 </span>                : #define INTERSECT_COMP_KEY_USER      1
<span class="lineNum">      87 </span>                : 
<span class="lineNum">      88 </span>                : #define DOUBLE_DRIFT_FIX        0.000000000000001
<span class="lineNum">      89 </span>                : /* }}} */
<span class="lineNum">      90 </span>                : 
<span class="lineNum">      91 </span>                : ZEND_DECLARE_MODULE_GLOBALS(array)
<span class="lineNum">      92 </span>                : 
<a name="93"><span class="lineNum">      93 </span>                : /* {{{ php_array_init_globals</a>
<span class="lineNum">      94 </span>                : */
<span class="lineNum">      95 </span><span class="lineCov">             48 : static void php_array_init_globals(zend_array_globals *array_globals)</span>
<span class="lineNum">      96 </span>                : {
<span class="lineNum">      97 </span><span class="lineCov">             48 :         memset(array_globals, 0, sizeof(zend_array_globals));</span>
<span class="lineNum">      98 </span><span class="lineCov">             48 : }</span>
<a name="99"><span class="lineNum">      99 </span>                : /* }}} */</a>
<span class="lineNum">     100 </span>                : 
<span class="lineNum">     101 </span><span class="lineCov">             48 : PHP_MINIT_FUNCTION(array) /* {{{ */</span>
<span class="lineNum">     102 </span>                : {
<span class="lineNum">     103 </span><span class="lineCov">             48 :         ZEND_INIT_MODULE_GLOBALS(array, php_array_init_globals, NULL);</span>
<span class="lineNum">     104 </span>                : 
<span class="lineNum">     105 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_OVERWRITE&quot;, EXTR_OVERWRITE, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     106 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_SKIP&quot;, EXTR_SKIP, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     107 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_PREFIX_SAME&quot;, EXTR_PREFIX_SAME, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     108 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_PREFIX_ALL&quot;, EXTR_PREFIX_ALL, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     109 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_PREFIX_INVALID&quot;, EXTR_PREFIX_INVALID, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     110 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_PREFIX_IF_EXISTS&quot;, EXTR_PREFIX_IF_EXISTS, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     111 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_IF_EXISTS&quot;, EXTR_IF_EXISTS, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     112 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;EXTR_REFS&quot;, EXTR_REFS, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     113 </span>                : 
<span class="lineNum">     114 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_ASC&quot;, PHP_SORT_ASC, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     115 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_DESC&quot;, PHP_SORT_DESC, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     116 </span>                : 
<span class="lineNum">     117 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_REGULAR&quot;, PHP_SORT_REGULAR, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     118 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_NUMERIC&quot;, PHP_SORT_NUMERIC, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     119 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_STRING&quot;, PHP_SORT_STRING, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     120 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_LOCALE_STRING&quot;, PHP_SORT_LOCALE_STRING, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     121 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_NATURAL&quot;, PHP_SORT_NATURAL, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     122 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;SORT_FLAG_CASE&quot;, PHP_SORT_FLAG_CASE, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     123 </span>                : 
<span class="lineNum">     124 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;CASE_LOWER&quot;, CASE_LOWER, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     125 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;CASE_UPPER&quot;, CASE_UPPER, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     126 </span>                : 
<span class="lineNum">     127 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;COUNT_NORMAL&quot;, COUNT_NORMAL, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     128 </span><span class="lineCov">             48 :         REGISTER_LONG_CONSTANT(&quot;COUNT_RECURSIVE&quot;, COUNT_RECURSIVE, CONST_CS | CONST_PERSISTENT);</span>
<span class="lineNum">     129 </span>                : 
<span class="lineNum">     130 </span><span class="lineCov">             48 :         return SUCCESS;</span>
<span class="lineNum">     131 </span>                : }
<a name="132"><span class="lineNum">     132 </span>                : /* }}} */</a>
<span class="lineNum">     133 </span>                : 
<span class="lineNum">     134 </span><span class="lineCov">             48 : PHP_MSHUTDOWN_FUNCTION(array) /* {{{ */</span>
<span class="lineNum">     135 </span>                : {
<span class="lineNum">     136 </span>                : #ifdef ZTS
<span class="lineNum">     137 </span>                :         ts_free_id(array_globals_id);
<span class="lineNum">     138 </span>                : #endif
<span class="lineNum">     139 </span>                : 
<span class="lineNum">     140 </span><span class="lineCov">             48 :         return SUCCESS;</span>
<span class="lineNum">     141 </span>                : }
<a name="142"><span class="lineNum">     142 </span>                : /* }}} */</a>
<span class="lineNum">     143 </span>                : 
<span class="lineNum">     144 </span><span class="lineCov">              1 : static void php_set_compare_func(int sort_type TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     145 </span>                : {
<span class="lineNum">     146 </span><span class="lineCov">              1 :         switch (sort_type &amp; ~PHP_SORT_FLAG_CASE) {</span>
<span class="lineNum">     147 </span>                :                 case PHP_SORT_NUMERIC:
<span class="lineNum">     148 </span><span class="lineNoCov">              0 :                         ARRAYG(compare_func) = numeric_compare_function;</span>
<span class="lineNum">     149 </span><span class="lineNoCov">              0 :                         break;</span>
<span class="lineNum">     150 </span>                : 
<span class="lineNum">     151 </span>                :                 case PHP_SORT_STRING:
<span class="lineNum">     152 </span><span class="lineCov">              1 :                         ARRAYG(compare_func) = sort_type &amp; PHP_SORT_FLAG_CASE ? string_case_compare_function : string_compare_function;</span>
<span class="lineNum">     153 </span><span class="lineCov">              1 :                         break;</span>
<span class="lineNum">     154 </span>                : 
<span class="lineNum">     155 </span>                :                 case PHP_SORT_NATURAL:
<span class="lineNum">     156 </span><span class="lineNoCov">              0 :                         ARRAYG(compare_func) = sort_type &amp; PHP_SORT_FLAG_CASE ? string_natural_case_compare_function : string_natural_compare_function;</span>
<span class="lineNum">     157 </span><span class="lineNoCov">              0 :                         break;</span>
<span class="lineNum">     158 </span>                : 
<span class="lineNum">     159 </span>                : #if HAVE_STRCOLL
<span class="lineNum">     160 </span>                :                 case PHP_SORT_LOCALE_STRING:
<span class="lineNum">     161 </span><span class="lineNoCov">              0 :                         ARRAYG(compare_func) = string_locale_compare_function;</span>
<span class="lineNum">     162 </span><span class="lineNoCov">              0 :                         break;</span>
<span class="lineNum">     163 </span>                : #endif
<span class="lineNum">     164 </span>                : 
<span class="lineNum">     165 </span>                :                 case PHP_SORT_REGULAR:
<span class="lineNum">     166 </span>                :                 default:
<span class="lineNum">     167 </span><span class="lineNoCov">              0 :                         ARRAYG(compare_func) = compare_function;</span>
<span class="lineNum">     168 </span>                :                         break;
<span class="lineNum">     169 </span>                :         }
<span class="lineNum">     170 </span><span class="lineCov">              1 : }</span>
<a name="171"><span class="lineNum">     171 </span>                : /* }}} */</a>
<span class="lineNum">     172 </span>                : 
<span class="lineNum">     173 </span><span class="lineNoCov">              0 : static int php_array_key_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     174 </span>                : {
<span class="lineNum">     175 </span>                :         Bucket *f;
<span class="lineNum">     176 </span>                :         Bucket *s;
<span class="lineNum">     177 </span>                :         zval result;
<span class="lineNum">     178 </span>                :         zval first;
<span class="lineNum">     179 </span>                :         zval second;
<span class="lineNum">     180 </span>                : 
<span class="lineNum">     181 </span><span class="lineNoCov">              0 :         f = *((Bucket **) a);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">              0 :         s = *((Bucket **) b);</span>
<span class="lineNum">     183 </span>                : 
<span class="lineNum">     184 </span><span class="lineNoCov">              0 :         if (f-&gt;nKeyLength == 0) {</span>
<span class="lineNum">     185 </span><span class="lineNoCov">              0 :                 Z_TYPE(first) = IS_LONG;</span>
<span class="lineNum">     186 </span><span class="lineNoCov">              0 :                 Z_LVAL(first) = f-&gt;h;</span>
<span class="lineNum">     187 </span>                :         } else {
<span class="lineNum">     188 </span><span class="lineNoCov">              0 :                 Z_TYPE(first) = IS_STRING;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">              0 :                 Z_STRVAL(first) = (char*)f-&gt;arKey;</span>
<span class="lineNum">     190 </span><span class="lineNoCov">              0 :                 Z_STRLEN(first) = f-&gt;nKeyLength - 1;</span>
<span class="lineNum">     191 </span>                :         }
<span class="lineNum">     192 </span>                : 
<span class="lineNum">     193 </span><span class="lineNoCov">              0 :         if (s-&gt;nKeyLength == 0) {</span>
<span class="lineNum">     194 </span><span class="lineNoCov">              0 :                 Z_TYPE(second) = IS_LONG;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">              0 :                 Z_LVAL(second) = s-&gt;h;</span>
<span class="lineNum">     196 </span>                :         } else {
<span class="lineNum">     197 </span><span class="lineNoCov">              0 :                 Z_TYPE(second) = IS_STRING;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">              0 :                 Z_STRVAL(second) = (char*)s-&gt;arKey;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">              0 :                 Z_STRLEN(second) = s-&gt;nKeyLength - 1;</span>
<span class="lineNum">     200 </span>                :         }
<span class="lineNum">     201 </span>                : 
<span class="lineNum">     202 </span><span class="lineNoCov">              0 :         if (ARRAYG(compare_func)(&amp;result, &amp;first, &amp;second TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     203 </span><span class="lineNoCov">              0 :                 return 0;</span>
<span class="lineNum">     204 </span>                :         }
<span class="lineNum">     205 </span>                : 
<span class="lineNum">     206 </span><span class="lineNoCov">              0 :         if (Z_TYPE(result) == IS_DOUBLE) {</span>
<span class="lineNum">     207 </span><span class="lineNoCov">              0 :                 if (Z_DVAL(result) &lt; 0) {</span>
<span class="lineNum">     208 </span><span class="lineNoCov">              0 :                         return -1;</span>
<span class="lineNum">     209 </span><span class="lineNoCov">              0 :                 } else if (Z_DVAL(result) &gt; 0) {</span>
<span class="lineNum">     210 </span><span class="lineNoCov">              0 :                         return 1;</span>
<span class="lineNum">     211 </span>                :                 } else {
<span class="lineNum">     212 </span><span class="lineNoCov">              0 :                         return 0;</span>
<span class="lineNum">     213 </span>                :                 }
<span class="lineNum">     214 </span>                :         }
<span class="lineNum">     215 </span>                : 
<span class="lineNum">     216 </span><span class="lineNoCov">              0 :         convert_to_long(&amp;result);</span>
<span class="lineNum">     217 </span>                : 
<span class="lineNum">     218 </span><span class="lineNoCov">              0 :         if (Z_LVAL(result) &lt; 0) {</span>
<span class="lineNum">     219 </span><span class="lineNoCov">              0 :                 return -1;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">              0 :         } else if (Z_LVAL(result) &gt; 0) {</span>
<span class="lineNum">     221 </span><span class="lineNoCov">              0 :                 return 1;</span>
<span class="lineNum">     222 </span>                :         }
<span class="lineNum">     223 </span>                : 
<span class="lineNum">     224 </span><span class="lineNoCov">              0 :         return 0;</span>
<span class="lineNum">     225 </span>                : }
<a name="226"><span class="lineNum">     226 </span>                : /* }}} */</a>
<span class="lineNum">     227 </span>                : 
<span class="lineNum">     228 </span><span class="lineNoCov">              0 : static int php_array_reverse_key_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     229 </span>                : {
<span class="lineNum">     230 </span><span class="lineNoCov">              0 :         return php_array_key_compare(a, b TSRMLS_CC) * -1;</span>
<span class="lineNum">     231 </span>                : }
<span class="lineNum">     232 </span>                : /* }}} */
<span class="lineNum">     233 </span>                : 
<a name="234"><span class="lineNum">     234 </span>                : /* {{{ proto bool krsort(array &amp;array_arg [, int sort_flags])</a>
<span class="lineNum">     235 </span>                :    Sort an array by key value in reverse order */
<span class="lineNum">     236 </span><span class="lineNoCov">              0 : PHP_FUNCTION(krsort)</span>
<span class="lineNum">     237 </span>                : {
<span class="lineNum">     238 </span>                :         zval *array;
<span class="lineNum">     239 </span><span class="lineNoCov">              0 :         long sort_type = PHP_SORT_REGULAR;</span>
<span class="lineNum">     240 </span>                : 
<span class="lineNum">     241 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;sort_type) == FAILURE) {</span>
<span class="lineNum">     242 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     243 </span>                :         }
<span class="lineNum">     244 </span>                : 
<span class="lineNum">     245 </span><span class="lineNoCov">              0 :         php_set_compare_func(sort_type TSRMLS_CC);</span>
<span class="lineNum">     246 </span>                : 
<span class="lineNum">     247 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_reverse_key_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     248 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     249 </span>                :         }
<span class="lineNum">     250 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">     251 </span>                : }
<span class="lineNum">     252 </span>                : /* }}} */
<span class="lineNum">     253 </span>                : 
<a name="254"><span class="lineNum">     254 </span>                : /* {{{ proto bool ksort(array &amp;array_arg [, int sort_flags])</a>
<span class="lineNum">     255 </span>                :    Sort an array by key */
<span class="lineNum">     256 </span><span class="lineNoCov">              0 : PHP_FUNCTION(ksort)</span>
<span class="lineNum">     257 </span>                : {
<span class="lineNum">     258 </span>                :         zval *array;
<span class="lineNum">     259 </span><span class="lineNoCov">              0 :         long sort_type = PHP_SORT_REGULAR;</span>
<span class="lineNum">     260 </span>                : 
<span class="lineNum">     261 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;sort_type) == FAILURE) {</span>
<span class="lineNum">     262 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     263 </span>                :         }
<span class="lineNum">     264 </span>                : 
<span class="lineNum">     265 </span><span class="lineNoCov">              0 :         php_set_compare_func(sort_type TSRMLS_CC);</span>
<span class="lineNum">     266 </span>                : 
<span class="lineNum">     267 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_key_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     268 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     269 </span>                :         }
<span class="lineNum">     270 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">     271 </span>                : }
<a name="272"><span class="lineNum">     272 </span>                : /* }}} */</a>
<span class="lineNum">     273 </span>                : 
<span class="lineNum">     274 </span><span class="lineCov">             30 : static int php_count_recursive(zval *array, long mode TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     275 </span>                : {
<span class="lineNum">     276 </span><span class="lineCov">             30 :         long cnt = 0;</span>
<span class="lineNum">     277 </span>                :         zval **element;
<span class="lineNum">     278 </span>                : 
<span class="lineNum">     279 </span><span class="lineCov">             30 :         if (Z_TYPE_P(array) == IS_ARRAY) {</span>
<span class="lineNum">     280 </span><span class="lineCov">             30 :                 if (Z_ARRVAL_P(array)-&gt;nApplyCount &gt; 1) {</span>
<span class="lineNum">     281 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;recursion detected&quot;);</span>
<span class="lineNum">     282 </span><span class="lineNoCov">              0 :                         return 0;</span>
<span class="lineNum">     283 </span>                :                 }
<span class="lineNum">     284 </span>                : 
<span class="lineNum">     285 </span><span class="lineCov">             30 :                 cnt = zend_hash_num_elements(Z_ARRVAL_P(array));</span>
<span class="lineNum">     286 </span><span class="lineCov">             30 :                 if (mode == COUNT_RECURSIVE) {</span>
<span class="lineNum">     287 </span>                :                         HashPosition pos;
<span class="lineNum">     288 </span>                : 
<span class="lineNum">     289 </span><span class="lineNoCov">              0 :                         for (zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">     290 </span><span class="lineNoCov">              0 :                                 zend_hash_get_current_data_ex(Z_ARRVAL_P(array), (void **) &amp;element, &amp;pos) == SUCCESS;</span>
<span class="lineNum">     291 </span>                :                                 zend_hash_move_forward_ex(Z_ARRVAL_P(array), &amp;pos)
<span class="lineNum">     292 </span><span class="lineNoCov">              0 :                         ) {</span>
<span class="lineNum">     293 </span><span class="lineNoCov">              0 :                                 Z_ARRVAL_P(array)-&gt;nApplyCount++;</span>
<span class="lineNum">     294 </span><span class="lineNoCov">              0 :                                 cnt += php_count_recursive(*element, COUNT_RECURSIVE TSRMLS_CC);</span>
<span class="lineNum">     295 </span><span class="lineNoCov">              0 :                                 Z_ARRVAL_P(array)-&gt;nApplyCount--;</span>
<span class="lineNum">     296 </span>                :                         }
<span class="lineNum">     297 </span>                :                 }
<span class="lineNum">     298 </span>                :         }
<span class="lineNum">     299 </span>                : 
<span class="lineNum">     300 </span><span class="lineCov">             30 :         return cnt;</span>
<span class="lineNum">     301 </span>                : }
<span class="lineNum">     302 </span>                : /* }}} */
<span class="lineNum">     303 </span>                : 
<a name="304"><span class="lineNum">     304 </span>                : /* {{{ proto int count(mixed var [, int mode])</a>
<span class="lineNum">     305 </span>                :    Count the number of elements in a variable (usually an array) */
<span class="lineNum">     306 </span><span class="lineCov">            492 : PHP_FUNCTION(count)</span>
<span class="lineNum">     307 </span>                : {
<span class="lineNum">     308 </span>                :         zval *array;
<span class="lineNum">     309 </span><span class="lineCov">            492 :         long mode = COUNT_NORMAL;</span>
<span class="lineNum">     310 </span>                : 
<span class="lineNum">     311 </span><span class="lineCov">            492 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;z|l&quot;, &amp;array, &amp;mode) == FAILURE) {</span>
<span class="lineNum">     312 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     313 </span>                :         }
<span class="lineNum">     314 </span>                : 
<span class="lineNum">     315 </span><span class="lineCov">            492 :         switch (Z_TYPE_P(array)) {</span>
<span class="lineNum">     316 </span>                :                 case IS_NULL:
<span class="lineNum">     317 </span><span class="lineCov">            378 :                         RETURN_LONG(0);</span>
<span class="lineNum">     318 </span>                :                         break;
<span class="lineNum">     319 </span>                :                 case IS_ARRAY:
<span class="lineNum">     320 </span><span class="lineCov">             30 :                         RETURN_LONG (php_count_recursive (array, mode TSRMLS_CC));</span>
<span class="lineNum">     321 </span>                :                         break;
<span class="lineNum">     322 </span>                :                 case IS_OBJECT: {
<span class="lineNum">     323 </span>                : #ifdef HAVE_SPL
<span class="lineNum">     324 </span>                :                         zval *retval;
<span class="lineNum">     325 </span>                : #endif
<span class="lineNum">     326 </span>                :                         /* first, we check if the handler is defined */
<span class="lineNum">     327 </span><span class="lineNoCov">              0 :                         if (Z_OBJ_HT_P(array)-&gt;count_elements) {</span>
<span class="lineNum">     328 </span><span class="lineNoCov">              0 :                                 RETVAL_LONG(1);</span>
<span class="lineNum">     329 </span><span class="lineNoCov">              0 :                                 if (SUCCESS == Z_OBJ_HT(*array)-&gt;count_elements(array, &amp;Z_LVAL_P(return_value) TSRMLS_CC)) {</span>
<span class="lineNum">     330 </span><span class="lineNoCov">              0 :                                         return;</span>
<span class="lineNum">     331 </span>                :                                 }
<span class="lineNum">     332 </span>                :                         }
<span class="lineNum">     333 </span>                : #ifdef HAVE_SPL
<span class="lineNum">     334 </span>                :                         /* if not and the object implements Countable we call its count() method */
<span class="lineNum">     335 </span><span class="lineNoCov">              0 :                         if (Z_OBJ_HT_P(array)-&gt;get_class_entry &amp;&amp; instanceof_function(Z_OBJCE_P(array), spl_ce_Countable TSRMLS_CC)) {</span>
<span class="lineNum">     336 </span><span class="lineNoCov">              0 :                                 zend_call_method_with_0_params(&amp;array, NULL, NULL, &quot;count&quot;, &amp;retval);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">              0 :                                 if (retval) {</span>
<span class="lineNum">     338 </span><span class="lineNoCov">              0 :                                         convert_to_long_ex(&amp;retval);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">              0 :                                         RETVAL_LONG(Z_LVAL_P(retval));</span>
<span class="lineNum">     340 </span><span class="lineNoCov">              0 :                                         zval_ptr_dtor(&amp;retval);</span>
<span class="lineNum">     341 </span>                :                                 }
<span class="lineNum">     342 </span><span class="lineNoCov">              0 :                                 return;</span>
<span class="lineNum">     343 </span>                :                         }
<span class="lineNum">     344 </span>                : #endif
<span class="lineNum">     345 </span>                :                 }
<span class="lineNum">     346 </span>                :                 default:
<span class="lineNum">     347 </span><span class="lineCov">             84 :                         RETURN_LONG(1);</span>
<span class="lineNum">     348 </span>                :                         break;
<span class="lineNum">     349 </span>                :         }
<span class="lineNum">     350 </span>                : }
<span class="lineNum">     351 </span>                : /* }}} */
<span class="lineNum">     352 </span>                : 
<span class="lineNum">     353 </span>                : /* Numbers are always smaller than strings int this function as it
<span class="lineNum">     354 </span>                :  * anyway doesn't make much sense to compare two different data types.
<span class="lineNum">     355 </span>                :  * This keeps it consistant and simple.
<span class="lineNum">     356 </span>                :  *
<a name="357"><span class="lineNum">     357 </span>                :  * This is not correct any more, depends on what compare_func is set to.</a>
<span class="lineNum">     358 </span>                :  */
<span class="lineNum">     359 </span><span class="lineCov">            243 : static int php_array_data_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     360 </span>                : {
<span class="lineNum">     361 </span>                :         Bucket *f;
<span class="lineNum">     362 </span>                :         Bucket *s;
<span class="lineNum">     363 </span>                :         zval result;
<span class="lineNum">     364 </span>                :         zval *first;
<span class="lineNum">     365 </span>                :         zval *second;
<span class="lineNum">     366 </span>                : 
<span class="lineNum">     367 </span><span class="lineCov">            243 :         f = *((Bucket **) a);</span>
<span class="lineNum">     368 </span><span class="lineCov">            243 :         s = *((Bucket **) b);</span>
<span class="lineNum">     369 </span>                : 
<span class="lineNum">     370 </span><span class="lineCov">            243 :         first = *((zval **) f-&gt;pData);</span>
<span class="lineNum">     371 </span><span class="lineCov">            243 :         second = *((zval **) s-&gt;pData);</span>
<span class="lineNum">     372 </span>                : 
<span class="lineNum">     373 </span><span class="lineCov">            243 :         if (ARRAYG(compare_func)(&amp;result, first, second TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     374 </span><span class="lineNoCov">              0 :                 return 0;</span>
<span class="lineNum">     375 </span>                :         }
<span class="lineNum">     376 </span>                : 
<span class="lineNum">     377 </span><span class="lineCov">            243 :         if (Z_TYPE(result) == IS_DOUBLE) {</span>
<span class="lineNum">     378 </span><span class="lineNoCov">              0 :                 if (Z_DVAL(result) &lt; 0) {</span>
<span class="lineNum">     379 </span><span class="lineNoCov">              0 :                         return -1;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">              0 :                 } else if (Z_DVAL(result) &gt; 0) {</span>
<span class="lineNum">     381 </span><span class="lineNoCov">              0 :                         return 1;</span>
<span class="lineNum">     382 </span>                :                 } else {
<span class="lineNum">     383 </span><span class="lineNoCov">              0 :                         return 0;</span>
<span class="lineNum">     384 </span>                :                 }
<span class="lineNum">     385 </span>                :         }
<span class="lineNum">     386 </span>                : 
<span class="lineNum">     387 </span><span class="lineCov">            243 :         convert_to_long(&amp;result);</span>
<span class="lineNum">     388 </span>                : 
<span class="lineNum">     389 </span><span class="lineCov">            243 :         if (Z_LVAL(result) &lt; 0) {</span>
<span class="lineNum">     390 </span><span class="lineCov">            116 :                 return -1;</span>
<span class="lineNum">     391 </span><span class="lineCov">            127 :         } else if (Z_LVAL(result) &gt; 0) {</span>
<span class="lineNum">     392 </span><span class="lineCov">            127 :                 return 1;</span>
<span class="lineNum">     393 </span>                :         }
<span class="lineNum">     394 </span>                : 
<span class="lineNum">     395 </span><span class="lineNoCov">              0 :         return 0;</span>
<span class="lineNum">     396 </span>                : }
<a name="397"><span class="lineNum">     397 </span>                : /* }}} */</a>
<span class="lineNum">     398 </span>                : 
<span class="lineNum">     399 </span><span class="lineNoCov">              0 : static int php_array_reverse_data_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     400 </span>                : {
<span class="lineNum">     401 </span><span class="lineNoCov">              0 :         return php_array_data_compare(a, b TSRMLS_CC) * -1;</span>
<span class="lineNum">     402 </span>                : }
<a name="403"><span class="lineNum">     403 </span>                : /* }}} */</a>
<span class="lineNum">     404 </span>                : 
<span class="lineNum">     405 </span><span class="lineNoCov">              0 : static int php_array_natural_general_compare(const void *a, const void *b, int fold_case) /* {{{ */</span>
<span class="lineNum">     406 </span>                : {
<span class="lineNum">     407 </span>                :         Bucket *f, *s;
<span class="lineNum">     408 </span>                :         zval *fval, *sval;
<span class="lineNum">     409 </span>                :         zval first, second;
<span class="lineNum">     410 </span>                :         int result;
<span class="lineNum">     411 </span>                : 
<span class="lineNum">     412 </span><span class="lineNoCov">              0 :         f = *((Bucket **) a);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">              0 :         s = *((Bucket **) b);</span>
<span class="lineNum">     414 </span>                : 
<span class="lineNum">     415 </span><span class="lineNoCov">              0 :         fval = *((zval **) f-&gt;pData);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">              0 :         sval = *((zval **) s-&gt;pData);</span>
<span class="lineNum">     417 </span><span class="lineNoCov">              0 :         first = *fval;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">              0 :         second = *sval;</span>
<span class="lineNum">     419 </span>                : 
<span class="lineNum">     420 </span><span class="lineNoCov">              0 :         if (Z_TYPE_P(fval) != IS_STRING) {</span>
<span class="lineNum">     421 </span>                :                 zval_copy_ctor(&amp;first);
<span class="lineNum">     422 </span><span class="lineNoCov">              0 :                 convert_to_string(&amp;first);</span>
<span class="lineNum">     423 </span>                :         }
<span class="lineNum">     424 </span>                : 
<span class="lineNum">     425 </span><span class="lineNoCov">              0 :         if (Z_TYPE_P(sval) != IS_STRING) {</span>
<span class="lineNum">     426 </span>                :                 zval_copy_ctor(&amp;second);
<span class="lineNum">     427 </span><span class="lineNoCov">              0 :                 convert_to_string(&amp;second);</span>
<span class="lineNum">     428 </span>                :         }
<span class="lineNum">     429 </span>                : 
<span class="lineNum">     430 </span><span class="lineNoCov">              0 :         result = strnatcmp_ex(Z_STRVAL(first), Z_STRLEN(first), Z_STRVAL(second), Z_STRLEN(second), fold_case);</span>
<span class="lineNum">     431 </span>                : 
<span class="lineNum">     432 </span><span class="lineNoCov">              0 :         if (Z_TYPE_P(fval) != IS_STRING) {</span>
<span class="lineNum">     433 </span>                :                 zval_dtor(&amp;first);
<span class="lineNum">     434 </span>                :         }
<span class="lineNum">     435 </span>                : 
<span class="lineNum">     436 </span><span class="lineNoCov">              0 :         if (Z_TYPE_P(sval) != IS_STRING) {</span>
<span class="lineNum">     437 </span>                :                 zval_dtor(&amp;second);
<span class="lineNum">     438 </span>                :         }
<span class="lineNum">     439 </span>                : 
<span class="lineNum">     440 </span><span class="lineNoCov">              0 :         return result;</span>
<span class="lineNum">     441 </span>                : }
<a name="442"><span class="lineNum">     442 </span>                : /* }}} */</a>
<span class="lineNum">     443 </span>                : 
<span class="lineNum">     444 </span><span class="lineNoCov">              0 : static int php_array_natural_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     445 </span>                : {
<span class="lineNum">     446 </span><span class="lineNoCov">              0 :         return php_array_natural_general_compare(a, b, 0);</span>
<span class="lineNum">     447 </span>                : }
<a name="448"><span class="lineNum">     448 </span>                : /* }}} */</a>
<span class="lineNum">     449 </span>                : 
<span class="lineNum">     450 </span><span class="lineNoCov">              0 : static int php_array_natural_case_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     451 </span>                : {
<span class="lineNum">     452 </span><span class="lineNoCov">              0 :         return php_array_natural_general_compare(a, b, 1);</span>
<span class="lineNum">     453 </span>                : }
<a name="454"><span class="lineNum">     454 </span>                : /* }}} */</a>
<span class="lineNum">     455 </span>                : 
<span class="lineNum">     456 </span><span class="lineNoCov">              0 : static void php_natsort(INTERNAL_FUNCTION_PARAMETERS, int fold_case) /* {{{ */</span>
<span class="lineNum">     457 </span>                : {
<span class="lineNum">     458 </span>                :         zval *array;
<span class="lineNum">     459 </span>                : 
<span class="lineNum">     460 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">     461 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     462 </span>                :         }
<span class="lineNum">     463 </span>                : 
<span class="lineNum">     464 </span><span class="lineNoCov">              0 :         if (fold_case) {</span>
<span class="lineNum">     465 </span><span class="lineNoCov">              0 :                 if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_natural_case_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     466 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">     467 </span>                :                 }
<span class="lineNum">     468 </span>                :         } else {
<span class="lineNum">     469 </span><span class="lineNoCov">              0 :                 if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_natural_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     470 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">     471 </span>                :                 }
<span class="lineNum">     472 </span>                :         }
<span class="lineNum">     473 </span>                : 
<span class="lineNum">     474 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">     475 </span>                : }
<span class="lineNum">     476 </span>                : /* }}} */
<span class="lineNum">     477 </span>                : 
<a name="478"><span class="lineNum">     478 </span>                : /* {{{ proto void natsort(array &amp;array_arg)</a>
<span class="lineNum">     479 </span>                :    Sort an array using natural sort */
<span class="lineNum">     480 </span><span class="lineNoCov">              0 : PHP_FUNCTION(natsort)</span>
<span class="lineNum">     481 </span>                : {
<span class="lineNum">     482 </span><span class="lineNoCov">              0 :         php_natsort(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0);</span>
<span class="lineNum">     483 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">     484 </span>                : /* }}} */
<span class="lineNum">     485 </span>                : 
<a name="486"><span class="lineNum">     486 </span>                : /* {{{ proto void natcasesort(array &amp;array_arg)</a>
<span class="lineNum">     487 </span>                :    Sort an array using case-insensitive natural sort */
<span class="lineNum">     488 </span><span class="lineNoCov">              0 : PHP_FUNCTION(natcasesort)</span>
<span class="lineNum">     489 </span>                : {
<span class="lineNum">     490 </span><span class="lineNoCov">              0 :         php_natsort(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1);</span>
<span class="lineNum">     491 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">     492 </span>                : /* }}} */
<span class="lineNum">     493 </span>                : 
<a name="494"><span class="lineNum">     494 </span>                : /* {{{ proto bool asort(array &amp;array_arg [, int sort_flags])</a>
<span class="lineNum">     495 </span>                :    Sort an array and maintain index association */
<span class="lineNum">     496 </span><span class="lineNoCov">              0 : PHP_FUNCTION(asort)</span>
<span class="lineNum">     497 </span>                : {
<span class="lineNum">     498 </span>                :         zval *array;
<span class="lineNum">     499 </span><span class="lineNoCov">              0 :         long sort_type = PHP_SORT_REGULAR;</span>
<span class="lineNum">     500 </span>                : 
<span class="lineNum">     501 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;sort_type) == FAILURE) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     503 </span>                :         }
<span class="lineNum">     504 </span>                : 
<span class="lineNum">     505 </span><span class="lineNoCov">              0 :         php_set_compare_func(sort_type TSRMLS_CC);</span>
<span class="lineNum">     506 </span>                : 
<span class="lineNum">     507 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_data_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     508 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     509 </span>                :         }
<span class="lineNum">     510 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">     511 </span>                : }
<span class="lineNum">     512 </span>                : /* }}} */
<span class="lineNum">     513 </span>                : 
<a name="514"><span class="lineNum">     514 </span>                : /* {{{ proto bool arsort(array &amp;array_arg [, int sort_flags])</a>
<span class="lineNum">     515 </span>                :    Sort an array in reverse order and maintain index association */
<span class="lineNum">     516 </span><span class="lineNoCov">              0 : PHP_FUNCTION(arsort)</span>
<span class="lineNum">     517 </span>                : {
<span class="lineNum">     518 </span>                :         zval *array;
<span class="lineNum">     519 </span><span class="lineNoCov">              0 :         long sort_type = PHP_SORT_REGULAR;</span>
<span class="lineNum">     520 </span>                : 
<span class="lineNum">     521 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;sort_type) == FAILURE) {</span>
<span class="lineNum">     522 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     523 </span>                :         }
<span class="lineNum">     524 </span>                : 
<span class="lineNum">     525 </span><span class="lineNoCov">              0 :         php_set_compare_func(sort_type TSRMLS_CC);</span>
<span class="lineNum">     526 </span>                : 
<span class="lineNum">     527 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_reverse_data_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     528 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     529 </span>                :         }
<span class="lineNum">     530 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">     531 </span>                : }
<span class="lineNum">     532 </span>                : /* }}} */
<span class="lineNum">     533 </span>                : 
<a name="534"><span class="lineNum">     534 </span>                : /* {{{ proto bool sort(array &amp;array_arg [, int sort_flags])</a>
<span class="lineNum">     535 </span>                :    Sort an array */
<span class="lineNum">     536 </span><span class="lineNoCov">              0 : PHP_FUNCTION(sort)</span>
<span class="lineNum">     537 </span>                : {
<span class="lineNum">     538 </span>                :         zval *array;
<span class="lineNum">     539 </span><span class="lineNoCov">              0 :         long sort_type = PHP_SORT_REGULAR;</span>
<span class="lineNum">     540 </span>                : 
<span class="lineNum">     541 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;sort_type) == FAILURE) {</span>
<span class="lineNum">     542 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     543 </span>                :         }
<span class="lineNum">     544 </span>                : 
<span class="lineNum">     545 </span><span class="lineNoCov">              0 :         php_set_compare_func(sort_type TSRMLS_CC);</span>
<span class="lineNum">     546 </span>                : 
<span class="lineNum">     547 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_data_compare, 1 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     548 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     549 </span>                :         }
<span class="lineNum">     550 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">     551 </span>                : }
<span class="lineNum">     552 </span>                : /* }}} */
<span class="lineNum">     553 </span>                : 
<a name="554"><span class="lineNum">     554 </span>                : /* {{{ proto bool rsort(array &amp;array_arg [, int sort_flags])</a>
<span class="lineNum">     555 </span>                :    Sort an array in reverse order */
<span class="lineNum">     556 </span><span class="lineNoCov">              0 : PHP_FUNCTION(rsort)</span>
<span class="lineNum">     557 </span>                : {
<span class="lineNum">     558 </span>                :         zval *array;
<span class="lineNum">     559 </span><span class="lineNoCov">              0 :         long sort_type = PHP_SORT_REGULAR;</span>
<span class="lineNum">     560 </span>                : 
<span class="lineNum">     561 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;sort_type) == FAILURE) {</span>
<span class="lineNum">     562 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     563 </span>                :         }
<span class="lineNum">     564 </span>                : 
<span class="lineNum">     565 </span><span class="lineNoCov">              0 :         php_set_compare_func(sort_type TSRMLS_CC);</span>
<span class="lineNum">     566 </span>                : 
<span class="lineNum">     567 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_reverse_data_compare, 1 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     568 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     569 </span>                :         }
<span class="lineNum">     570 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">     571 </span>                : }
<a name="572"><span class="lineNum">     572 </span>                : /* }}} */</a>
<span class="lineNum">     573 </span>                : 
<span class="lineNum">     574 </span><span class="lineCov">            202 : static int php_array_user_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     575 </span>                : {
<span class="lineNum">     576 </span>                :         Bucket *f;
<span class="lineNum">     577 </span>                :         Bucket *s;
<span class="lineNum">     578 </span>                :         zval **args[2];
<span class="lineNum">     579 </span><span class="lineCov">            202 :         zval *retval_ptr = NULL;</span>
<span class="lineNum">     580 </span>                : 
<span class="lineNum">     581 </span><span class="lineCov">            202 :         f = *((Bucket **) a);</span>
<span class="lineNum">     582 </span><span class="lineCov">            202 :         s = *((Bucket **) b);</span>
<span class="lineNum">     583 </span>                : 
<span class="lineNum">     584 </span><span class="lineCov">            202 :         args[0] = (zval **) f-&gt;pData;</span>
<span class="lineNum">     585 </span><span class="lineCov">            202 :         args[1] = (zval **) s-&gt;pData;</span>
<span class="lineNum">     586 </span>                : 
<span class="lineNum">     587 </span><span class="lineCov">            202 :         BG(user_compare_fci).param_count = 2;</span>
<span class="lineNum">     588 </span><span class="lineCov">            202 :         BG(user_compare_fci).params = args;</span>
<span class="lineNum">     589 </span><span class="lineCov">            202 :         BG(user_compare_fci).retval_ptr_ptr = &amp;retval_ptr;</span>
<span class="lineNum">     590 </span><span class="lineCov">            202 :         BG(user_compare_fci).no_separation = 0;</span>
<span class="lineNum">     591 </span><span class="lineCov">            202 :         if (zend_call_function(&amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache) TSRMLS_CC) == SUCCESS &amp;&amp; retval_ptr) {</span>
<span class="lineNum">     592 </span>                :                 long retval;
<span class="lineNum">     593 </span>                : 
<span class="lineNum">     594 </span><span class="lineCov">            202 :                 convert_to_long_ex(&amp;retval_ptr);</span>
<span class="lineNum">     595 </span><span class="lineCov">            202 :                 retval = Z_LVAL_P(retval_ptr);</span>
<span class="lineNum">     596 </span><span class="lineCov">            202 :                 zval_ptr_dtor(&amp;retval_ptr);</span>
<span class="lineNum">     597 </span><span class="lineCov">            202 :                 return retval &lt; 0 ? -1 : retval &gt; 0 ? 1 : 0;</span>
<span class="lineNum">     598 </span>                :         } else {
<span class="lineNum">     599 </span><span class="lineNoCov">              0 :                 return 0;</span>
<span class="lineNum">     600 </span>                :         }
<span class="lineNum">     601 </span>                : }
<span class="lineNum">     602 </span>                : /* }}} */
<span class="lineNum">     603 </span>                : 
<span class="lineNum">     604 </span>                : /* check if comparison function is valid */
<span class="lineNum">     605 </span>                : #define PHP_ARRAY_CMP_FUNC_CHECK(func_name)     \
<span class="lineNum">     606 </span>                :         if (!zend_is_callable(*func_name, 0, NULL TSRMLS_CC)) { \
<span class="lineNum">     607 </span>                :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Invalid comparison function&quot;);   \
<span class="lineNum">     608 </span>                :                 BG(user_compare_fci) = old_user_compare_fci; \
<span class="lineNum">     609 </span>                :                 BG(user_compare_fci_cache) = old_user_compare_fci_cache; \
<span class="lineNum">     610 </span>                :                 RETURN_FALSE;   \
<span class="lineNum">     611 </span>                :         }       \
<span class="lineNum">     612 </span>                : 
<span class="lineNum">     613 </span>                :         /* Clear FCI cache otherwise : for example the same or other array with
<span class="lineNum">     614 </span>                :          * (partly) the same key values has been sorted with uasort() or
<span class="lineNum">     615 </span>                :          * other sorting function the comparison is cached, however the name
<span class="lineNum">     616 </span>                :          * of the function for comparison is not respected. see bug #28739 AND #33295
<span class="lineNum">     617 </span>                :          *
<span class="lineNum">     618 </span>                :          * Following defines will assist in backup / restore values. */
<span class="lineNum">     619 </span>                : 
<span class="lineNum">     620 </span>                : #define PHP_ARRAY_CMP_FUNC_VARS \
<span class="lineNum">     621 </span>                :         zend_fcall_info old_user_compare_fci; \
<span class="lineNum">     622 </span>                :         zend_fcall_info_cache old_user_compare_fci_cache \
<span class="lineNum">     623 </span>                : 
<span class="lineNum">     624 </span>                : #define PHP_ARRAY_CMP_FUNC_BACKUP() \
<span class="lineNum">     625 </span>                :         old_user_compare_fci = BG(user_compare_fci); \
<span class="lineNum">     626 </span>                :         old_user_compare_fci_cache = BG(user_compare_fci_cache); \
<span class="lineNum">     627 </span>                :         BG(user_compare_fci_cache) = empty_fcall_info_cache; \
<span class="lineNum">     628 </span>                : 
<span class="lineNum">     629 </span>                : #define PHP_ARRAY_CMP_FUNC_RESTORE() \
<span class="lineNum">     630 </span>                :         BG(user_compare_fci) = old_user_compare_fci; \
<span class="lineNum">     631 </span>                :         BG(user_compare_fci_cache) = old_user_compare_fci_cache; \
<span class="lineNum">     632 </span>                : 
<a name="633"><span class="lineNum">     633 </span>                : /* {{{ proto bool usort(array array_arg, string cmp_function)</a>
<span class="lineNum">     634 </span>                :    Sort an array by values using a user-defined comparison function */
<span class="lineNum">     635 </span><span class="lineCov">              1 : PHP_FUNCTION(usort)</span>
<span class="lineNum">     636 </span>                : {
<span class="lineNum">     637 </span>                :         zval *array;
<span class="lineNum">     638 </span>                :         unsigned int refcount;
<span class="lineNum">     639 </span>                :         PHP_ARRAY_CMP_FUNC_VARS;
<span class="lineNum">     640 </span>                : 
<span class="lineNum">     641 </span><span class="lineCov">              1 :         PHP_ARRAY_CMP_FUNC_BACKUP();</span>
<span class="lineNum">     642 </span>                : 
<span class="lineNum">     643 </span><span class="lineCov">              1 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;af&quot;, &amp;array, &amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache)) == FAILURE) {</span>
<span class="lineNum">     644 </span><span class="lineNoCov">              0 :                 PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">     645 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     646 </span>                :         }
<span class="lineNum">     647 </span>                : 
<span class="lineNum">     648 </span>                :         /* Clear the is_ref flag, so the attemts to modify the array in user
<span class="lineNum">     649 </span>                :          * comparison function will create a copy of array and won't affect the
<span class="lineNum">     650 </span>                :          * original array. The fact of modification is detected using refcount
<span class="lineNum">     651 </span>                :          * comparison. The result of sorting in such case is undefined and the
<span class="lineNum">     652 </span>                :          * function returns FALSE.
<span class="lineNum">     653 </span>                :          */
<span class="lineNum">     654 </span><span class="lineCov">              1 :         Z_UNSET_ISREF_P(array);</span>
<span class="lineNum">     655 </span><span class="lineCov">              2 :         refcount = Z_REFCOUNT_P(array);</span>
<span class="lineNum">     656 </span>                : 
<span class="lineNum">     657 </span><span class="lineCov">              1 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_user_compare, 1 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     658 </span><span class="lineNoCov">              0 :                 RETVAL_FALSE;</span>
<span class="lineNum">     659 </span>                :         } else {
<span class="lineNum">     660 </span><span class="lineCov">              2 :                 if (refcount &gt; Z_REFCOUNT_P(array)) {</span>
<span class="lineNum">     661 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Array was modified by the user comparison function&quot;);</span>
<span class="lineNum">     662 </span><span class="lineNoCov">              0 :                         RETVAL_FALSE;</span>
<span class="lineNum">     663 </span>                :                 } else {
<span class="lineNum">     664 </span><span class="lineCov">              1 :                         RETVAL_TRUE;</span>
<span class="lineNum">     665 </span>                :                 }
<span class="lineNum">     666 </span>                :         }
<span class="lineNum">     667 </span>                :         
<span class="lineNum">     668 </span><span class="lineCov">              2 :         if (Z_REFCOUNT_P(array) &gt; 1) {</span>
<span class="lineNum">     669 </span><span class="lineCov">              1 :                 Z_SET_ISREF_P(array);</span>
<span class="lineNum">     670 </span>                :         }
<span class="lineNum">     671 </span>                : 
<span class="lineNum">     672 </span><span class="lineCov">              1 :         PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">     673 </span>                : }
<span class="lineNum">     674 </span>                : /* }}} */
<span class="lineNum">     675 </span>                : 
<a name="676"><span class="lineNum">     676 </span>                : /* {{{ proto bool uasort(array array_arg, string cmp_function)</a>
<span class="lineNum">     677 </span>                :    Sort an array with a user-defined comparison function and maintain index association */
<span class="lineNum">     678 </span><span class="lineNoCov">              0 : PHP_FUNCTION(uasort)</span>
<span class="lineNum">     679 </span>                : {
<span class="lineNum">     680 </span>                :         zval *array;
<span class="lineNum">     681 </span>                :         unsigned int refcount;
<span class="lineNum">     682 </span>                :         PHP_ARRAY_CMP_FUNC_VARS;
<span class="lineNum">     683 </span>                : 
<span class="lineNum">     684 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_BACKUP();</span>
<span class="lineNum">     685 </span>                : 
<span class="lineNum">     686 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;af&quot;, &amp;array, &amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache)) == FAILURE) {</span>
<span class="lineNum">     687 </span><span class="lineNoCov">              0 :                 PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">     688 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     689 </span>                :         }
<span class="lineNum">     690 </span>                : 
<span class="lineNum">     691 </span>                :         /* Clear the is_ref flag, so the attemts to modify the array in user
<span class="lineNum">     692 </span>                :          * comaprison function will create a copy of array and won't affect the
<span class="lineNum">     693 </span>                :          * original array. The fact of modification is detected using refcount
<span class="lineNum">     694 </span>                :          * comparison. The result of sorting in such case is undefined and the
<span class="lineNum">     695 </span>                :          * function returns FALSE.
<span class="lineNum">     696 </span>                :          */
<span class="lineNum">     697 </span><span class="lineNoCov">              0 :         Z_UNSET_ISREF_P(array);</span>
<span class="lineNum">     698 </span><span class="lineNoCov">              0 :         refcount = Z_REFCOUNT_P(array);</span>
<span class="lineNum">     699 </span>                : 
<span class="lineNum">     700 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_user_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     701 </span><span class="lineNoCov">              0 :                 RETVAL_FALSE;</span>
<span class="lineNum">     702 </span>                :         } else {
<span class="lineNum">     703 </span><span class="lineNoCov">              0 :                 if (refcount &gt; Z_REFCOUNT_P(array)) {</span>
<span class="lineNum">     704 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Array was modified by the user comparison function&quot;);</span>
<span class="lineNum">     705 </span><span class="lineNoCov">              0 :                         RETVAL_FALSE;</span>
<span class="lineNum">     706 </span>                :                 } else {
<span class="lineNum">     707 </span><span class="lineNoCov">              0 :                         RETVAL_TRUE;</span>
<span class="lineNum">     708 </span>                :                 }
<span class="lineNum">     709 </span>                :         }
<span class="lineNum">     710 </span>                : 
<span class="lineNum">     711 </span><span class="lineNoCov">              0 :         if (Z_REFCOUNT_P(array) &gt; 1) {</span>
<span class="lineNum">     712 </span><span class="lineNoCov">              0 :                 Z_SET_ISREF_P(array);</span>
<span class="lineNum">     713 </span>                :         }
<span class="lineNum">     714 </span>                : 
<span class="lineNum">     715 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">     716 </span>                : }
<a name="717"><span class="lineNum">     717 </span>                : /* }}} */</a>
<span class="lineNum">     718 </span>                : 
<span class="lineNum">     719 </span><span class="lineNoCov">              0 : static int php_array_user_key_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">     720 </span>                : {
<span class="lineNum">     721 </span>                :         Bucket *f;
<span class="lineNum">     722 </span>                :         Bucket *s;
<span class="lineNum">     723 </span>                :         zval *key1, *key2;
<span class="lineNum">     724 </span>                :         zval **args[2];
<span class="lineNum">     725 </span><span class="lineNoCov">              0 :         zval *retval_ptr = NULL;</span>
<span class="lineNum">     726 </span>                :         long result;
<span class="lineNum">     727 </span>                : 
<span class="lineNum">     728 </span><span class="lineNoCov">              0 :         ALLOC_INIT_ZVAL(key1);</span>
<span class="lineNum">     729 </span><span class="lineNoCov">              0 :         ALLOC_INIT_ZVAL(key2);</span>
<span class="lineNum">     730 </span><span class="lineNoCov">              0 :         args[0] = &amp;key1;</span>
<span class="lineNum">     731 </span><span class="lineNoCov">              0 :         args[1] = &amp;key2;</span>
<span class="lineNum">     732 </span>                : 
<span class="lineNum">     733 </span><span class="lineNoCov">              0 :         f = *((Bucket **) a);</span>
<span class="lineNum">     734 </span><span class="lineNoCov">              0 :         s = *((Bucket **) b);</span>
<span class="lineNum">     735 </span>                : 
<span class="lineNum">     736 </span><span class="lineNoCov">              0 :         if (f-&gt;nKeyLength == 0) {</span>
<span class="lineNum">     737 </span><span class="lineNoCov">              0 :                 Z_LVAL_P(key1) = f-&gt;h;</span>
<span class="lineNum">     738 </span><span class="lineNoCov">              0 :                 Z_TYPE_P(key1) = IS_LONG;</span>
<span class="lineNum">     739 </span>                :         } else {
<span class="lineNum">     740 </span><span class="lineNoCov">              0 :                 Z_STRVAL_P(key1) = estrndup(f-&gt;arKey, f-&gt;nKeyLength - 1);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">              0 :                 Z_STRLEN_P(key1) = f-&gt;nKeyLength - 1;</span>
<span class="lineNum">     742 </span><span class="lineNoCov">              0 :                 Z_TYPE_P(key1) = IS_STRING;</span>
<span class="lineNum">     743 </span>                :         }
<span class="lineNum">     744 </span><span class="lineNoCov">              0 :         if (s-&gt;nKeyLength == 0) {</span>
<span class="lineNum">     745 </span><span class="lineNoCov">              0 :                 Z_LVAL_P(key2) = s-&gt;h;</span>
<span class="lineNum">     746 </span><span class="lineNoCov">              0 :                 Z_TYPE_P(key2) = IS_LONG;</span>
<span class="lineNum">     747 </span>                :         } else {
<span class="lineNum">     748 </span><span class="lineNoCov">              0 :                 Z_STRVAL_P(key2) = estrndup(s-&gt;arKey, s-&gt;nKeyLength - 1);</span>
<span class="lineNum">     749 </span><span class="lineNoCov">              0 :                 Z_STRLEN_P(key2) = s-&gt;nKeyLength - 1;</span>
<span class="lineNum">     750 </span><span class="lineNoCov">              0 :                 Z_TYPE_P(key2) = IS_STRING;</span>
<span class="lineNum">     751 </span>                :         }
<span class="lineNum">     752 </span>                : 
<span class="lineNum">     753 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).param_count = 2;</span>
<span class="lineNum">     754 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).params = args;</span>
<span class="lineNum">     755 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).retval_ptr_ptr = &amp;retval_ptr;</span>
<span class="lineNum">     756 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).no_separation = 0;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">              0 :         if (zend_call_function(&amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache) TSRMLS_CC) == SUCCESS &amp;&amp; retval_ptr) {</span>
<span class="lineNum">     758 </span><span class="lineNoCov">              0 :                 convert_to_long_ex(&amp;retval_ptr);</span>
<span class="lineNum">     759 </span><span class="lineNoCov">              0 :                 result = Z_LVAL_P(retval_ptr);</span>
<span class="lineNum">     760 </span><span class="lineNoCov">              0 :                 zval_ptr_dtor(&amp;retval_ptr);</span>
<span class="lineNum">     761 </span>                :         } else {
<span class="lineNum">     762 </span><span class="lineNoCov">              0 :                 result = 0;</span>
<span class="lineNum">     763 </span>                :         }
<span class="lineNum">     764 </span>                : 
<span class="lineNum">     765 </span><span class="lineNoCov">              0 :         zval_ptr_dtor(&amp;key1);</span>
<span class="lineNum">     766 </span><span class="lineNoCov">              0 :         zval_ptr_dtor(&amp;key2);</span>
<span class="lineNum">     767 </span>                : 
<span class="lineNum">     768 </span><span class="lineNoCov">              0 :         return result;</span>
<span class="lineNum">     769 </span>                : }
<span class="lineNum">     770 </span>                : /* }}} */
<span class="lineNum">     771 </span>                : 
<a name="772"><span class="lineNum">     772 </span>                : /* {{{ proto bool uksort(array array_arg, string cmp_function)</a>
<span class="lineNum">     773 </span>                :    Sort an array by keys using a user-defined comparison function */
<span class="lineNum">     774 </span><span class="lineNoCov">              0 : PHP_FUNCTION(uksort)</span>
<span class="lineNum">     775 </span>                : {
<span class="lineNum">     776 </span>                :         zval *array;
<span class="lineNum">     777 </span>                :         unsigned int refcount;
<span class="lineNum">     778 </span>                :         PHP_ARRAY_CMP_FUNC_VARS;
<span class="lineNum">     779 </span>                : 
<span class="lineNum">     780 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_BACKUP();</span>
<span class="lineNum">     781 </span>                : 
<span class="lineNum">     782 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;af&quot;, &amp;array, &amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache)) == FAILURE) {</span>
<span class="lineNum">     783 </span><span class="lineNoCov">              0 :                 PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">     784 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     785 </span>                :         }
<span class="lineNum">     786 </span>                : 
<span class="lineNum">     787 </span>                :         /* Clear the is_ref flag, so the attemts to modify the array in user
<span class="lineNum">     788 </span>                :          * comaprison function will create a copy of array and won't affect the
<span class="lineNum">     789 </span>                :          * original array. The fact of modification is detected using refcount
<span class="lineNum">     790 </span>                :          * comparison. The result of sorting in such case is undefined and the
<span class="lineNum">     791 </span>                :          * function returns FALSE.
<span class="lineNum">     792 </span>                :          */
<span class="lineNum">     793 </span><span class="lineNoCov">              0 :         Z_UNSET_ISREF_P(array);</span>
<span class="lineNum">     794 </span><span class="lineNoCov">              0 :         refcount = Z_REFCOUNT_P(array);</span>
<span class="lineNum">     795 </span>                : 
<span class="lineNum">     796 </span><span class="lineNoCov">              0 :         if (zend_hash_sort(Z_ARRVAL_P(array), zend_qsort, php_array_user_key_compare, 0 TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">     797 </span><span class="lineNoCov">              0 :                 RETVAL_FALSE;</span>
<span class="lineNum">     798 </span>                :         } else {
<span class="lineNum">     799 </span><span class="lineNoCov">              0 :                 if (refcount &gt; Z_REFCOUNT_P(array)) {</span>
<span class="lineNum">     800 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Array was modified by the user comparison function&quot;);</span>
<span class="lineNum">     801 </span><span class="lineNoCov">              0 :                         RETVAL_FALSE;</span>
<span class="lineNum">     802 </span>                :                 } else {
<span class="lineNum">     803 </span><span class="lineNoCov">              0 :                         RETVAL_TRUE;</span>
<span class="lineNum">     804 </span>                :                 }
<span class="lineNum">     805 </span>                :         }
<span class="lineNum">     806 </span>                : 
<span class="lineNum">     807 </span><span class="lineNoCov">              0 :         if (Z_REFCOUNT_P(array) &gt; 1) {</span>
<span class="lineNum">     808 </span><span class="lineNoCov">              0 :                 Z_SET_ISREF_P(array);</span>
<span class="lineNum">     809 </span>                :         }
<span class="lineNum">     810 </span>                : 
<span class="lineNum">     811 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">     812 </span>                : }
<span class="lineNum">     813 </span>                : /* }}} */
<span class="lineNum">     814 </span>                : 
<a name="815"><span class="lineNum">     815 </span>                : /* {{{ proto mixed end(array array_arg)</a>
<span class="lineNum">     816 </span>                :    Advances array argument's internal pointer to the last element and return it */
<span class="lineNum">     817 </span><span class="lineNoCov">              0 : PHP_FUNCTION(end)</span>
<span class="lineNum">     818 </span>                : {
<span class="lineNum">     819 </span>                :         HashTable *array;
<span class="lineNum">     820 </span>                :         zval **entry;
<span class="lineNum">     821 </span>                : 
<span class="lineNum">     822 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;H&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">     823 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     824 </span>                :         }
<span class="lineNum">     825 </span>                : 
<span class="lineNum">     826 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_end(array);</span>
<span class="lineNum">     827 </span>                : 
<span class="lineNum">     828 </span><span class="lineNoCov">              0 :         if (return_value_used) {</span>
<span class="lineNum">     829 </span><span class="lineNoCov">              0 :                 if (zend_hash_get_current_data(array, (void **) &amp;entry) == FAILURE) {</span>
<span class="lineNum">     830 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">     831 </span>                :                 }
<span class="lineNum">     832 </span>                : 
<span class="lineNum">     833 </span><span class="lineNoCov">              0 :                 RETURN_ZVAL(*entry, 1, 0);</span>
<span class="lineNum">     834 </span>                :         }
<span class="lineNum">     835 </span>                : }
<span class="lineNum">     836 </span>                : /* }}} */
<span class="lineNum">     837 </span>                : 
<a name="838"><span class="lineNum">     838 </span>                : /* {{{ proto mixed prev(array array_arg)</a>
<span class="lineNum">     839 </span>                :    Move array argument's internal pointer to the previous element and return it */
<span class="lineNum">     840 </span><span class="lineNoCov">              0 : PHP_FUNCTION(prev)</span>
<span class="lineNum">     841 </span>                : {
<span class="lineNum">     842 </span>                :         HashTable *array;
<span class="lineNum">     843 </span>                :         zval **entry;
<span class="lineNum">     844 </span>                : 
<span class="lineNum">     845 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;H&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">     846 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     847 </span>                :         }
<span class="lineNum">     848 </span>                : 
<span class="lineNum">     849 </span><span class="lineNoCov">              0 :         zend_hash_move_backwards(array);</span>
<span class="lineNum">     850 </span>                : 
<span class="lineNum">     851 </span><span class="lineNoCov">              0 :         if (return_value_used) {</span>
<span class="lineNum">     852 </span><span class="lineNoCov">              0 :                 if (zend_hash_get_current_data(array, (void **) &amp;entry) == FAILURE) {</span>
<span class="lineNum">     853 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">     854 </span>                :                 }
<span class="lineNum">     855 </span>                : 
<span class="lineNum">     856 </span><span class="lineNoCov">              0 :                 RETURN_ZVAL(*entry, 1, 0);</span>
<span class="lineNum">     857 </span>                :         }
<span class="lineNum">     858 </span>                : }
<span class="lineNum">     859 </span>                : /* }}} */
<span class="lineNum">     860 </span>                : 
<a name="861"><span class="lineNum">     861 </span>                : /* {{{ proto mixed next(array array_arg)</a>
<span class="lineNum">     862 </span>                :    Move array argument's internal pointer to the next element and return it */
<span class="lineNum">     863 </span><span class="lineCov">             65 : PHP_FUNCTION(next)</span>
<span class="lineNum">     864 </span>                : {
<span class="lineNum">     865 </span>                :         HashTable *array;
<span class="lineNum">     866 </span>                :         zval **entry;
<span class="lineNum">     867 </span>                : 
<span class="lineNum">     868 </span><span class="lineCov">             65 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;H&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">     869 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     870 </span>                :         }
<span class="lineNum">     871 </span>                : 
<span class="lineNum">     872 </span><span class="lineCov">             65 :         zend_hash_move_forward(array);</span>
<span class="lineNum">     873 </span>                : 
<span class="lineNum">     874 </span><span class="lineCov">             65 :         if (return_value_used) {</span>
<span class="lineNum">     875 </span><span class="lineCov">             65 :                 if (zend_hash_get_current_data(array, (void **) &amp;entry) == FAILURE) {</span>
<span class="lineNum">     876 </span><span class="lineCov">             18 :                         RETURN_FALSE;</span>
<span class="lineNum">     877 </span>                :                 }
<span class="lineNum">     878 </span>                : 
<span class="lineNum">     879 </span><span class="lineCov">            188 :                 RETURN_ZVAL(*entry, 1, 0);</span>
<span class="lineNum">     880 </span>                :         }
<span class="lineNum">     881 </span>                : }
<span class="lineNum">     882 </span>                : /* }}} */
<span class="lineNum">     883 </span>                : 
<a name="884"><span class="lineNum">     884 </span>                : /* {{{ proto mixed reset(array array_arg)</a>
<span class="lineNum">     885 </span>                :    Set array argument's internal pointer to the first element and return it */
<span class="lineNum">     886 </span><span class="lineCov">             22 : PHP_FUNCTION(reset)</span>
<span class="lineNum">     887 </span>                : {
<span class="lineNum">     888 </span>                :         HashTable *array;
<span class="lineNum">     889 </span>                :         zval **entry;
<span class="lineNum">     890 </span>                : 
<span class="lineNum">     891 </span><span class="lineCov">             22 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;H&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">     892 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     893 </span>                :         }
<span class="lineNum">     894 </span>                : 
<span class="lineNum">     895 </span><span class="lineCov">             22 :         zend_hash_internal_pointer_reset(array);</span>
<span class="lineNum">     896 </span>                : 
<span class="lineNum">     897 </span><span class="lineCov">             22 :         if (return_value_used) {</span>
<span class="lineNum">     898 </span><span class="lineNoCov">              0 :                 if (zend_hash_get_current_data(array, (void **) &amp;entry) == FAILURE) {</span>
<span class="lineNum">     899 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">     900 </span>                :                 }
<span class="lineNum">     901 </span>                : 
<span class="lineNum">     902 </span><span class="lineNoCov">              0 :                 RETURN_ZVAL(*entry, 1, 0);</span>
<span class="lineNum">     903 </span>                :         }
<span class="lineNum">     904 </span>                : }
<span class="lineNum">     905 </span>                : /* }}} */
<span class="lineNum">     906 </span>                : 
<a name="907"><span class="lineNum">     907 </span>                : /* {{{ proto mixed current(array array_arg)</a>
<span class="lineNum">     908 </span>                :    Return the element currently pointed to by the internal array pointer */
<span class="lineNum">     909 </span><span class="lineCov">             65 : PHP_FUNCTION(current)</span>
<span class="lineNum">     910 </span>                : {
<span class="lineNum">     911 </span>                :         HashTable *array;
<span class="lineNum">     912 </span>                :         zval **entry;
<span class="lineNum">     913 </span>                : 
<span class="lineNum">     914 </span><span class="lineCov">             65 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;H&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">     915 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     916 </span>                :         }
<span class="lineNum">     917 </span>                : 
<span class="lineNum">     918 </span><span class="lineCov">             65 :         if (zend_hash_get_current_data(array, (void **) &amp;entry) == FAILURE) {</span>
<span class="lineNum">     919 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">     920 </span>                :         }
<span class="lineNum">     921 </span><span class="lineCov">            260 :         RETURN_ZVAL(*entry, 1, 0);</span>
<span class="lineNum">     922 </span>                : }
<span class="lineNum">     923 </span>                : /* }}} */
<span class="lineNum">     924 </span>                : 
<a name="925"><span class="lineNum">     925 </span>                : /* {{{ proto mixed key(array array_arg)</a>
<span class="lineNum">     926 </span>                :    Return the key of the element currently pointed to by the internal array pointer */
<span class="lineNum">     927 </span><span class="lineCov">             69 : PHP_FUNCTION(key)</span>
<span class="lineNum">     928 </span>                : {
<span class="lineNum">     929 </span>                :         HashTable *array;
<span class="lineNum">     930 </span>                :         char *string_key;
<span class="lineNum">     931 </span>                :         uint string_length;
<span class="lineNum">     932 </span>                :         ulong num_key;
<span class="lineNum">     933 </span>                : 
<span class="lineNum">     934 </span><span class="lineCov">             69 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;H&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">     935 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     936 </span>                :         }
<span class="lineNum">     937 </span>                : 
<span class="lineNum">     938 </span><span class="lineCov">             69 :         switch (zend_hash_get_current_key_ex(array, &amp;string_key, &amp;string_length, &amp;num_key, 0, NULL)) {</span>
<span class="lineNum">     939 </span>                :                 case HASH_KEY_IS_STRING:
<span class="lineNum">     940 </span><span class="lineNoCov">              0 :                         RETVAL_STRINGL(string_key, string_length - 1, 1);</span>
<span class="lineNum">     941 </span><span class="lineNoCov">              0 :                         break;</span>
<span class="lineNum">     942 </span>                :                 case HASH_KEY_IS_LONG:
<span class="lineNum">     943 </span><span class="lineCov">             65 :                         RETVAL_LONG(num_key);</span>
<span class="lineNum">     944 </span><span class="lineCov">             65 :                         break;</span>
<span class="lineNum">     945 </span>                :                 case HASH_KEY_NON_EXISTANT:
<span class="lineNum">     946 </span><span class="lineCov">              4 :                         return;</span>
<span class="lineNum">     947 </span>                :         }
<span class="lineNum">     948 </span>                : }
<span class="lineNum">     949 </span>                : /* }}} */
<span class="lineNum">     950 </span>                : 
<a name="951"><span class="lineNum">     951 </span>                : /* {{{ proto mixed min(mixed arg1 [, mixed arg2 [, mixed ...]])</a>
<span class="lineNum">     952 </span>                :    Return the lowest value in an array or a series of arguments */
<span class="lineNum">     953 </span><span class="lineNoCov">              0 : PHP_FUNCTION(min)</span>
<span class="lineNum">     954 </span>                : {
<span class="lineNum">     955 </span>                :         int argc;
<span class="lineNum">     956 </span><span class="lineNoCov">              0 :         zval ***args = NULL;</span>
<span class="lineNum">     957 </span>                : 
<span class="lineNum">     958 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;+&quot;, &amp;args, &amp;argc) == FAILURE) {</span>
<span class="lineNum">     959 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">     960 </span>                :         }
<span class="lineNum">     961 </span>                :         
<span class="lineNum">     962 </span><span class="lineNoCov">              0 :         php_set_compare_func(PHP_SORT_REGULAR TSRMLS_CC);</span>
<span class="lineNum">     963 </span>                :         
<span class="lineNum">     964 </span>                :         /* mixed min ( array $values ) */
<span class="lineNum">     965 </span><span class="lineNoCov">              0 :         if (argc == 1) {</span>
<span class="lineNum">     966 </span>                :                 zval **result;
<span class="lineNum">     967 </span>                :                 
<span class="lineNum">     968 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(args[0]) != IS_ARRAY) {</span>
<span class="lineNum">     969 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;When only one parameter is given, it must be an array&quot;);</span>
<span class="lineNum">     970 </span><span class="lineNoCov">              0 :                         RETVAL_NULL();</span>
<span class="lineNum">     971 </span>                :                 } else {
<span class="lineNum">     972 </span><span class="lineNoCov">              0 :                         if (zend_hash_minmax(Z_ARRVAL_PP(args[0]), php_array_data_compare, 0, (void **) &amp;result TSRMLS_CC) == SUCCESS) {</span>
<span class="lineNum">     973 </span><span class="lineNoCov">              0 :                                 RETVAL_ZVAL(*result, 1, 0);</span>
<span class="lineNum">     974 </span>                :                         } else {
<span class="lineNum">     975 </span><span class="lineNoCov">              0 :                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Array must contain at least one element&quot;);</span>
<span class="lineNum">     976 </span><span class="lineNoCov">              0 :                                 RETVAL_FALSE;</span>
<span class="lineNum">     977 </span>                :                         }
<span class="lineNum">     978 </span>                :                 }
<span class="lineNum">     979 </span>                :         } else {
<span class="lineNum">     980 </span>                :                 /* mixed min ( mixed $value1 , mixed $value2 [, mixed $value3... ] ) */
<span class="lineNum">     981 </span>                :                 zval **min, result;
<span class="lineNum">     982 </span>                :                 int i;
<span class="lineNum">     983 </span>                : 
<span class="lineNum">     984 </span><span class="lineNoCov">              0 :                 min = args[0];</span>
<span class="lineNum">     985 </span>                : 
<span class="lineNum">     986 </span><span class="lineNoCov">              0 :                 for (i = 1; i &lt; argc; i++) {</span>
<span class="lineNum">     987 </span><span class="lineNoCov">              0 :                         is_smaller_function(&amp;result, *args[i], *min TSRMLS_CC);</span>
<span class="lineNum">     988 </span><span class="lineNoCov">              0 :                         if (Z_LVAL(result) == 1) {</span>
<span class="lineNum">     989 </span><span class="lineNoCov">              0 :                                 min = args[i];</span>
<span class="lineNum">     990 </span>                :                         }
<span class="lineNum">     991 </span>                :                 }
<span class="lineNum">     992 </span>                : 
<span class="lineNum">     993 </span><span class="lineNoCov">              0 :                 RETVAL_ZVAL(*min, 1, 0);        </span>
<span class="lineNum">     994 </span>                :         }
<span class="lineNum">     995 </span>                : 
<span class="lineNum">     996 </span><span class="lineNoCov">              0 :         if (args) {</span>
<span class="lineNum">     997 </span><span class="lineNoCov">              0 :                 efree(args);</span>
<span class="lineNum">     998 </span>                :         }
<span class="lineNum">     999 </span>                : }
<span class="lineNum">    1000 </span>                : /* }}} */
<span class="lineNum">    1001 </span>                : 
<a name="1002"><span class="lineNum">    1002 </span>                : /* {{{ proto mixed max(mixed arg1 [, mixed arg2 [, mixed ...]])</a>
<span class="lineNum">    1003 </span>                :    Return the highest value in an array or a series of arguments */
<span class="lineNum">    1004 </span><span class="lineNoCov">              0 : PHP_FUNCTION(max)</span>
<span class="lineNum">    1005 </span>                : {
<span class="lineNum">    1006 </span><span class="lineNoCov">              0 :         zval ***args = NULL;</span>
<span class="lineNum">    1007 </span>                :         int argc;
<span class="lineNum">    1008 </span>                :         
<span class="lineNum">    1009 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;+&quot;, &amp;args, &amp;argc) == FAILURE) {</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1011 </span>                :         }
<span class="lineNum">    1012 </span>                : 
<span class="lineNum">    1013 </span><span class="lineNoCov">              0 :         php_set_compare_func(PHP_SORT_REGULAR TSRMLS_CC);</span>
<span class="lineNum">    1014 </span>                :         
<span class="lineNum">    1015 </span>                :         /* mixed max ( array $values ) */
<span class="lineNum">    1016 </span><span class="lineNoCov">              0 :         if (argc == 1) {</span>
<span class="lineNum">    1017 </span>                :                 zval **result;
<span class="lineNum">    1018 </span>                : 
<span class="lineNum">    1019 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(args[0]) != IS_ARRAY) {</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;When only one parameter is given, it must be an array&quot;);</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">              0 :                         RETVAL_NULL();</span>
<span class="lineNum">    1022 </span>                :                 } else {
<span class="lineNum">    1023 </span><span class="lineNoCov">              0 :                         if (zend_hash_minmax(Z_ARRVAL_PP(args[0]), php_array_data_compare, 1, (void **) &amp;result TSRMLS_CC) == SUCCESS) {</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">              0 :                                 RETVAL_ZVAL(*result, 1, 0);</span>
<span class="lineNum">    1025 </span>                :                         } else {
<span class="lineNum">    1026 </span><span class="lineNoCov">              0 :                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Array must contain at least one element&quot;);</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">              0 :                                 RETVAL_FALSE;</span>
<span class="lineNum">    1028 </span>                :                         }
<span class="lineNum">    1029 </span>                :                 }
<span class="lineNum">    1030 </span>                :         } else {
<span class="lineNum">    1031 </span>                :                 /* mixed max ( mixed $value1 , mixed $value2 [, mixed $value3... ] ) */
<span class="lineNum">    1032 </span>                :                 zval **max, result;
<span class="lineNum">    1033 </span>                :                 int i;
<span class="lineNum">    1034 </span>                : 
<span class="lineNum">    1035 </span><span class="lineNoCov">              0 :                 max = args[0];</span>
<span class="lineNum">    1036 </span>                : 
<span class="lineNum">    1037 </span><span class="lineNoCov">              0 :                 for (i = 1; i &lt; argc; i++) {</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">              0 :                         is_smaller_or_equal_function(&amp;result, *args[i], *max TSRMLS_CC);</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">              0 :                         if (Z_LVAL(result) == 0) {</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">              0 :                                 max = args[i];</span>
<span class="lineNum">    1041 </span>                :                         }
<span class="lineNum">    1042 </span>                :                 }
<span class="lineNum">    1043 </span>                : 
<span class="lineNum">    1044 </span><span class="lineNoCov">              0 :                 RETVAL_ZVAL(*max, 1, 0);</span>
<span class="lineNum">    1045 </span>                :         }
<span class="lineNum">    1046 </span>                :         
<span class="lineNum">    1047 </span><span class="lineNoCov">              0 :         if (args) {</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">              0 :                 efree(args);</span>
<span class="lineNum">    1049 </span>                :         }
<span class="lineNum">    1050 </span>                : }
<a name="1051"><span class="lineNum">    1051 </span>                : /* }}} */</a>
<span class="lineNum">    1052 </span>                : 
<span class="lineNum">    1053 </span><span class="lineNoCov">              0 : static int php_array_walk(HashTable *target_hash, zval *userdata, int recursive TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    1054 </span>                : {
<span class="lineNum">    1055 </span>                :         zval **args[3],                 /* Arguments to userland function */
<span class="lineNum">    1056 </span>                :                   *retval_ptr,          /* Return value - unused */
<span class="lineNum">    1057 </span><span class="lineNoCov">              0 :                   *key=NULL;            /* Entry key */</span>
<span class="lineNum">    1058 </span>                :         char  *string_key;
<span class="lineNum">    1059 </span>                :         uint   string_key_len;
<span class="lineNum">    1060 </span>                :         ulong  num_key;
<span class="lineNum">    1061 </span>                : 
<span class="lineNum">    1062 </span>                :         /* Set up known arguments */
<span class="lineNum">    1063 </span><span class="lineNoCov">              0 :         args[1] = &amp;key;</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">              0 :         args[2] = &amp;userdata;</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">              0 :         if (userdata) {</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">              0 :                 Z_ADDREF_P(userdata);</span>
<span class="lineNum">    1067 </span>                :         }
<span class="lineNum">    1068 </span>                : 
<span class="lineNum">    1069 </span><span class="lineNoCov">              0 :         BG(array_walk_fci).retval_ptr_ptr = &amp;retval_ptr;</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">              0 :         BG(array_walk_fci).param_count = userdata ? 3 : 2;</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">              0 :         BG(array_walk_fci).params = args;</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">              0 :         BG(array_walk_fci).no_separation = 0;</span>
<span class="lineNum">    1073 </span>                :         
<span class="lineNum">    1074 </span>                :         /* Iterate through hash */
<span class="lineNum">    1075 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset(target_hash);</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">              0 :         while (!EG(exception) &amp;&amp; zend_hash_get_current_data(target_hash, (void **)&amp;args[0]) == SUCCESS) {</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">              0 :                 if (recursive &amp;&amp; Z_TYPE_PP(args[0]) == IS_ARRAY) {</span>
<span class="lineNum">    1078 </span>                :                         HashTable *thash;
<span class="lineNum">    1079 </span>                :                         zend_fcall_info orig_array_walk_fci;
<span class="lineNum">    1080 </span>                :                         zend_fcall_info_cache orig_array_walk_fci_cache;
<span class="lineNum">    1081 </span>                : 
<span class="lineNum">    1082 </span><span class="lineNoCov">              0 :                         SEPARATE_ZVAL_IF_NOT_REF(args[0]);</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">              0 :                         thash = Z_ARRVAL_PP(args[0]);</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">              0 :                         if (thash-&gt;nApplyCount &gt; 1) {</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">              0 :                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;recursion detected&quot;);</span>
<span class="lineNum">    1086 </span><span class="lineNoCov">              0 :                                 if (userdata) {</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">              0 :                                         zval_ptr_dtor(&amp;userdata);</span>
<span class="lineNum">    1088 </span>                :                                 }
<span class="lineNum">    1089 </span><span class="lineNoCov">              0 :                                 return 0;</span>
<span class="lineNum">    1090 </span>                :                         }
<span class="lineNum">    1091 </span>                : 
<span class="lineNum">    1092 </span>                :                         /* backup the fcall info and cache */
<span class="lineNum">    1093 </span><span class="lineNoCov">              0 :                         orig_array_walk_fci = BG(array_walk_fci);</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">              0 :                         orig_array_walk_fci_cache = BG(array_walk_fci_cache);</span>
<span class="lineNum">    1095 </span>                : 
<span class="lineNum">    1096 </span><span class="lineNoCov">              0 :                         thash-&gt;nApplyCount++;</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">              0 :                         php_array_walk(thash, userdata, recursive TSRMLS_CC);</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">              0 :                         thash-&gt;nApplyCount--;</span>
<span class="lineNum">    1099 </span>                : 
<span class="lineNum">    1100 </span>                :                         /* restore the fcall info and cache */
<span class="lineNum">    1101 </span><span class="lineNoCov">              0 :                         BG(array_walk_fci) = orig_array_walk_fci;</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">              0 :                         BG(array_walk_fci_cache) = orig_array_walk_fci_cache;</span>
<span class="lineNum">    1103 </span>                :                 } else {
<span class="lineNum">    1104 </span>                :                         /* Allocate space for key */
<span class="lineNum">    1105 </span><span class="lineNoCov">              0 :                         MAKE_STD_ZVAL(key);</span>
<span class="lineNum">    1106 </span>                : 
<span class="lineNum">    1107 </span>                :                         /* Set up the key */
<span class="lineNum">    1108 </span><span class="lineNoCov">              0 :                         switch (zend_hash_get_current_key_ex(target_hash, &amp;string_key, &amp;string_key_len, &amp;num_key, 0, NULL)) {</span>
<span class="lineNum">    1109 </span>                :                                 case HASH_KEY_IS_LONG:
<span class="lineNum">    1110 </span><span class="lineNoCov">              0 :                                         Z_TYPE_P(key) = IS_LONG;</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">              0 :                                         Z_LVAL_P(key) = num_key;</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    1113 </span>                :                                 case HASH_KEY_IS_STRING:
<span class="lineNum">    1114 </span><span class="lineNoCov">              0 :                                         ZVAL_STRINGL(key, string_key, string_key_len - 1, 1);</span>
<span class="lineNum">    1115 </span>                :                                         break;
<span class="lineNum">    1116 </span>                :                         }
<span class="lineNum">    1117 </span>                : 
<span class="lineNum">    1118 </span>                :                         /* Call the userland function */
<span class="lineNum">    1119 </span><span class="lineNoCov">              0 :                         if (zend_call_function(&amp;BG(array_walk_fci), &amp;BG(array_walk_fci_cache) TSRMLS_CC) == SUCCESS) {</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">              0 :                                 if (retval_ptr) {</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">              0 :                                         zval_ptr_dtor(&amp;retval_ptr);</span>
<span class="lineNum">    1122 </span>                :                                 }
<span class="lineNum">    1123 </span>                :                         } else {
<span class="lineNum">    1124 </span><span class="lineNoCov">              0 :                                 if (key) {</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">              0 :                                         zval_ptr_dtor(&amp;key);</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">              0 :                                         key = NULL;</span>
<span class="lineNum">    1127 </span>                :                                 }
<span class="lineNum">    1128 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    1129 </span>                :                         }
<span class="lineNum">    1130 </span>                :                 }
<span class="lineNum">    1131 </span>                : 
<span class="lineNum">    1132 </span><span class="lineNoCov">              0 :                 if (key) {</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">              0 :                         zval_ptr_dtor(&amp;key);</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">              0 :                         key = NULL;</span>
<span class="lineNum">    1135 </span>                :                 }
<span class="lineNum">    1136 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward(target_hash);</span>
<span class="lineNum">    1137 </span>                :         }
<span class="lineNum">    1138 </span>                : 
<span class="lineNum">    1139 </span><span class="lineNoCov">              0 :         if (userdata) {</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">              0 :                 zval_ptr_dtor(&amp;userdata);</span>
<span class="lineNum">    1141 </span>                :         }
<span class="lineNum">    1142 </span><span class="lineNoCov">              0 :         return 0;</span>
<span class="lineNum">    1143 </span>                : }
<span class="lineNum">    1144 </span>                : /* }}} */
<span class="lineNum">    1145 </span>                : 
<a name="1146"><span class="lineNum">    1146 </span>                : /* {{{ proto bool array_walk(array input, string funcname [, mixed userdata])</a>
<span class="lineNum">    1147 </span>                :    Apply a user function to every member of an array */
<span class="lineNum">    1148 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_walk)</span>
<span class="lineNum">    1149 </span>                : {
<span class="lineNum">    1150 </span>                :         HashTable *array;
<span class="lineNum">    1151 </span><span class="lineNoCov">              0 :         zval *userdata = NULL;</span>
<span class="lineNum">    1152 </span>                :         zend_fcall_info orig_array_walk_fci;
<span class="lineNum">    1153 </span>                :         zend_fcall_info_cache orig_array_walk_fci_cache;
<span class="lineNum">    1154 </span>                : 
<span class="lineNum">    1155 </span><span class="lineNoCov">              0 :         orig_array_walk_fci = BG(array_walk_fci);</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">              0 :         orig_array_walk_fci_cache = BG(array_walk_fci_cache);</span>
<span class="lineNum">    1157 </span>                : 
<span class="lineNum">    1158 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;Hf|z/&quot;, &amp;array, &amp;BG(array_walk_fci), &amp;BG(array_walk_fci_cache), &amp;userdata) == FAILURE) {</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">              0 :                 BG(array_walk_fci) = orig_array_walk_fci;</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">              0 :                 BG(array_walk_fci_cache) = orig_array_walk_fci_cache;</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1162 </span>                :         }
<span class="lineNum">    1163 </span>                : 
<span class="lineNum">    1164 </span><span class="lineNoCov">              0 :         php_array_walk(array, userdata, 0 TSRMLS_CC);</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">              0 :         BG(array_walk_fci) = orig_array_walk_fci;</span>
<span class="lineNum">    1166 </span><span class="lineNoCov">              0 :         BG(array_walk_fci_cache) = orig_array_walk_fci_cache;</span>
<span class="lineNum">    1167 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">    1168 </span>                : }
<span class="lineNum">    1169 </span>                : /* }}} */
<span class="lineNum">    1170 </span>                : 
<a name="1171"><span class="lineNum">    1171 </span>                : /* {{{ proto bool array_walk_recursive(array input, string funcname [, mixed userdata])</a>
<span class="lineNum">    1172 </span>                :    Apply a user function recursively to every member of an array */
<span class="lineNum">    1173 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_walk_recursive)</span>
<span class="lineNum">    1174 </span>                : {
<span class="lineNum">    1175 </span>                :         HashTable *array;
<span class="lineNum">    1176 </span><span class="lineNoCov">              0 :         zval *userdata = NULL;</span>
<span class="lineNum">    1177 </span>                :         zend_fcall_info orig_array_walk_fci;
<span class="lineNum">    1178 </span>                :         zend_fcall_info_cache orig_array_walk_fci_cache;
<span class="lineNum">    1179 </span>                : 
<span class="lineNum">    1180 </span><span class="lineNoCov">              0 :         orig_array_walk_fci = BG(array_walk_fci);</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">              0 :         orig_array_walk_fci_cache = BG(array_walk_fci_cache);</span>
<span class="lineNum">    1182 </span>                : 
<span class="lineNum">    1183 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;Hf|z/&quot;, &amp;array, &amp;BG(array_walk_fci), &amp;BG(array_walk_fci_cache), &amp;userdata) == FAILURE) {</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">              0 :                 BG(array_walk_fci) = orig_array_walk_fci;</span>
<span class="lineNum">    1185 </span><span class="lineNoCov">              0 :                 BG(array_walk_fci_cache) = orig_array_walk_fci_cache;</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1187 </span>                :         }
<span class="lineNum">    1188 </span>                : 
<span class="lineNum">    1189 </span><span class="lineNoCov">              0 :         php_array_walk(array, userdata, 1 TSRMLS_CC);</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">              0 :         BG(array_walk_fci) = orig_array_walk_fci;</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">              0 :         BG(array_walk_fci_cache) = orig_array_walk_fci_cache;</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">    1193 </span>                : }
<span class="lineNum">    1194 </span>                : /* }}} */
<span class="lineNum">    1195 </span>                : 
<span class="lineNum">    1196 </span>                : /* void php_search_array(INTERNAL_FUNCTION_PARAMETERS, int behavior)
<span class="lineNum">    1197 </span>                :  * 0 = return boolean
<a name="1198"><span class="lineNum">    1198 </span>                :  * 1 = return key</a>
<span class="lineNum">    1199 </span>                :  */
<span class="lineNum">    1200 </span><span class="lineCov">            490 : static void php_search_array(INTERNAL_FUNCTION_PARAMETERS, int behavior) /* {{{ */</span>
<span class="lineNum">    1201 </span>                : {
<span class="lineNum">    1202 </span>                :         zval *value,                            /* value to check for */
<span class="lineNum">    1203 </span>                :                  *array,                                /* array to check in */
<span class="lineNum">    1204 </span>                :                  **entry,                               /* pointer to array entry */
<span class="lineNum">    1205 </span>                :                   res;                                  /* comparison result */
<span class="lineNum">    1206 </span>                :         HashPosition pos;                       /* hash iterator */
<span class="lineNum">    1207 </span><span class="lineCov">            490 :         zend_bool strict = 0;           /* strict comparison or not */</span>
<span class="lineNum">    1208 </span>                :         ulong num_key;
<span class="lineNum">    1209 </span>                :         uint str_key_len;
<span class="lineNum">    1210 </span>                :         char *string_key;
<span class="lineNum">    1211 </span><span class="lineCov">            490 :         int (*is_equal_func)(zval *, zval *, zval * TSRMLS_DC) = is_equal_function;</span>
<span class="lineNum">    1212 </span>                : 
<span class="lineNum">    1213 </span><span class="lineCov">            490 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;za|b&quot;, &amp;value, &amp;array, &amp;strict) == FAILURE) {</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1215 </span>                :         }
<span class="lineNum">    1216 </span>                : 
<span class="lineNum">    1217 </span><span class="lineCov">            490 :         if (strict) {</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">              0 :                 is_equal_func = is_identical_function;</span>
<span class="lineNum">    1219 </span>                :         }
<span class="lineNum">    1220 </span>                : 
<span class="lineNum">    1221 </span><span class="lineCov">            490 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">    1222 </span><span class="lineCov">           1664 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(array), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    1223 </span><span class="lineCov">           1008 :                 is_equal_func(&amp;res, value, *entry TSRMLS_CC);</span>
<span class="lineNum">    1224 </span><span class="lineCov">           1008 :                 if (Z_LVAL(res)) {</span>
<span class="lineNum">    1225 </span><span class="lineCov">            324 :                         if (behavior == 0) {</span>
<span class="lineNum">    1226 </span><span class="lineCov">            324 :                                 RETURN_TRUE;</span>
<span class="lineNum">    1227 </span>                :                         } else {
<span class="lineNum">    1228 </span>                :                                 /* Return current key */
<span class="lineNum">    1229 </span><span class="lineNoCov">              0 :                                 switch (zend_hash_get_current_key_ex(Z_ARRVAL_P(array), &amp;string_key, &amp;str_key_len, &amp;num_key, 0, &amp;pos)) {</span>
<span class="lineNum">    1230 </span>                :                                         case HASH_KEY_IS_STRING:
<span class="lineNum">    1231 </span><span class="lineNoCov">              0 :                                                 RETURN_STRINGL(string_key, str_key_len - 1, 1);</span>
<span class="lineNum">    1232 </span>                :                                                 break;
<span class="lineNum">    1233 </span>                :                                         case HASH_KEY_IS_LONG:
<span class="lineNum">    1234 </span><span class="lineNoCov">              0 :                                                 RETURN_LONG(num_key);</span>
<span class="lineNum">    1235 </span>                :                                                 break;
<span class="lineNum">    1236 </span>                :                                 }
<span class="lineNum">    1237 </span>                :                         }
<span class="lineNum">    1238 </span>                :                 }
<span class="lineNum">    1239 </span><span class="lineCov">            684 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">    1240 </span>                :         }
<span class="lineNum">    1241 </span>                : 
<span class="lineNum">    1242 </span><span class="lineCov">            166 :         RETURN_FALSE;</span>
<span class="lineNum">    1243 </span>                : }
<span class="lineNum">    1244 </span>                : /* }}} */
<span class="lineNum">    1245 </span>                : 
<a name="1246"><span class="lineNum">    1246 </span>                : /* {{{ proto bool in_array(mixed needle, array haystack [, bool strict])</a>
<span class="lineNum">    1247 </span>                :    Checks if the given value exists in the array */
<span class="lineNum">    1248 </span><span class="lineCov">            490 : PHP_FUNCTION(in_array)</span>
<span class="lineNum">    1249 </span>                : {
<span class="lineNum">    1250 </span><span class="lineCov">            490 :         php_search_array(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0);</span>
<span class="lineNum">    1251 </span><span class="lineCov">            490 : }</span>
<span class="lineNum">    1252 </span>                : /* }}} */
<span class="lineNum">    1253 </span>                : 
<a name="1254"><span class="lineNum">    1254 </span>                : /* {{{ proto mixed array_search(mixed needle, array haystack [, bool strict])</a>
<span class="lineNum">    1255 </span>                :    Searches the array for a given value and returns the corresponding key if successful */
<span class="lineNum">    1256 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_search)</span>
<span class="lineNum">    1257 </span>                : {
<span class="lineNum">    1258 </span><span class="lineNoCov">              0 :         php_search_array(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1);</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">              0 : }</span>
<a name="1260"><span class="lineNum">    1260 </span>                : /* }}} */</a>
<span class="lineNum">    1261 </span>                : 
<span class="lineNum">    1262 </span><span class="lineNoCov">              0 : static int php_valid_var_name(char *var_name, int var_name_len) /* {{{ */</span>
<span class="lineNum">    1263 </span>                : {
<span class="lineNum">    1264 </span>                :         int i, ch;
<span class="lineNum">    1265 </span>                : 
<span class="lineNum">    1266 </span><span class="lineNoCov">              0 :         if (!var_name || !var_name_len) {</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">              0 :                 return 0;</span>
<span class="lineNum">    1268 </span>                :         }
<span class="lineNum">    1269 </span>                :         
<span class="lineNum">    1270 </span>                :         /* These are allowed as first char: [a-zA-Z_\x7f-\xff] */
<span class="lineNum">    1271 </span><span class="lineNoCov">              0 :         ch = (int)((unsigned char *)var_name)[0];</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">              0 :         if (var_name[0] != '_' &amp;&amp;</span>
<span class="lineNum">    1273 </span>                :                 (ch &lt; 65  /* A    */ || /* Z    */ ch &gt; 90)  &amp;&amp;
<span class="lineNum">    1274 </span>                :                 (ch &lt; 97  /* a    */ || /* z    */ ch &gt; 122) &amp;&amp;
<span class="lineNum">    1275 </span>                :                 (ch &lt; 127 /* 0x7f */ || /* 0xff */ ch &gt; 255)
<span class="lineNum">    1276 </span>                :         ) {
<span class="lineNum">    1277 </span><span class="lineNoCov">              0 :                 return 0;</span>
<span class="lineNum">    1278 </span>                :         }
<span class="lineNum">    1279 </span>                : 
<span class="lineNum">    1280 </span>                :         /* And these as the rest: [a-zA-Z0-9_\x7f-\xff] */
<span class="lineNum">    1281 </span><span class="lineNoCov">              0 :         if (var_name_len &gt; 1) {</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">              0 :                 for (i = 1; i &lt; var_name_len; i++) {</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">              0 :                         ch = (int)((unsigned char *)var_name)[i];</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">              0 :                         if (var_name[i] != '_' &amp;&amp;</span>
<span class="lineNum">    1285 </span>                :                                 (ch &lt; 48  /* 0    */ || /* 9    */ ch &gt; 57)  &amp;&amp;
<span class="lineNum">    1286 </span>                :                                 (ch &lt; 65  /* A    */ || /* Z    */ ch &gt; 90)  &amp;&amp;
<span class="lineNum">    1287 </span>                :                                 (ch &lt; 97  /* a    */ || /* z    */ ch &gt; 122) &amp;&amp;
<span class="lineNum">    1288 </span>                :                                 (ch &lt; 127 /* 0x7f */ || /* 0xff */ ch &gt; 255)
<span class="lineNum">    1289 </span>                :                         ) {
<span class="lineNum">    1290 </span><span class="lineNoCov">              0 :                                 return 0;</span>
<span class="lineNum">    1291 </span>                :                         }
<span class="lineNum">    1292 </span>                :                 }
<span class="lineNum">    1293 </span>                :         }
<span class="lineNum">    1294 </span><span class="lineNoCov">              0 :         return 1;</span>
<span class="lineNum">    1295 </span>                : }
<a name="1296"><span class="lineNum">    1296 </span>                : /* }}} */</a>
<span class="lineNum">    1297 </span>                : 
<span class="lineNum">    1298 </span><span class="lineNoCov">              0 : PHPAPI int php_prefix_varname(zval *result, zval *prefix, char *var_name, int var_name_len, zend_bool add_underscore TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    1299 </span>                : {
<span class="lineNum">    1300 </span><span class="lineNoCov">              0 :         Z_STRLEN_P(result) = Z_STRLEN_P(prefix) + (add_underscore ? 1 : 0) + var_name_len;</span>
<span class="lineNum">    1301 </span><span class="lineNoCov">              0 :         Z_TYPE_P(result) = IS_STRING;</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">              0 :         Z_STRVAL_P(result) = emalloc(Z_STRLEN_P(result) + 1);</span>
<span class="lineNum">    1303 </span><span class="lineNoCov">              0 :         memcpy(Z_STRVAL_P(result), Z_STRVAL_P(prefix), Z_STRLEN_P(prefix));</span>
<span class="lineNum">    1304 </span>                : 
<span class="lineNum">    1305 </span><span class="lineNoCov">              0 :         if (add_underscore) {</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">              0 :                 Z_STRVAL_P(result)[Z_STRLEN_P(prefix)] = '_';</span>
<span class="lineNum">    1307 </span>                :         }
<span class="lineNum">    1308 </span>                : 
<span class="lineNum">    1309 </span><span class="lineNoCov">              0 :         memcpy(Z_STRVAL_P(result) + Z_STRLEN_P(prefix) + (add_underscore ? 1 : 0), var_name, var_name_len + 1);</span>
<span class="lineNum">    1310 </span>                : 
<span class="lineNum">    1311 </span><span class="lineNoCov">              0 :         return SUCCESS;</span>
<span class="lineNum">    1312 </span>                : }
<span class="lineNum">    1313 </span>                : /* }}} */
<span class="lineNum">    1314 </span>                : 
<a name="1315"><span class="lineNum">    1315 </span>                : /* {{{ proto int extract(array var_array [, int extract_type [, string prefix]])</a>
<span class="lineNum">    1316 </span>                :    Imports variables into symbol table from an array */
<span class="lineNum">    1317 </span><span class="lineNoCov">              0 : PHP_FUNCTION(extract)</span>
<span class="lineNum">    1318 </span>                : {
<span class="lineNum">    1319 </span><span class="lineNoCov">              0 :         zval *var_array, *prefix = NULL;</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">              0 :         long extract_type = EXTR_OVERWRITE;</span>
<span class="lineNum">    1321 </span>                :         zval **entry, *data;
<span class="lineNum">    1322 </span>                :         char *var_name;
<span class="lineNum">    1323 </span>                :         ulong num_key;
<span class="lineNum">    1324 </span>                :         uint var_name_len;
<span class="lineNum">    1325 </span><span class="lineNoCov">              0 :         int var_exists, key_type, count = 0;</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">              0 :         int extract_refs = 0;</span>
<span class="lineNum">    1327 </span>                :         HashPosition pos;
<span class="lineNum">    1328 </span>                : 
<span class="lineNum">    1329 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|lz/&quot;, &amp;var_array, &amp;extract_type, &amp;prefix) == FAILURE) {</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1331 </span>                :         }
<span class="lineNum">    1332 </span>                : 
<span class="lineNum">    1333 </span><span class="lineNoCov">              0 :         extract_refs = (extract_type &amp; EXTR_REFS);</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">              0 :         extract_type &amp;= 0xff;</span>
<span class="lineNum">    1335 </span>                : 
<span class="lineNum">    1336 </span><span class="lineNoCov">              0 :         if (extract_type &lt; EXTR_OVERWRITE || extract_type &gt; EXTR_IF_EXISTS) {</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Invalid extract type&quot;);</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1339 </span>                :         }
<span class="lineNum">    1340 </span>                : 
<span class="lineNum">    1341 </span><span class="lineNoCov">              0 :         if (extract_type &gt; EXTR_SKIP &amp;&amp; extract_type &lt;= EXTR_PREFIX_IF_EXISTS &amp;&amp; ZEND_NUM_ARGS() &lt; 3) {</span>
<span class="lineNum">    1342 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;specified extract type requires the prefix parameter&quot;);</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1344 </span>                :         }
<span class="lineNum">    1345 </span>                : 
<span class="lineNum">    1346 </span><span class="lineNoCov">              0 :         if (prefix) {</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">              0 :                 convert_to_string(prefix);</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">              0 :                 if (Z_STRLEN_P(prefix) &amp;&amp; !php_valid_var_name(Z_STRVAL_P(prefix), Z_STRLEN_P(prefix))) {</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;prefix is not a valid identifier&quot;);</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    1351 </span>                :                 }
<span class="lineNum">    1352 </span>                :         }
<span class="lineNum">    1353 </span>                : 
<span class="lineNum">    1354 </span><span class="lineNoCov">              0 :         if (!EG(active_symbol_table)) {</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">              0 :                 zend_rebuild_symbol_table(TSRMLS_C);</span>
<span class="lineNum">    1356 </span>                :         }
<span class="lineNum">    1357 </span>                : 
<span class="lineNum">    1358 </span>                :         /* var_array is passed by ref for the needs of EXTR_REFS (needs to
<span class="lineNum">    1359 </span>                :          * work on the original array to create refs to its members)
<span class="lineNum">    1360 </span>                :          * simulate pass_by_value if EXTR_REFS is not used */
<span class="lineNum">    1361 </span><span class="lineNoCov">              0 :         if (!extract_refs) {</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">              0 :                 SEPARATE_ARG_IF_REF(var_array);</span>
<span class="lineNum">    1363 </span>                :         }
<span class="lineNum">    1364 </span>                : 
<span class="lineNum">    1365 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(var_array), &amp;pos);</span>
<span class="lineNum">    1366 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(var_array), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    1367 </span>                :                 zval final_name;
<span class="lineNum">    1368 </span>                : 
<span class="lineNum">    1369 </span><span class="lineNoCov">              0 :                 ZVAL_NULL(&amp;final_name);</span>
<span class="lineNum">    1370 </span>                : 
<span class="lineNum">    1371 </span><span class="lineNoCov">              0 :                 key_type = zend_hash_get_current_key_ex(Z_ARRVAL_P(var_array), &amp;var_name, &amp;var_name_len, &amp;num_key, 0, &amp;pos);</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">              0 :                 var_exists = 0;</span>
<span class="lineNum">    1373 </span>                : 
<span class="lineNum">    1374 </span><span class="lineNoCov">              0 :                 if (key_type == HASH_KEY_IS_STRING) {</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">              0 :                         var_name_len--;</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">              0 :                         var_exists = zend_hash_exists(EG(active_symbol_table), var_name, var_name_len + 1);</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">              0 :                 } else if (key_type == HASH_KEY_IS_LONG &amp;&amp; (extract_type == EXTR_PREFIX_ALL || extract_type == EXTR_PREFIX_INVALID)) {</span>
<span class="lineNum">    1378 </span>                :                         zval num;
<span class="lineNum">    1379 </span>                : 
<span class="lineNum">    1380 </span><span class="lineNoCov">              0 :                         ZVAL_LONG(&amp;num, num_key);</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">              0 :                         convert_to_string(&amp;num);</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">              0 :                         php_prefix_varname(&amp;final_name, prefix, Z_STRVAL(num), Z_STRLEN(num), 1 TSRMLS_CC);</span>
<span class="lineNum">    1383 </span>                :                         zval_dtor(&amp;num);
<span class="lineNum">    1384 </span>                :                 } else {
<span class="lineNum">    1385 </span><span class="lineNoCov">              0 :                         zend_hash_move_forward_ex(Z_ARRVAL_P(var_array), &amp;pos);</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">              0 :                         continue;</span>
<span class="lineNum">    1387 </span>                :                 }
<span class="lineNum">    1388 </span>                : 
<span class="lineNum">    1389 </span><span class="lineNoCov">              0 :                 switch (extract_type) {</span>
<span class="lineNum">    1390 </span>                :                         case EXTR_IF_EXISTS:
<span class="lineNum">    1391 </span><span class="lineNoCov">              0 :                                 if (!var_exists) break;</span>
<span class="lineNum">    1392 </span>                :                                 /* break omitted intentionally */
<span class="lineNum">    1393 </span>                : 
<span class="lineNum">    1394 </span>                :                         case EXTR_OVERWRITE:
<span class="lineNum">    1395 </span>                :                                 /* GLOBALS protection */
<span class="lineNum">    1396 </span><span class="lineNoCov">              0 :                                 if (var_exists &amp;&amp; var_name_len == sizeof(&quot;GLOBALS&quot;)-1 &amp;&amp; !strcmp(var_name, &quot;GLOBALS&quot;)) {</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    1398 </span>                :                                 }
<span class="lineNum">    1399 </span><span class="lineNoCov">              0 :                                 if (var_exists &amp;&amp; var_name_len == sizeof(&quot;this&quot;)-1  &amp;&amp; !strcmp(var_name, &quot;this&quot;) &amp;&amp; EG(scope) &amp;&amp; EG(scope)-&gt;name_length != 0) {</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    1401 </span>                :                                 }
<span class="lineNum">    1402 </span><span class="lineNoCov">              0 :                                 ZVAL_STRINGL(&amp;final_name, var_name, var_name_len, 1);</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    1404 </span>                : 
<span class="lineNum">    1405 </span>                :                         case EXTR_PREFIX_IF_EXISTS:
<span class="lineNum">    1406 </span><span class="lineNoCov">              0 :                                 if (var_exists) {</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">              0 :                                         php_prefix_varname(&amp;final_name, prefix, var_name, var_name_len, 1 TSRMLS_CC);</span>
<span class="lineNum">    1408 </span>                :                                 }
<span class="lineNum">    1409 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    1410 </span>                : 
<span class="lineNum">    1411 </span>                :                         case EXTR_PREFIX_SAME:
<span class="lineNum">    1412 </span><span class="lineNoCov">              0 :                                 if (!var_exists &amp;&amp; var_name_len != 0) {</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">              0 :                                         ZVAL_STRINGL(&amp;final_name, var_name, var_name_len, 1);</span>
<span class="lineNum">    1414 </span>                :                                 }
<span class="lineNum">    1415 </span>                :                                 /* break omitted intentionally */
<span class="lineNum">    1416 </span>                : 
<span class="lineNum">    1417 </span>                :                         case EXTR_PREFIX_ALL:
<span class="lineNum">    1418 </span><span class="lineNoCov">              0 :                                 if (Z_TYPE(final_name) == IS_NULL &amp;&amp; var_name_len != 0) {</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">              0 :                                         php_prefix_varname(&amp;final_name, prefix, var_name, var_name_len, 1 TSRMLS_CC);</span>
<span class="lineNum">    1420 </span>                :                                 }
<span class="lineNum">    1421 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    1422 </span>                : 
<span class="lineNum">    1423 </span>                :                         case EXTR_PREFIX_INVALID:
<span class="lineNum">    1424 </span><span class="lineNoCov">              0 :                                 if (Z_TYPE(final_name) == IS_NULL) {</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">              0 :                                         if (!php_valid_var_name(var_name, var_name_len)) {</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">              0 :                                                 php_prefix_varname(&amp;final_name, prefix, var_name, var_name_len, 1 TSRMLS_CC);</span>
<span class="lineNum">    1427 </span>                :                                         } else {
<span class="lineNum">    1428 </span><span class="lineNoCov">              0 :                                                 ZVAL_STRINGL(&amp;final_name, var_name, var_name_len, 1);</span>
<span class="lineNum">    1429 </span>                :                                         }
<span class="lineNum">    1430 </span>                :                                 }
<span class="lineNum">    1431 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    1432 </span>                : 
<span class="lineNum">    1433 </span>                :                         default:
<span class="lineNum">    1434 </span><span class="lineNoCov">              0 :                                 if (!var_exists) {</span>
<span class="lineNum">    1435 </span><span class="lineNoCov">              0 :                                         ZVAL_STRINGL(&amp;final_name, var_name, var_name_len, 1);</span>
<span class="lineNum">    1436 </span>                :                                 }
<span class="lineNum">    1437 </span>                :                                 break;
<span class="lineNum">    1438 </span>                :                 }
<span class="lineNum">    1439 </span>                : 
<span class="lineNum">    1440 </span><span class="lineNoCov">              0 :                 if (Z_TYPE(final_name) != IS_NULL &amp;&amp; php_valid_var_name(Z_STRVAL(final_name), Z_STRLEN(final_name))) {</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">              0 :                         if (extract_refs) {</span>
<span class="lineNum">    1442 </span>                :                                 zval **orig_var;
<span class="lineNum">    1443 </span>                : 
<span class="lineNum">    1444 </span><span class="lineNoCov">              0 :                                 SEPARATE_ZVAL_TO_MAKE_IS_REF(entry);</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">              0 :                                 zval_add_ref(entry);</span>
<span class="lineNum">    1446 </span>                : 
<span class="lineNum">    1447 </span><span class="lineNoCov">              0 :                                 if (zend_hash_find(EG(active_symbol_table), Z_STRVAL(final_name), Z_STRLEN(final_name) + 1, (void **) &amp;orig_var) == SUCCESS) {</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">              0 :                                         zval_ptr_dtor(orig_var);</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">              0 :                                         *orig_var = *entry;</span>
<span class="lineNum">    1450 </span>                :                                 } else {
<span class="lineNum">    1451 </span><span class="lineNoCov">              0 :                                         zend_hash_update(EG(active_symbol_table), Z_STRVAL(final_name), Z_STRLEN(final_name) + 1, (void **) entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1452 </span>                :                                 }
<span class="lineNum">    1453 </span>                :                         } else {
<span class="lineNum">    1454 </span><span class="lineNoCov">              0 :                                 MAKE_STD_ZVAL(data);</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">              0 :                                 *data = **entry;</span>
<span class="lineNum">    1456 </span><span class="lineNoCov">              0 :                                 zval_copy_ctor(data);</span>
<span class="lineNum">    1457 </span>                : 
<span class="lineNum">    1458 </span><span class="lineNoCov">              0 :                                 ZEND_SET_SYMBOL_WITH_LENGTH(EG(active_symbol_table), Z_STRVAL(final_name), Z_STRLEN(final_name) + 1, data, 1, 0);</span>
<span class="lineNum">    1459 </span>                :                         }
<span class="lineNum">    1460 </span><span class="lineNoCov">              0 :                         count++;</span>
<span class="lineNum">    1461 </span>                :                 }
<span class="lineNum">    1462 </span>                :                 zval_dtor(&amp;final_name);
<span class="lineNum">    1463 </span>                : 
<span class="lineNum">    1464 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(var_array), &amp;pos);</span>
<span class="lineNum">    1465 </span>                :         }
<span class="lineNum">    1466 </span>                : 
<span class="lineNum">    1467 </span><span class="lineNoCov">              0 :         if (!extract_refs) {</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">              0 :                 zval_ptr_dtor(&amp;var_array);</span>
<span class="lineNum">    1469 </span>                :         }
<span class="lineNum">    1470 </span>                : 
<span class="lineNum">    1471 </span><span class="lineNoCov">              0 :         RETURN_LONG(count);</span>
<span class="lineNum">    1472 </span>                : }
<a name="1473"><span class="lineNum">    1473 </span>                : /* }}} */</a>
<span class="lineNum">    1474 </span>                : 
<span class="lineNum">    1475 </span><span class="lineNoCov">              0 : static void php_compact_var(HashTable *eg_active_symbol_table, zval *return_value, zval *entry TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    1476 </span>                : {
<span class="lineNum">    1477 </span>                :         zval **value_ptr, *value, *data;
<span class="lineNum">    1478 </span>                : 
<span class="lineNum">    1479 </span><span class="lineNoCov">              0 :         if (Z_TYPE_P(entry) == IS_STRING) {</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">              0 :                 if (zend_hash_find(eg_active_symbol_table, Z_STRVAL_P(entry), Z_STRLEN_P(entry) + 1, (void **)&amp;value_ptr) != FAILURE) {</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">              0 :                         value = *value_ptr;</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">              0 :                         ALLOC_ZVAL(data);</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">              0 :                         MAKE_COPY_ZVAL(&amp;value, data);</span>
<span class="lineNum">    1484 </span>                : 
<span class="lineNum">    1485 </span><span class="lineNoCov">              0 :                         zend_hash_update(Z_ARRVAL_P(return_value), Z_STRVAL_P(entry), Z_STRLEN_P(entry) + 1, &amp;data, sizeof(zval *), NULL);</span>
<span class="lineNum">    1486 </span>                :                 }
<span class="lineNum">    1487 </span>                :         }
<span class="lineNum">    1488 </span><span class="lineNoCov">              0 :         else if (Z_TYPE_P(entry) == IS_ARRAY) {</span>
<span class="lineNum">    1489 </span>                :                 HashPosition pos;
<span class="lineNum">    1490 </span>                : 
<span class="lineNum">    1491 </span><span class="lineNoCov">              0 :                 if ((Z_ARRVAL_P(entry)-&gt;nApplyCount &gt; 1)) {</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;recursion detected&quot;);</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    1494 </span>                :                 }
<span class="lineNum">    1495 </span>                : 
<span class="lineNum">    1496 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_P(entry)-&gt;nApplyCount++;</span>
<span class="lineNum">    1497 </span>                : 
<span class="lineNum">    1498 </span><span class="lineNoCov">              0 :                 zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(entry), &amp;pos);</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">              0 :                 while (zend_hash_get_current_data_ex(Z_ARRVAL_P(entry), (void**)&amp;value_ptr, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">              0 :                         value = *value_ptr;</span>
<span class="lineNum">    1501 </span>                : 
<span class="lineNum">    1502 </span><span class="lineNoCov">              0 :                         php_compact_var(eg_active_symbol_table, return_value, value TSRMLS_CC);</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">              0 :                         zend_hash_move_forward_ex(Z_ARRVAL_P(entry), &amp;pos);</span>
<span class="lineNum">    1504 </span>                :                 }
<span class="lineNum">    1505 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_P(entry)-&gt;nApplyCount--;</span>
<span class="lineNum">    1506 </span>                :         }
<span class="lineNum">    1507 </span>                : }
<span class="lineNum">    1508 </span>                : /* }}} */
<span class="lineNum">    1509 </span>                : 
<a name="1510"><span class="lineNum">    1510 </span>                : /* {{{ proto array compact(mixed var_names [, mixed ...])</a>
<span class="lineNum">    1511 </span>                :    Creates a hash containing variables and their values */
<span class="lineNum">    1512 </span><span class="lineNoCov">              0 : PHP_FUNCTION(compact)</span>
<span class="lineNum">    1513 </span>                : {
<span class="lineNum">    1514 </span><span class="lineNoCov">              0 :         zval ***args = NULL;    /* function arguments array */</span>
<span class="lineNum">    1515 </span>                :         int num_args, i;
<span class="lineNum">    1516 </span>                : 
<span class="lineNum">    1517 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;+&quot;, &amp;args, &amp;num_args) == FAILURE) {</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1519 </span>                :         }
<span class="lineNum">    1520 </span>                : 
<span class="lineNum">    1521 </span><span class="lineNoCov">              0 :         if (!EG(active_symbol_table)) {</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">              0 :                 zend_rebuild_symbol_table(TSRMLS_C);</span>
<span class="lineNum">    1523 </span>                :         }
<span class="lineNum">    1524 </span>                : 
<span class="lineNum">    1525 </span>                :         /* compact() is probably most used with a single array of var_names
<span class="lineNum">    1526 </span>                :            or multiple string names, rather than a combination of both.
<span class="lineNum">    1527 </span>                :            So quickly guess a minimum result size based on that */
<span class="lineNum">    1528 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() == 1 &amp;&amp; Z_TYPE_PP(args[0]) == IS_ARRAY) {</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">              0 :                 array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_PP(args[0])));</span>
<span class="lineNum">    1530 </span>                :         } else {
<span class="lineNum">    1531 </span><span class="lineNoCov">              0 :                 array_init_size(return_value, ZEND_NUM_ARGS());</span>
<span class="lineNum">    1532 </span>                :         }
<span class="lineNum">    1533 </span>                : 
<span class="lineNum">    1534 </span><span class="lineNoCov">              0 :         for (i=0; i&lt;ZEND_NUM_ARGS(); i++) {</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">              0 :                 php_compact_var(EG(active_symbol_table), return_value, *args[i] TSRMLS_CC);</span>
<span class="lineNum">    1536 </span>                :         }
<span class="lineNum">    1537 </span>                : 
<span class="lineNum">    1538 </span><span class="lineNoCov">              0 :         if (args) {</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">              0 :                 efree(args);</span>
<span class="lineNum">    1540 </span>                :         }
<span class="lineNum">    1541 </span>                : }
<span class="lineNum">    1542 </span>                : /* }}} */
<span class="lineNum">    1543 </span>                : 
<a name="1544"><span class="lineNum">    1544 </span>                : /* {{{ proto array array_fill(int start_key, int num, mixed val)</a>
<span class="lineNum">    1545 </span>                :    Create an array containing num elements starting with index start_key each initialized to val */
<span class="lineNum">    1546 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_fill)</span>
<span class="lineNum">    1547 </span>                : {
<span class="lineNum">    1548 </span>                :         zval *val;
<span class="lineNum">    1549 </span>                :         long start_key, num;
<span class="lineNum">    1550 </span>                : 
<span class="lineNum">    1551 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;llz&quot;, &amp;start_key, &amp;num, &amp;val) == FAILURE) {</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1553 </span>                :         }
<span class="lineNum">    1554 </span>                : 
<span class="lineNum">    1555 </span><span class="lineNoCov">              0 :         if (num &lt; 1) {</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Number of elements must be positive&quot;);</span>
<span class="lineNum">    1557 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    1558 </span>                :         }
<span class="lineNum">    1559 </span>                : 
<span class="lineNum">    1560 </span>                :         /* allocate an array for return */
<span class="lineNum">    1561 </span><span class="lineNoCov">              0 :         array_init_size(return_value, num);</span>
<span class="lineNum">    1562 </span>                : 
<span class="lineNum">    1563 </span><span class="lineNoCov">              0 :         num--;</span>
<span class="lineNum">    1564 </span><span class="lineNoCov">              0 :         zend_hash_index_update(Z_ARRVAL_P(return_value), start_key, &amp;val, sizeof(zval *), NULL);</span>
<span class="lineNum">    1565 </span><span class="lineNoCov">              0 :         zval_add_ref(&amp;val);</span>
<span class="lineNum">    1566 </span>                : 
<span class="lineNum">    1567 </span><span class="lineNoCov">              0 :         while (num--) {</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">              0 :                 if (zend_hash_next_index_insert(Z_ARRVAL_P(return_value), &amp;val, sizeof(zval *), NULL) == SUCCESS) {</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">              0 :                         zval_add_ref(&amp;val);</span>
<span class="lineNum">    1570 </span>                :                 } else {
<span class="lineNum">    1571 </span>                :                         zval_dtor(return_value);
<span class="lineNum">    1572 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Cannot add element to the array as the next element is already occupied&quot;);</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">    1574 </span>                :                 }
<span class="lineNum">    1575 </span>                :         }
<span class="lineNum">    1576 </span>                : }
<span class="lineNum">    1577 </span>                : /* }}} */
<span class="lineNum">    1578 </span>                : 
<a name="1579"><span class="lineNum">    1579 </span>                : /* {{{ proto array array_fill_keys(array keys, mixed val)</a>
<span class="lineNum">    1580 </span>                :    Create an array using the elements of the first parameter as keys each initialized to val */
<span class="lineNum">    1581 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_fill_keys)</span>
<span class="lineNum">    1582 </span>                : {
<span class="lineNum">    1583 </span>                :         zval *keys, *val, **entry;
<span class="lineNum">    1584 </span>                :         HashPosition pos;
<span class="lineNum">    1585 </span>                : 
<span class="lineNum">    1586 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;az&quot;, &amp;keys, &amp;val) == FAILURE) {</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1588 </span>                :         }
<span class="lineNum">    1589 </span>                : 
<span class="lineNum">    1590 </span>                :         /* Initialize return array */
<span class="lineNum">    1591 </span><span class="lineNoCov">              0 :         array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(keys)));</span>
<span class="lineNum">    1592 </span>                : 
<span class="lineNum">    1593 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(keys), &amp;pos);</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(keys), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    1595 </span>                : 
<span class="lineNum">    1596 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(entry) == IS_LONG) {</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">              0 :                         zval_add_ref(&amp;val);</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">              0 :                         zend_hash_index_update(Z_ARRVAL_P(return_value), Z_LVAL_PP(entry), &amp;val, sizeof(zval *), NULL);</span>
<span class="lineNum">    1599 </span>                :                 } else {
<span class="lineNum">    1600 </span><span class="lineNoCov">              0 :                         zval key, *key_ptr = *entry;</span>
<span class="lineNum">    1601 </span>                : 
<span class="lineNum">    1602 </span><span class="lineNoCov">              0 :                         if (Z_TYPE_PP(entry) != IS_STRING) {</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">              0 :                                 key = **entry;</span>
<span class="lineNum">    1604 </span>                :                                 zval_copy_ctor(&amp;key);
<span class="lineNum">    1605 </span><span class="lineNoCov">              0 :                                 convert_to_string(&amp;key);</span>
<span class="lineNum">    1606 </span><span class="lineNoCov">              0 :                                 key_ptr = &amp;key;</span>
<span class="lineNum">    1607 </span>                :                         }
<span class="lineNum">    1608 </span>                : 
<span class="lineNum">    1609 </span><span class="lineNoCov">              0 :                         zval_add_ref(&amp;val);</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">              0 :                         zend_symtable_update(Z_ARRVAL_P(return_value), Z_STRVAL_P(key_ptr), Z_STRLEN_P(key_ptr) + 1, &amp;val, sizeof(zval *), NULL);</span>
<span class="lineNum">    1611 </span>                : 
<span class="lineNum">    1612 </span><span class="lineNoCov">              0 :                         if (key_ptr != *entry) {</span>
<span class="lineNum">    1613 </span>                :                                 zval_dtor(&amp;key);
<span class="lineNum">    1614 </span>                :                         }
<span class="lineNum">    1615 </span>                :                 }
<span class="lineNum">    1616 </span>                : 
<span class="lineNum">    1617 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(keys), &amp;pos);</span>
<span class="lineNum">    1618 </span>                :         }
<span class="lineNum">    1619 </span>                : }
<span class="lineNum">    1620 </span>                : /* }}} */
<span class="lineNum">    1621 </span>                : 
<a name="1622"><span class="lineNum">    1622 </span>                : /* {{{ proto array range(mixed low, mixed high[, int step])</a>
<span class="lineNum">    1623 </span>                :    Create an array containing the range of integers or characters from low to high (inclusive) */
<span class="lineNum">    1624 </span><span class="lineNoCov">              0 : PHP_FUNCTION(range)</span>
<span class="lineNum">    1625 </span>                : {
<span class="lineNum">    1626 </span><span class="lineNoCov">              0 :         zval *zlow, *zhigh, *zstep = NULL;</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">              0 :         int err = 0, is_step_double = 0;</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">              0 :         double step = 1.0;</span>
<span class="lineNum">    1629 </span>                : 
<span class="lineNum">    1630 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;z/z/|z/&quot;, &amp;zlow, &amp;zhigh, &amp;zstep) == FAILURE) {</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    1632 </span>                :         }
<span class="lineNum">    1633 </span>                : 
<span class="lineNum">    1634 </span><span class="lineNoCov">              0 :         if (zstep) {</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_P(zstep) == IS_DOUBLE ||</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">              0 :                         (Z_TYPE_P(zstep) == IS_STRING &amp;&amp; is_numeric_string(Z_STRVAL_P(zstep), Z_STRLEN_P(zstep), NULL, NULL, 0) == IS_DOUBLE)</span>
<span class="lineNum">    1637 </span>                :                 ) {
<span class="lineNum">    1638 </span><span class="lineNoCov">              0 :                         is_step_double = 1;</span>
<span class="lineNum">    1639 </span>                :                 }
<span class="lineNum">    1640 </span>                : 
<span class="lineNum">    1641 </span><span class="lineNoCov">              0 :                 convert_to_double_ex(&amp;zstep);</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">              0 :                 step = Z_DVAL_P(zstep);</span>
<span class="lineNum">    1643 </span>                : 
<span class="lineNum">    1644 </span>                :                 /* We only want positive step values. */
<span class="lineNum">    1645 </span><span class="lineNoCov">              0 :                 if (step &lt; 0.0) {</span>
<span class="lineNum">    1646 </span><span class="lineNoCov">              0 :                         step *= -1;</span>
<span class="lineNum">    1647 </span>                :                 }
<span class="lineNum">    1648 </span>                :         }
<span class="lineNum">    1649 </span>                : 
<span class="lineNum">    1650 </span>                :         /* Initialize the return_value as an array. */
<span class="lineNum">    1651 </span><span class="lineNoCov">              0 :         array_init(return_value);</span>
<span class="lineNum">    1652 </span>                : 
<span class="lineNum">    1653 </span>                :         /* If the range is given as strings, generate an array of characters. */
<span class="lineNum">    1654 </span><span class="lineNoCov">              0 :         if (Z_TYPE_P(zlow) == IS_STRING &amp;&amp; Z_TYPE_P(zhigh) == IS_STRING &amp;&amp; Z_STRLEN_P(zlow) &gt;= 1 &amp;&amp; Z_STRLEN_P(zhigh) &gt;= 1) {</span>
<span class="lineNum">    1655 </span>                :                 int type1, type2;
<span class="lineNum">    1656 </span>                :                 unsigned char *low, *high;
<span class="lineNum">    1657 </span><span class="lineNoCov">              0 :                 long lstep = (long) step;</span>
<span class="lineNum">    1658 </span>                : 
<span class="lineNum">    1659 </span><span class="lineNoCov">              0 :                 type1 = is_numeric_string(Z_STRVAL_P(zlow), Z_STRLEN_P(zlow), NULL, NULL, 0);</span>
<span class="lineNum">    1660 </span><span class="lineNoCov">              0 :                 type2 = is_numeric_string(Z_STRVAL_P(zhigh), Z_STRLEN_P(zhigh), NULL, NULL, 0);</span>
<span class="lineNum">    1661 </span>                : 
<span class="lineNum">    1662 </span><span class="lineNoCov">              0 :                 if (type1 == IS_DOUBLE || type2 == IS_DOUBLE || is_step_double) {</span>
<span class="lineNum">    1663 </span>                :                         goto double_str;
<span class="lineNum">    1664 </span><span class="lineNoCov">              0 :                 } else if (type1 == IS_LONG || type2 == IS_LONG) {</span>
<span class="lineNum">    1665 </span>                :                         goto long_str;
<span class="lineNum">    1666 </span>                :                 }
<span class="lineNum">    1667 </span>                : 
<span class="lineNum">    1668 </span><span class="lineNoCov">              0 :                 convert_to_string(zlow);</span>
<span class="lineNum">    1669 </span><span class="lineNoCov">              0 :                 convert_to_string(zhigh);</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">              0 :                 low = (unsigned char *)Z_STRVAL_P(zlow);</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">              0 :                 high = (unsigned char *)Z_STRVAL_P(zhigh);</span>
<span class="lineNum">    1672 </span>                : 
<span class="lineNum">    1673 </span><span class="lineNoCov">              0 :                 if (*low &gt; *high) {          /* Negative Steps */</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">              0 :                         unsigned char ch = *low;</span>
<span class="lineNum">    1675 </span>                : 
<span class="lineNum">    1676 </span><span class="lineNoCov">              0 :                         if (lstep &lt;= 0) {</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">              0 :                                 err = 1;</span>
<span class="lineNum">    1678 </span><span class="lineNoCov">              0 :                                 goto err;</span>
<span class="lineNum">    1679 </span>                :                         }
<span class="lineNum">    1680 </span><span class="lineNoCov">              0 :                         for (; ch &gt;= *high; ch -= (unsigned int)lstep) {</span>
<span class="lineNum">    1681 </span><span class="lineNoCov">              0 :                                 add_next_index_stringl(return_value, (const char *)&amp;ch, 1, 1);</span>
<span class="lineNum">    1682 </span><span class="lineNoCov">              0 :                                 if (((signed int)ch - lstep) &lt; 0) {</span>
<span class="lineNum">    1683 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    1684 </span>                :                                 }
<span class="lineNum">    1685 </span>                :                         }
<span class="lineNum">    1686 </span><span class="lineNoCov">              0 :                 } else if (*high &gt; *low) {   /* Positive Steps */</span>
<span class="lineNum">    1687 </span><span class="lineNoCov">              0 :                         unsigned char ch = *low;</span>
<span class="lineNum">    1688 </span>                : 
<span class="lineNum">    1689 </span><span class="lineNoCov">              0 :                         if (lstep &lt;= 0) {</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">              0 :                                 err = 1;</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">              0 :                                 goto err;</span>
<span class="lineNum">    1692 </span>                :                         }
<span class="lineNum">    1693 </span><span class="lineNoCov">              0 :                         for (; ch &lt;= *high; ch += (unsigned int)lstep) {</span>
<span class="lineNum">    1694 </span><span class="lineNoCov">              0 :                                 add_next_index_stringl(return_value, (const char *)&amp;ch, 1, 1);</span>
<span class="lineNum">    1695 </span><span class="lineNoCov">              0 :                                 if (((signed int)ch + lstep) &gt; 255) {</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    1697 </span>                :                                 }
<span class="lineNum">    1698 </span>                :                         }
<span class="lineNum">    1699 </span>                :                 } else {
<span class="lineNum">    1700 </span><span class="lineNoCov">              0 :                         add_next_index_stringl(return_value, (const char *)low, 1, 1);</span>
<span class="lineNum">    1701 </span>                :                 }
<span class="lineNum">    1702 </span>                : 
<span class="lineNum">    1703 </span><span class="lineNoCov">              0 :         } else if (Z_TYPE_P(zlow) == IS_DOUBLE || Z_TYPE_P(zhigh) == IS_DOUBLE || is_step_double) {</span>
<span class="lineNum">    1704 </span>                :                 double low, high, value;
<span class="lineNum">    1705 </span>                :                 long i;
<span class="lineNum">    1706 </span>                : double_str:
<span class="lineNum">    1707 </span><span class="lineNoCov">              0 :                 convert_to_double(zlow);</span>
<span class="lineNum">    1708 </span><span class="lineNoCov">              0 :                 convert_to_double(zhigh);</span>
<span class="lineNum">    1709 </span><span class="lineNoCov">              0 :                 low = Z_DVAL_P(zlow);</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">              0 :                 high = Z_DVAL_P(zhigh);</span>
<span class="lineNum">    1711 </span><span class="lineNoCov">              0 :                 i = 0;</span>
<span class="lineNum">    1712 </span>                : 
<span class="lineNum">    1713 </span><span class="lineNoCov">              0 :                 if (low &gt; high) {            /* Negative steps */</span>
<span class="lineNum">    1714 </span><span class="lineNoCov">              0 :                         if (low - high &lt; step || step &lt;= 0) {</span>
<span class="lineNum">    1715 </span><span class="lineNoCov">              0 :                                 err = 1;</span>
<span class="lineNum">    1716 </span><span class="lineNoCov">              0 :                                 goto err;</span>
<span class="lineNum">    1717 </span>                :                         }
<span class="lineNum">    1718 </span>                : 
<span class="lineNum">    1719 </span><span class="lineNoCov">              0 :                         for (value = low; value &gt;= (high - DOUBLE_DRIFT_FIX); value = low - (++i * step)) {</span>
<span class="lineNum">    1720 </span><span class="lineNoCov">              0 :                                 add_next_index_double(return_value, value);</span>
<span class="lineNum">    1721 </span>                :                         }
<span class="lineNum">    1722 </span><span class="lineNoCov">              0 :                 } else if (high &gt; low) {     /* Positive steps */</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">              0 :                         if (high - low &lt; step || step &lt;= 0) {</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">              0 :                                 err = 1;</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">              0 :                                 goto err;</span>
<span class="lineNum">    1726 </span>                :                         }
<span class="lineNum">    1727 </span>                : 
<span class="lineNum">    1728 </span><span class="lineNoCov">              0 :                         for (value = low; value &lt;= (high + DOUBLE_DRIFT_FIX); value = low + (++i * step)) {</span>
<span class="lineNum">    1729 </span><span class="lineNoCov">              0 :                                 add_next_index_double(return_value, value);</span>
<span class="lineNum">    1730 </span>                :                         }
<span class="lineNum">    1731 </span>                :                 } else {
<span class="lineNum">    1732 </span><span class="lineNoCov">              0 :                         add_next_index_double(return_value, low);</span>
<span class="lineNum">    1733 </span>                :                 }
<span class="lineNum">    1734 </span>                :         } else {
<span class="lineNum">    1735 </span>                :                 double low, high;
<span class="lineNum">    1736 </span>                :                 long lstep;
<span class="lineNum">    1737 </span>                : long_str:
<span class="lineNum">    1738 </span><span class="lineNoCov">              0 :                 convert_to_double(zlow);</span>
<span class="lineNum">    1739 </span><span class="lineNoCov">              0 :                 convert_to_double(zhigh);</span>
<span class="lineNum">    1740 </span><span class="lineNoCov">              0 :                 low = Z_DVAL_P(zlow);</span>
<span class="lineNum">    1741 </span><span class="lineNoCov">              0 :                 high = Z_DVAL_P(zhigh);</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">              0 :                 lstep = (long) step;</span>
<span class="lineNum">    1743 </span>                : 
<span class="lineNum">    1744 </span><span class="lineNoCov">              0 :                 if (low &gt; high) {            /* Negative steps */</span>
<span class="lineNum">    1745 </span><span class="lineNoCov">              0 :                         if (low - high &lt; lstep || lstep &lt;= 0) {</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">              0 :                                 err = 1;</span>
<span class="lineNum">    1747 </span><span class="lineNoCov">              0 :                                 goto err;</span>
<span class="lineNum">    1748 </span>                :                         }
<span class="lineNum">    1749 </span><span class="lineNoCov">              0 :                         for (; low &gt;= high; low -= lstep) {</span>
<span class="lineNum">    1750 </span><span class="lineNoCov">              0 :                                 add_next_index_long(return_value, (long)low);</span>
<span class="lineNum">    1751 </span>                :                         }
<span class="lineNum">    1752 </span><span class="lineNoCov">              0 :                 } else if (high &gt; low) {     /* Positive steps */</span>
<span class="lineNum">    1753 </span><span class="lineNoCov">              0 :                         if (high - low &lt; lstep || lstep &lt;= 0) {</span>
<span class="lineNum">    1754 </span><span class="lineNoCov">              0 :                                 err = 1;</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">              0 :                                 goto err;</span>
<span class="lineNum">    1756 </span>                :                         }
<span class="lineNum">    1757 </span><span class="lineNoCov">              0 :                         for (; low &lt;= high; low += lstep) {</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">              0 :                                 add_next_index_long(return_value, (long)low);</span>
<span class="lineNum">    1759 </span>                :                         }
<span class="lineNum">    1760 </span>                :                 } else {
<span class="lineNum">    1761 </span><span class="lineNoCov">              0 :                         add_next_index_long(return_value, (long)low);</span>
<span class="lineNum">    1762 </span>                :                 }
<span class="lineNum">    1763 </span>                :         }
<span class="lineNum">    1764 </span>                : err:
<span class="lineNum">    1765 </span><span class="lineNoCov">              0 :         if (err) {</span>
<span class="lineNum">    1766 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;step exceeds the specified range&quot;);</span>
<span class="lineNum">    1767 </span>                :                 zval_dtor(return_value);
<span class="lineNum">    1768 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    1769 </span>                :         }
<span class="lineNum">    1770 </span>                : }
<a name="1771"><span class="lineNum">    1771 </span>                : /* }}} */</a>
<span class="lineNum">    1772 </span>                : 
<span class="lineNum">    1773 </span><span class="lineNoCov">              0 : static void php_array_data_shuffle(zval *array TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    1774 </span>                : {
<span class="lineNum">    1775 </span>                :         Bucket **elems, *temp;
<span class="lineNum">    1776 </span>                :         HashTable *hash;
<span class="lineNum">    1777 </span>                :         int j, n_elems, rnd_idx, n_left;
<span class="lineNum">    1778 </span>                : 
<span class="lineNum">    1779 </span><span class="lineNoCov">              0 :         n_elems = zend_hash_num_elements(Z_ARRVAL_P(array));</span>
<span class="lineNum">    1780 </span>                : 
<span class="lineNum">    1781 </span><span class="lineNoCov">              0 :         if (n_elems &lt; 1) {</span>
<span class="lineNum">    1782 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1783 </span>                :         }
<span class="lineNum">    1784 </span>                : 
<span class="lineNum">    1785 </span><span class="lineNoCov">              0 :         elems = (Bucket **)safe_emalloc(n_elems, sizeof(Bucket *), 0);</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">              0 :         hash = Z_ARRVAL_P(array);</span>
<span class="lineNum">    1787 </span><span class="lineNoCov">              0 :         n_left = n_elems;</span>
<span class="lineNum">    1788 </span>                : 
<span class="lineNum">    1789 </span><span class="lineNoCov">              0 :         for (j = 0, temp = hash-&gt;pListHead; temp; temp = temp-&gt;pListNext)</span>
<span class="lineNum">    1790 </span><span class="lineNoCov">              0 :                 elems[j++] = temp;</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">              0 :         while (--n_left) {</span>
<span class="lineNum">    1792 </span><span class="lineNoCov">              0 :                 rnd_idx = php_rand(TSRMLS_C);</span>
<span class="lineNum">    1793 </span><span class="lineNoCov">              0 :                 RAND_RANGE(rnd_idx, 0, n_left, PHP_RAND_MAX);</span>
<span class="lineNum">    1794 </span><span class="lineNoCov">              0 :                 if (rnd_idx != n_left) {</span>
<span class="lineNum">    1795 </span><span class="lineNoCov">              0 :                         temp = elems[n_left];</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">              0 :                         elems[n_left] = elems[rnd_idx];</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">              0 :                         elems[rnd_idx] = temp;</span>
<span class="lineNum">    1798 </span>                :                 }
<span class="lineNum">    1799 </span>                :         }
<span class="lineNum">    1800 </span>                : 
<span class="lineNum">    1801 </span><span class="lineNoCov">              0 :         HANDLE_BLOCK_INTERRUPTIONS();</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">              0 :         hash-&gt;pListHead = elems[0];</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">              0 :         hash-&gt;pListTail = NULL;</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">              0 :         hash-&gt;pInternalPointer = hash-&gt;pListHead;</span>
<span class="lineNum">    1805 </span>                : 
<span class="lineNum">    1806 </span><span class="lineNoCov">              0 :         for (j = 0; j &lt; n_elems; j++) {</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">              0 :                 if (hash-&gt;pListTail) {</span>
<span class="lineNum">    1808 </span><span class="lineNoCov">              0 :                         hash-&gt;pListTail-&gt;pListNext = elems[j];</span>
<span class="lineNum">    1809 </span>                :                 }
<span class="lineNum">    1810 </span><span class="lineNoCov">              0 :                 elems[j]-&gt;pListLast = hash-&gt;pListTail;</span>
<span class="lineNum">    1811 </span><span class="lineNoCov">              0 :                 elems[j]-&gt;pListNext = NULL;</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">              0 :                 hash-&gt;pListTail = elems[j];</span>
<span class="lineNum">    1813 </span>                :         }
<span class="lineNum">    1814 </span><span class="lineNoCov">              0 :         temp = hash-&gt;pListHead;</span>
<span class="lineNum">    1815 </span><span class="lineNoCov">              0 :         j = 0;</span>
<span class="lineNum">    1816 </span><span class="lineNoCov">              0 :         while (temp != NULL) {</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">              0 :                 temp-&gt;nKeyLength = 0;</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">              0 :                 temp-&gt;h = j++;</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">              0 :                 temp = temp-&gt;pListNext;</span>
<span class="lineNum">    1820 </span>                :         }
<span class="lineNum">    1821 </span><span class="lineNoCov">              0 :         hash-&gt;nNextFreeElement = n_elems;</span>
<span class="lineNum">    1822 </span><span class="lineNoCov">              0 :         zend_hash_rehash(hash);</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">              0 :         HANDLE_UNBLOCK_INTERRUPTIONS();</span>
<span class="lineNum">    1824 </span>                : 
<span class="lineNum">    1825 </span><span class="lineNoCov">              0 :         efree(elems);</span>
<span class="lineNum">    1826 </span>                : }
<span class="lineNum">    1827 </span>                : /* }}} */
<span class="lineNum">    1828 </span>                : 
<a name="1829"><span class="lineNum">    1829 </span>                : /* {{{ proto bool shuffle(array array_arg)</a>
<span class="lineNum">    1830 </span>                :    Randomly shuffle the contents of an array */
<span class="lineNum">    1831 </span><span class="lineNoCov">              0 : PHP_FUNCTION(shuffle)</span>
<span class="lineNum">    1832 </span>                : {
<span class="lineNum">    1833 </span>                :         zval *array;
<span class="lineNum">    1834 </span>                : 
<span class="lineNum">    1835 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    1837 </span>                :         }
<span class="lineNum">    1838 </span>                : 
<span class="lineNum">    1839 </span><span class="lineNoCov">              0 :         php_array_data_shuffle(array TSRMLS_CC);</span>
<span class="lineNum">    1840 </span>                : 
<span class="lineNum">    1841 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">    1842 </span>                : }
<a name="1843"><span class="lineNum">    1843 </span>                : /* }}} */</a>
<span class="lineNum">    1844 </span>                : 
<span class="lineNum">    1845 </span><span class="lineNoCov">              0 : PHPAPI HashTable* php_splice(HashTable *in_hash, int offset, int length, zval ***list, int list_count, HashTable **removed) /* {{{ */</span>
<span class="lineNum">    1846 </span>                : {
<span class="lineNum">    1847 </span><span class="lineNoCov">              0 :         HashTable       *out_hash = NULL;       /* Output hashtable */</span>
<span class="lineNum">    1848 </span>                :         int                      num_in,                        /* Number of entries in the input hashtable */
<span class="lineNum">    1849 </span>                :                                  pos,                           /* Current position in the hashtable */
<span class="lineNum">    1850 </span>                :                                  i;                                     /* Loop counter */
<span class="lineNum">    1851 </span>                :         Bucket          *p;                                     /* Pointer to hash bucket */
<span class="lineNum">    1852 </span>                :         zval            *entry;                         /* Hash entry */
<span class="lineNum">    1853 </span>                : 
<span class="lineNum">    1854 </span>                :         /* If input hash doesn't exist, we have nothing to do */
<span class="lineNum">    1855 </span><span class="lineNoCov">              0 :         if (!in_hash) {</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">              0 :                 return NULL;</span>
<span class="lineNum">    1857 </span>                :         }
<span class="lineNum">    1858 </span>                : 
<span class="lineNum">    1859 </span>                :         /* Get number of entries in the input hash */
<span class="lineNum">    1860 </span><span class="lineNoCov">              0 :         num_in = zend_hash_num_elements(in_hash);</span>
<span class="lineNum">    1861 </span>                : 
<span class="lineNum">    1862 </span>                :         /* Clamp the offset.. */
<span class="lineNum">    1863 </span><span class="lineNoCov">              0 :         if (offset &gt; num_in) {</span>
<span class="lineNum">    1864 </span><span class="lineNoCov">              0 :                 offset = num_in;</span>
<span class="lineNum">    1865 </span><span class="lineNoCov">              0 :         } else if (offset &lt; 0 &amp;&amp; (offset = (num_in + offset)) &lt; 0) {</span>
<span class="lineNum">    1866 </span><span class="lineNoCov">              0 :                 offset = 0;</span>
<span class="lineNum">    1867 </span>                :         }
<span class="lineNum">    1868 </span>                : 
<span class="lineNum">    1869 </span>                :         /* ..and the length */
<span class="lineNum">    1870 </span><span class="lineNoCov">              0 :         if (length &lt; 0) {</span>
<span class="lineNum">    1871 </span><span class="lineNoCov">              0 :                 length = num_in - offset + length;</span>
<span class="lineNum">    1872 </span><span class="lineNoCov">              0 :         } else if (((unsigned)offset + (unsigned)length) &gt; (unsigned)num_in) {</span>
<span class="lineNum">    1873 </span><span class="lineNoCov">              0 :                 length = num_in - offset;</span>
<span class="lineNum">    1874 </span>                :         }
<span class="lineNum">    1875 </span>                : 
<span class="lineNum">    1876 </span>                :         /* Create and initialize output hash */
<span class="lineNum">    1877 </span><span class="lineNoCov">              0 :         ALLOC_HASHTABLE(out_hash);</span>
<span class="lineNum">    1878 </span><span class="lineNoCov">              0 :         zend_hash_init(out_hash, (length &gt; 0 ? num_in - length : 0) + list_count, NULL, ZVAL_PTR_DTOR, 0);</span>
<span class="lineNum">    1879 </span>                : 
<span class="lineNum">    1880 </span>                :         /* Start at the beginning of the input hash and copy entries to output hash until offset is reached */
<span class="lineNum">    1881 </span><span class="lineNoCov">              0 :         for (pos = 0, p = in_hash-&gt;pListHead; pos &lt; offset &amp;&amp; p ; pos++, p = p-&gt;pListNext) {</span>
<span class="lineNum">    1882 </span>                :                 /* Get entry and increase reference count */
<span class="lineNum">    1883 </span><span class="lineNoCov">              0 :                 entry = *((zval **)p-&gt;pData);</span>
<span class="lineNum">    1884 </span><span class="lineNoCov">              0 :                 Z_ADDREF_P(entry);</span>
<span class="lineNum">    1885 </span>                : 
<span class="lineNum">    1886 </span>                :                 /* Update output hash depending on key type */
<span class="lineNum">    1887 </span><span class="lineNoCov">              0 :                 if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">              0 :                         zend_hash_next_index_insert(out_hash, &amp;entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1889 </span>                :                 } else {
<span class="lineNum">    1890 </span><span class="lineNoCov">              0 :                         zend_hash_quick_update(out_hash, p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h, &amp;entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1891 </span>                :                 }
<span class="lineNum">    1892 </span>                :         }
<span class="lineNum">    1893 </span>                : 
<span class="lineNum">    1894 </span>                :         /* If hash for removed entries exists, go until offset+length and copy the entries to it */
<span class="lineNum">    1895 </span><span class="lineNoCov">              0 :         if (removed != NULL) {</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">              0 :                 for ( ; pos &lt; offset + length &amp;&amp; p; pos++, p = p-&gt;pListNext) {</span>
<span class="lineNum">    1897 </span><span class="lineNoCov">              0 :                         entry = *((zval **)p-&gt;pData);</span>
<span class="lineNum">    1898 </span><span class="lineNoCov">              0 :                         Z_ADDREF_P(entry);</span>
<span class="lineNum">    1899 </span><span class="lineNoCov">              0 :                         if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">              0 :                                 zend_hash_next_index_insert(*removed, &amp;entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1901 </span>                :                         } else {
<span class="lineNum">    1902 </span><span class="lineNoCov">              0 :                                 zend_hash_quick_update(*removed, p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h, &amp;entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1903 </span>                :                         }
<span class="lineNum">    1904 </span>                :                 }
<span class="lineNum">    1905 </span>                :         } else { /* otherwise just skip those entries */
<span class="lineNum">    1906 </span><span class="lineNoCov">              0 :                 for ( ; pos &lt; offset + length &amp;&amp; p; pos++, p = p-&gt;pListNext);</span>
<span class="lineNum">    1907 </span>                :         }
<span class="lineNum">    1908 </span>                : 
<span class="lineNum">    1909 </span>                :         /* If there are entries to insert.. */
<span class="lineNum">    1910 </span><span class="lineNoCov">              0 :         if (list != NULL) {</span>
<span class="lineNum">    1911 </span>                :                 /* ..for each one, create a new zval, copy entry into it and copy it into the output hash */
<span class="lineNum">    1912 </span><span class="lineNoCov">              0 :                 for (i = 0; i &lt; list_count; i++) {</span>
<span class="lineNum">    1913 </span><span class="lineNoCov">              0 :                         entry = *list[i];</span>
<span class="lineNum">    1914 </span><span class="lineNoCov">              0 :                         Z_ADDREF_P(entry);</span>
<span class="lineNum">    1915 </span><span class="lineNoCov">              0 :                         zend_hash_next_index_insert(out_hash, &amp;entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1916 </span>                :                 }
<span class="lineNum">    1917 </span>                :         }
<span class="lineNum">    1918 </span>                : 
<span class="lineNum">    1919 </span>                :         /* Copy the remaining input hash entries to the output hash */
<span class="lineNum">    1920 </span><span class="lineNoCov">              0 :         for ( ; p ; p = p-&gt;pListNext) {</span>
<span class="lineNum">    1921 </span><span class="lineNoCov">              0 :                 entry = *((zval **)p-&gt;pData);</span>
<span class="lineNum">    1922 </span><span class="lineNoCov">              0 :                 Z_ADDREF_P(entry);</span>
<span class="lineNum">    1923 </span><span class="lineNoCov">              0 :                 if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">              0 :                         zend_hash_next_index_insert(out_hash, &amp;entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1925 </span>                :                 } else {
<span class="lineNum">    1926 </span><span class="lineNoCov">              0 :                         zend_hash_quick_update(out_hash, p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h, &amp;entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    1927 </span>                :                 }
<span class="lineNum">    1928 </span>                :         }
<span class="lineNum">    1929 </span>                : 
<span class="lineNum">    1930 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset(out_hash);</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">              0 :         return out_hash;</span>
<span class="lineNum">    1932 </span>                : }
<span class="lineNum">    1933 </span>                : /* }}} */
<span class="lineNum">    1934 </span>                : 
<a name="1935"><span class="lineNum">    1935 </span>                : /* {{{ proto int array_push(array stack, mixed var [, mixed ...])</a>
<span class="lineNum">    1936 </span>                :    Pushes elements onto the end of the array */
<span class="lineNum">    1937 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_push)</span>
<span class="lineNum">    1938 </span>                : {
<span class="lineNum">    1939 </span>                :         zval ***args,           /* Function arguments array */
<span class="lineNum">    1940 </span>                :                    *stack,              /* Input array */
<span class="lineNum">    1941 </span>                :                    *new_var;    /* Variable to be pushed */
<span class="lineNum">    1942 </span>                :         int i,                          /* Loop counter */
<span class="lineNum">    1943 </span>                :                 argc;                   /* Number of function arguments */
<span class="lineNum">    1944 </span>                : 
<span class="lineNum">    1945 </span>                : 
<span class="lineNum">    1946 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a+&quot;, &amp;stack, &amp;args, &amp;argc) == FAILURE) {</span>
<span class="lineNum">    1947 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1948 </span>                :         }
<span class="lineNum">    1949 </span>                : 
<span class="lineNum">    1950 </span>                :         /* For each subsequent argument, make it a reference, increase refcount, and add it to the end of the array */
<span class="lineNum">    1951 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; argc; i++) {</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">              0 :                 new_var = *args[i];</span>
<span class="lineNum">    1953 </span><span class="lineNoCov">              0 :                 Z_ADDREF_P(new_var);</span>
<span class="lineNum">    1954 </span>                : 
<span class="lineNum">    1955 </span><span class="lineNoCov">              0 :                 if (zend_hash_next_index_insert(Z_ARRVAL_P(stack), &amp;new_var, sizeof(zval *), NULL) == FAILURE) {</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">              0 :                         Z_DELREF_P(new_var);</span>
<span class="lineNum">    1957 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Cannot add element to the array as the next element is already occupied&quot;);</span>
<span class="lineNum">    1958 </span><span class="lineNoCov">              0 :                         efree(args);</span>
<span class="lineNum">    1959 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">    1960 </span>                :                 }
<span class="lineNum">    1961 </span>                :         }
<span class="lineNum">    1962 </span>                : 
<span class="lineNum">    1963 </span>                :         /* Clean up and return the number of values in the stack */
<span class="lineNum">    1964 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    1965 </span><span class="lineNoCov">              0 :         RETVAL_LONG(zend_hash_num_elements(Z_ARRVAL_P(stack)));</span>
<span class="lineNum">    1966 </span>                : }
<span class="lineNum">    1967 </span>                : /* }}} */
<a name="1968"><span class="lineNum">    1968 </span>                : </a>
<span class="lineNum">    1969 </span>                : /* {{{ void _phpi_pop(INTERNAL_FUNCTION_PARAMETERS, int off_the_end) */
<span class="lineNum">    1970 </span><span class="lineNoCov">              0 : static void _phpi_pop(INTERNAL_FUNCTION_PARAMETERS, int off_the_end)</span>
<span class="lineNum">    1971 </span>                : {
<span class="lineNum">    1972 </span>                :         zval *stack,    /* Input stack */
<span class="lineNum">    1973 </span>                :                  **val;         /* Value to be popped */
<span class="lineNum">    1974 </span><span class="lineNoCov">              0 :         char *key = NULL;</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">              0 :         uint key_len = 0;</span>
<span class="lineNum">    1976 </span>                :         ulong index;
<span class="lineNum">    1977 </span>                : 
<span class="lineNum">    1978 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;stack) == FAILURE) {</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1980 </span>                :         }
<span class="lineNum">    1981 </span>                : 
<span class="lineNum">    1982 </span><span class="lineNoCov">              0 :         if (zend_hash_num_elements(Z_ARRVAL_P(stack)) == 0) {</span>
<span class="lineNum">    1983 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    1984 </span>                :         }
<span class="lineNum">    1985 </span>                : 
<span class="lineNum">    1986 </span>                :         /* Get the first or last value and copy it into the return value */
<span class="lineNum">    1987 </span><span class="lineNoCov">              0 :         if (off_the_end) {</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">              0 :                 zend_hash_internal_pointer_end(Z_ARRVAL_P(stack));</span>
<span class="lineNum">    1989 </span>                :         } else {
<span class="lineNum">    1990 </span><span class="lineNoCov">              0 :                 zend_hash_internal_pointer_reset(Z_ARRVAL_P(stack));</span>
<span class="lineNum">    1991 </span>                :         }
<span class="lineNum">    1992 </span><span class="lineNoCov">              0 :         zend_hash_get_current_data(Z_ARRVAL_P(stack), (void **)&amp;val);</span>
<span class="lineNum">    1993 </span><span class="lineNoCov">              0 :         RETVAL_ZVAL(*val, 1, 0);</span>
<span class="lineNum">    1994 </span>                : 
<span class="lineNum">    1995 </span>                :         /* Delete the first or last value */
<span class="lineNum">    1996 </span><span class="lineNoCov">              0 :         zend_hash_get_current_key_ex(Z_ARRVAL_P(stack), &amp;key, &amp;key_len, &amp;index, 0, NULL);</span>
<span class="lineNum">    1997 </span><span class="lineNoCov">              0 :         if (key &amp;&amp; Z_ARRVAL_P(stack) == &amp;EG(symbol_table)) {</span>
<span class="lineNum">    1998 </span><span class="lineNoCov">              0 :                 zend_delete_global_variable(key, key_len - 1 TSRMLS_CC);</span>
<span class="lineNum">    1999 </span>                :         } else {
<span class="lineNum">    2000 </span><span class="lineNoCov">              0 :                 zend_hash_del_key_or_index(Z_ARRVAL_P(stack), key, key_len, index, (key) ? HASH_DEL_KEY : HASH_DEL_INDEX);</span>
<span class="lineNum">    2001 </span>                :         }
<span class="lineNum">    2002 </span>                : 
<span class="lineNum">    2003 </span>                :         /* If we did a shift... re-index like it did before */
<span class="lineNum">    2004 </span><span class="lineNoCov">              0 :         if (!off_the_end) {</span>
<span class="lineNum">    2005 </span><span class="lineNoCov">              0 :                 unsigned int k = 0;</span>
<span class="lineNum">    2006 </span><span class="lineNoCov">              0 :                 int should_rehash = 0;</span>
<span class="lineNum">    2007 </span><span class="lineNoCov">              0 :                 Bucket *p = Z_ARRVAL_P(stack)-&gt;pListHead;</span>
<span class="lineNum">    2008 </span><span class="lineNoCov">              0 :                 while (p != NULL) {</span>
<span class="lineNum">    2009 </span><span class="lineNoCov">              0 :                         if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    2010 </span><span class="lineNoCov">              0 :                                 if (p-&gt;h != k) {</span>
<span class="lineNum">    2011 </span><span class="lineNoCov">              0 :                                         p-&gt;h = k++;</span>
<span class="lineNum">    2012 </span><span class="lineNoCov">              0 :                                         should_rehash = 1;</span>
<span class="lineNum">    2013 </span>                :                                 } else {
<span class="lineNum">    2014 </span><span class="lineNoCov">              0 :                                         k++;</span>
<span class="lineNum">    2015 </span>                :                                 }
<span class="lineNum">    2016 </span>                :                         }
<span class="lineNum">    2017 </span><span class="lineNoCov">              0 :                         p = p-&gt;pListNext;</span>
<span class="lineNum">    2018 </span>                :                 }
<span class="lineNum">    2019 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_P(stack)-&gt;nNextFreeElement = k;</span>
<span class="lineNum">    2020 </span><span class="lineNoCov">              0 :                 if (should_rehash) {</span>
<span class="lineNum">    2021 </span><span class="lineNoCov">              0 :                         zend_hash_rehash(Z_ARRVAL_P(stack));</span>
<span class="lineNum">    2022 </span>                :                 }
<span class="lineNum">    2023 </span><span class="lineNoCov">              0 :         } else if (!key_len &amp;&amp; index &gt;= Z_ARRVAL_P(stack)-&gt;nNextFreeElement - 1) {</span>
<span class="lineNum">    2024 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_P(stack)-&gt;nNextFreeElement = Z_ARRVAL_P(stack)-&gt;nNextFreeElement - 1;</span>
<span class="lineNum">    2025 </span>                :         }
<span class="lineNum">    2026 </span>                : 
<span class="lineNum">    2027 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset(Z_ARRVAL_P(stack));</span>
<span class="lineNum">    2028 </span>                : }
<span class="lineNum">    2029 </span>                : /* }}} */
<span class="lineNum">    2030 </span>                : 
<a name="2031"><span class="lineNum">    2031 </span>                : /* {{{ proto mixed array_pop(array stack)</a>
<span class="lineNum">    2032 </span>                :    Pops an element off the end of the array */
<span class="lineNum">    2033 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_pop)</span>
<span class="lineNum">    2034 </span>                : {
<span class="lineNum">    2035 </span><span class="lineNoCov">              0 :         _phpi_pop(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1);</span>
<span class="lineNum">    2036 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    2037 </span>                : /* }}} */
<span class="lineNum">    2038 </span>                : 
<a name="2039"><span class="lineNum">    2039 </span>                : /* {{{ proto mixed array_shift(array stack)</a>
<span class="lineNum">    2040 </span>                :    Pops an element off the beginning of the array */
<span class="lineNum">    2041 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_shift)</span>
<span class="lineNum">    2042 </span>                : {
<span class="lineNum">    2043 </span><span class="lineNoCov">              0 :         _phpi_pop(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0);</span>
<span class="lineNum">    2044 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    2045 </span>                : /* }}} */
<span class="lineNum">    2046 </span>                : 
<a name="2047"><span class="lineNum">    2047 </span>                : /* {{{ proto int array_unshift(array stack, mixed var [, mixed ...])</a>
<span class="lineNum">    2048 </span>                :    Pushes elements onto the beginning of the array */
<span class="lineNum">    2049 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_unshift)</span>
<span class="lineNum">    2050 </span>                : {
<span class="lineNum">    2051 </span>                :         zval ***args,                   /* Function arguments array */
<span class="lineNum">    2052 </span>                :                    *stack;                      /* Input stack */
<span class="lineNum">    2053 </span>                :         HashTable *new_hash;    /* New hashtable for the stack */
<span class="lineNum">    2054 </span>                :         HashTable  old_hash;
<span class="lineNum">    2055 </span>                :         int argc;                               /* Number of function arguments */
<span class="lineNum">    2056 </span>                :         
<span class="lineNum">    2057 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a+&quot;, &amp;stack, &amp;args, &amp;argc) == FAILURE) {</span>
<span class="lineNum">    2058 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2059 </span>                :         }
<span class="lineNum">    2060 </span>                : 
<span class="lineNum">    2061 </span>                :         /* Use splice to insert the elements at the beginning. Destroy old
<span class="lineNum">    2062 </span>                :          * hashtable and replace it with new one */
<span class="lineNum">    2063 </span><span class="lineNoCov">              0 :         new_hash = php_splice(Z_ARRVAL_P(stack), 0, 0, &amp;args[0], argc, NULL);</span>
<span class="lineNum">    2064 </span><span class="lineNoCov">              0 :         old_hash = *Z_ARRVAL_P(stack);</span>
<span class="lineNum">    2065 </span><span class="lineNoCov">              0 :         if (Z_ARRVAL_P(stack) == &amp;EG(symbol_table)) {</span>
<span class="lineNum">    2066 </span><span class="lineNoCov">              0 :                 zend_reset_all_cv(&amp;EG(symbol_table) TSRMLS_CC);</span>
<span class="lineNum">    2067 </span>                :         }
<span class="lineNum">    2068 </span><span class="lineNoCov">              0 :         *Z_ARRVAL_P(stack) = *new_hash;</span>
<span class="lineNum">    2069 </span><span class="lineNoCov">              0 :         FREE_HASHTABLE(new_hash);</span>
<span class="lineNum">    2070 </span><span class="lineNoCov">              0 :         zend_hash_destroy(&amp;old_hash);</span>
<span class="lineNum">    2071 </span>                : 
<span class="lineNum">    2072 </span>                :         /* Clean up and return the number of elements in the stack */
<span class="lineNum">    2073 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">              0 :         RETVAL_LONG(zend_hash_num_elements(Z_ARRVAL_P(stack)));</span>
<span class="lineNum">    2075 </span>                : }
<span class="lineNum">    2076 </span>                : /* }}} */
<span class="lineNum">    2077 </span>                : 
<a name="2078"><span class="lineNum">    2078 </span>                : /* {{{ proto array array_splice(array input, int offset [, int length [, array replacement]])</a>
<span class="lineNum">    2079 </span>                :    Removes the elements designated by offset and length and replace them with supplied array */
<span class="lineNum">    2080 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_splice)</span>
<span class="lineNum">    2081 </span>                : {
<span class="lineNum">    2082 </span>                :         zval *array,                            /* Input array */
<span class="lineNum">    2083 </span><span class="lineNoCov">              0 :                  *repl_array = NULL,    /* Replacement array */</span>
<span class="lineNum">    2084 </span><span class="lineNoCov">              0 :                  ***repl = NULL;                /* Replacement elements */</span>
<span class="lineNum">    2085 </span><span class="lineNoCov">              0 :         HashTable *new_hash = NULL,     /* Output array's hash */</span>
<span class="lineNum">    2086 </span><span class="lineNoCov">              0 :                  **rem_hash = NULL;     /* Removed elements' hash */</span>
<span class="lineNum">    2087 </span>                :         HashTable  old_hash;
<span class="lineNum">    2088 </span>                :         Bucket *p;                                      /* Bucket used for traversing hash */
<span class="lineNum">    2089 </span>                :         long    i,
<span class="lineNum">    2090 </span>                :                         offset,
<span class="lineNum">    2091 </span><span class="lineNoCov">              0 :                         length = 0,</span>
<span class="lineNum">    2092 </span><span class="lineNoCov">              0 :                         repl_num = 0;           /* Number of replacement elements */</span>
<span class="lineNum">    2093 </span>                :         int             num_in;                         /* Number of elements in the input array */
<span class="lineNum">    2094 </span>                : 
<span class="lineNum">    2095 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;al|lz/&quot;, &amp;array, &amp;offset, &amp;length, &amp;repl_array) == FAILURE) {</span>
<span class="lineNum">    2096 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2097 </span>                :         }
<span class="lineNum">    2098 </span>                : 
<span class="lineNum">    2099 </span><span class="lineNoCov">              0 :         num_in = zend_hash_num_elements(Z_ARRVAL_P(array));</span>
<span class="lineNum">    2100 </span>                : 
<span class="lineNum">    2101 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() &lt; 3) {</span>
<span class="lineNum">    2102 </span><span class="lineNoCov">              0 :                 length = num_in;</span>
<span class="lineNum">    2103 </span>                :         }
<span class="lineNum">    2104 </span>                : 
<span class="lineNum">    2105 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() == 4) {</span>
<span class="lineNum">    2106 </span>                :                 /* Make sure the last argument, if passed, is an array */
<span class="lineNum">    2107 </span><span class="lineNoCov">              0 :                 convert_to_array(repl_array);</span>
<span class="lineNum">    2108 </span>                : 
<span class="lineNum">    2109 </span>                :                 /* Create the array of replacement elements */
<span class="lineNum">    2110 </span><span class="lineNoCov">              0 :                 repl_num = zend_hash_num_elements(Z_ARRVAL_P(repl_array));</span>
<span class="lineNum">    2111 </span><span class="lineNoCov">              0 :                 repl = (zval ***)safe_emalloc(repl_num, sizeof(zval **), 0);</span>
<span class="lineNum">    2112 </span><span class="lineNoCov">              0 :                 for (p = Z_ARRVAL_P(repl_array)-&gt;pListHead, i = 0; p; p = p-&gt;pListNext, i++) {</span>
<span class="lineNum">    2113 </span><span class="lineNoCov">              0 :                         repl[i] = ((zval **)p-&gt;pData);</span>
<span class="lineNum">    2114 </span>                :                 }
<span class="lineNum">    2115 </span>                :         }
<span class="lineNum">    2116 </span>                : 
<span class="lineNum">    2117 </span>                :         /* Don't create the array of removed elements if it's not going
<span class="lineNum">    2118 </span>                :          * to be used; e.g. only removing and/or replacing elements */
<span class="lineNum">    2119 </span><span class="lineNoCov">              0 :         if (return_value_used) {</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">              0 :                 int size = length;</span>
<span class="lineNum">    2121 </span>                : 
<span class="lineNum">    2122 </span>                :                 /* Clamp the offset.. */
<span class="lineNum">    2123 </span><span class="lineNoCov">              0 :                 if (offset &gt; num_in) {</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">              0 :                         offset = num_in;</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">              0 :                 } else if (offset &lt; 0 &amp;&amp; (offset = (num_in + offset)) &lt; 0) {</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">              0 :                         offset = 0;</span>
<span class="lineNum">    2127 </span>                :                 }
<span class="lineNum">    2128 </span>                : 
<span class="lineNum">    2129 </span>                :                 /* ..and the length */
<span class="lineNum">    2130 </span><span class="lineNoCov">              0 :                 if (length &lt; 0) {</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">              0 :                         size = num_in - offset + length;</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">              0 :                 } else if (((unsigned long) offset + (unsigned long) length) &gt; (unsigned) num_in) {</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">              0 :                         size = num_in - offset;</span>
<span class="lineNum">    2134 </span>                :                 }
<span class="lineNum">    2135 </span>                : 
<span class="lineNum">    2136 </span>                :                 /* Initialize return value */
<span class="lineNum">    2137 </span><span class="lineNoCov">              0 :                 array_init_size(return_value, size &gt; 0 ? size : 0);</span>
<span class="lineNum">    2138 </span><span class="lineNoCov">              0 :                 rem_hash = &amp;Z_ARRVAL_P(return_value);</span>
<span class="lineNum">    2139 </span>                :         }
<span class="lineNum">    2140 </span>                : 
<span class="lineNum">    2141 </span>                :         /* Perform splice */
<span class="lineNum">    2142 </span><span class="lineNoCov">              0 :         new_hash = php_splice(Z_ARRVAL_P(array), offset, length, repl, repl_num, rem_hash);</span>
<span class="lineNum">    2143 </span>                : 
<span class="lineNum">    2144 </span>                :         /* Replace input array's hashtable with the new one */
<span class="lineNum">    2145 </span><span class="lineNoCov">              0 :         old_hash = *Z_ARRVAL_P(array);</span>
<span class="lineNum">    2146 </span><span class="lineNoCov">              0 :         if (Z_ARRVAL_P(array) == &amp;EG(symbol_table)) {</span>
<span class="lineNum">    2147 </span><span class="lineNoCov">              0 :                 zend_reset_all_cv(&amp;EG(symbol_table) TSRMLS_CC);</span>
<span class="lineNum">    2148 </span>                :         }
<span class="lineNum">    2149 </span><span class="lineNoCov">              0 :         *Z_ARRVAL_P(array) = *new_hash;</span>
<span class="lineNum">    2150 </span><span class="lineNoCov">              0 :         FREE_HASHTABLE(new_hash);</span>
<span class="lineNum">    2151 </span><span class="lineNoCov">              0 :         zend_hash_destroy(&amp;old_hash);</span>
<span class="lineNum">    2152 </span>                : 
<span class="lineNum">    2153 </span>                :         /* Clean up */
<span class="lineNum">    2154 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() == 4) {</span>
<span class="lineNum">    2155 </span><span class="lineNoCov">              0 :                 efree(repl);</span>
<span class="lineNum">    2156 </span>                :         }
<span class="lineNum">    2157 </span>                : }
<span class="lineNum">    2158 </span>                : /* }}} */
<span class="lineNum">    2159 </span>                : 
<a name="2160"><span class="lineNum">    2160 </span>                : /* {{{ proto array array_slice(array input, int offset [, int length [, bool preserve_keys]])</a>
<span class="lineNum">    2161 </span>                :    Returns elements specified by offset and length */
<span class="lineNum">    2162 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_slice)</span>
<span class="lineNum">    2163 </span>                : {
<span class="lineNum">    2164 </span>                :         zval     *input,                /* Input array */
<span class="lineNum">    2165 </span><span class="lineNoCov">              0 :                         **z_length = NULL, /* How many elements to get */ </span>
<span class="lineNum">    2166 </span>                :                         **entry;                /* An array entry */
<span class="lineNum">    2167 </span>                :         long     offset,                /* Offset to get elements from */
<span class="lineNum">    2168 </span><span class="lineNoCov">              0 :                          length = 0;    </span>
<span class="lineNum">    2169 </span><span class="lineNoCov">              0 :         zend_bool preserve_keys = 0; /* Whether to preserve keys while copying to the new array or not */</span>
<span class="lineNum">    2170 </span>                :         int              num_in,                /* Number of elements in the input array */
<span class="lineNum">    2171 </span>                :                          pos;                   /* Current position in the array */
<span class="lineNum">    2172 </span>                :         char *string_key;
<span class="lineNum">    2173 </span>                :         uint string_key_len;
<span class="lineNum">    2174 </span>                :         ulong num_key;
<span class="lineNum">    2175 </span>                :         HashPosition hpos;
<span class="lineNum">    2176 </span>                : 
<span class="lineNum">    2177 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;al|Zb&quot;, &amp;input, &amp;offset, &amp;z_length, &amp;preserve_keys) == FAILURE) {</span>
<span class="lineNum">    2178 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2179 </span>                :         }
<span class="lineNum">    2180 </span>                : 
<span class="lineNum">    2181 </span>                :         /* Get number of entries in the input hash */
<span class="lineNum">    2182 </span><span class="lineNoCov">              0 :         num_in = zend_hash_num_elements(Z_ARRVAL_P(input));</span>
<span class="lineNum">    2183 </span>                : 
<span class="lineNum">    2184 </span>                :         /* We want all entries from offset to the end if length is not passed or is null */
<span class="lineNum">    2185 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() &lt; 3 || Z_TYPE_PP(z_length) == IS_NULL) {</span>
<span class="lineNum">    2186 </span><span class="lineNoCov">              0 :                 length = num_in;</span>
<span class="lineNum">    2187 </span>                :         } else {
<span class="lineNum">    2188 </span><span class="lineNoCov">              0 :                 convert_to_long_ex(z_length);</span>
<span class="lineNum">    2189 </span><span class="lineNoCov">              0 :                 length = Z_LVAL_PP(z_length);</span>
<span class="lineNum">    2190 </span>                :         }
<span class="lineNum">    2191 </span>                : 
<span class="lineNum">    2192 </span>                :         /* Clamp the offset.. */
<span class="lineNum">    2193 </span><span class="lineNoCov">              0 :         if (offset &gt; num_in) {</span>
<span class="lineNum">    2194 </span><span class="lineNoCov">              0 :                 array_init(return_value);</span>
<span class="lineNum">    2195 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2196 </span><span class="lineNoCov">              0 :         } else if (offset &lt; 0 &amp;&amp; (offset = (num_in + offset)) &lt; 0) {</span>
<span class="lineNum">    2197 </span><span class="lineNoCov">              0 :                 offset = 0;</span>
<span class="lineNum">    2198 </span>                :         }
<span class="lineNum">    2199 </span>                : 
<span class="lineNum">    2200 </span>                :         /* ..and the length */
<span class="lineNum">    2201 </span><span class="lineNoCov">              0 :         if (length &lt; 0) {</span>
<span class="lineNum">    2202 </span><span class="lineNoCov">              0 :                 length = num_in - offset + length;</span>
<span class="lineNum">    2203 </span><span class="lineNoCov">              0 :         } else if (((unsigned long) offset + (unsigned long) length) &gt; (unsigned) num_in) {</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">              0 :                 length = num_in - offset;</span>
<span class="lineNum">    2205 </span>                :         }
<span class="lineNum">    2206 </span>                : 
<span class="lineNum">    2207 </span>                :         /* Initialize returned array */
<span class="lineNum">    2208 </span><span class="lineNoCov">              0 :         array_init_size(return_value, length &gt; 0 ? length : 0);</span>
<span class="lineNum">    2209 </span>                : 
<span class="lineNum">    2210 </span><span class="lineNoCov">              0 :         if (length &lt;= 0) {</span>
<span class="lineNum">    2211 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2212 </span>                :         }
<span class="lineNum">    2213 </span>                : 
<span class="lineNum">    2214 </span>                :         /* Start at the beginning and go until we hit offset */
<span class="lineNum">    2215 </span><span class="lineNoCov">              0 :         pos = 0;</span>
<span class="lineNum">    2216 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(input), &amp;hpos);</span>
<span class="lineNum">    2217 </span><span class="lineNoCov">              0 :         while (pos &lt; offset &amp;&amp; zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void **)&amp;entry, &amp;hpos) == SUCCESS) {</span>
<span class="lineNum">    2218 </span><span class="lineNoCov">              0 :                 pos++;</span>
<span class="lineNum">    2219 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;hpos);</span>
<span class="lineNum">    2220 </span>                :         }
<span class="lineNum">    2221 </span>                : 
<span class="lineNum">    2222 </span>                :         /* Copy elements from input array to the one that's returned */
<span class="lineNum">    2223 </span><span class="lineNoCov">              0 :         while (pos &lt; offset + length &amp;&amp; zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void **)&amp;entry, &amp;hpos) == SUCCESS) {</span>
<span class="lineNum">    2224 </span>                : 
<span class="lineNum">    2225 </span><span class="lineNoCov">              0 :                 zval_add_ref(entry);</span>
<span class="lineNum">    2226 </span>                : 
<span class="lineNum">    2227 </span><span class="lineNoCov">              0 :                 switch (zend_hash_get_current_key_ex(Z_ARRVAL_P(input), &amp;string_key, &amp;string_key_len, &amp;num_key, 0, &amp;hpos)) {</span>
<span class="lineNum">    2228 </span>                :                         case HASH_KEY_IS_STRING:
<span class="lineNum">    2229 </span><span class="lineNoCov">              0 :                                 zend_hash_update(Z_ARRVAL_P(return_value), string_key, string_key_len, entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2230 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    2231 </span>                : 
<span class="lineNum">    2232 </span>                :                         case HASH_KEY_IS_LONG:
<span class="lineNum">    2233 </span><span class="lineNoCov">              0 :                                 if (preserve_keys) {</span>
<span class="lineNum">    2234 </span><span class="lineNoCov">              0 :                                         zend_hash_index_update(Z_ARRVAL_P(return_value), num_key, entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2235 </span>                :                                 } else {
<span class="lineNum">    2236 </span><span class="lineNoCov">              0 :                                         zend_hash_next_index_insert(Z_ARRVAL_P(return_value), entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2237 </span>                :                                 }
<span class="lineNum">    2238 </span>                :                                 break;
<span class="lineNum">    2239 </span>                :                 }
<span class="lineNum">    2240 </span><span class="lineNoCov">              0 :                 pos++;</span>
<span class="lineNum">    2241 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;hpos);</span>
<span class="lineNum">    2242 </span>                :         }
<span class="lineNum">    2243 </span>                : }
<a name="2244"><span class="lineNum">    2244 </span>                : /* }}} */</a>
<span class="lineNum">    2245 </span>                : 
<span class="lineNum">    2246 </span><span class="lineCov">              2 : PHPAPI int php_array_merge(HashTable *dest, HashTable *src, int recursive TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    2247 </span>                : {
<span class="lineNum">    2248 </span>                :         zval **src_entry, **dest_entry;
<span class="lineNum">    2249 </span>                :         char *string_key;
<span class="lineNum">    2250 </span>                :         uint string_key_len;
<span class="lineNum">    2251 </span>                :         ulong num_key;
<span class="lineNum">    2252 </span>                :         HashPosition pos;
<span class="lineNum">    2253 </span>                : 
<span class="lineNum">    2254 </span><span class="lineCov">              2 :         zend_hash_internal_pointer_reset_ex(src, &amp;pos);</span>
<span class="lineNum">    2255 </span><span class="lineCov">             46 :         while (zend_hash_get_current_data_ex(src, (void **)&amp;src_entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    2256 </span><span class="lineCov">             42 :                 switch (zend_hash_get_current_key_ex(src, &amp;string_key, &amp;string_key_len, &amp;num_key, 0, &amp;pos)) {</span>
<span class="lineNum">    2257 </span>                :                         case HASH_KEY_IS_STRING:
<span class="lineNum">    2258 </span><span class="lineNoCov">              0 :                                 if (recursive &amp;&amp; zend_hash_find(dest, string_key, string_key_len, (void **)&amp;dest_entry) == SUCCESS) {</span>
<span class="lineNum">    2259 </span><span class="lineNoCov">              0 :                                         HashTable *thash = Z_TYPE_PP(dest_entry) == IS_ARRAY ? Z_ARRVAL_PP(dest_entry) : NULL;</span>
<span class="lineNum">    2260 </span>                : 
<span class="lineNum">    2261 </span><span class="lineNoCov">              0 :                                         if ((thash &amp;&amp; thash-&gt;nApplyCount &gt; 1) || (*src_entry == *dest_entry &amp;&amp; Z_ISREF_PP(dest_entry) &amp;&amp; (Z_REFCOUNT_PP(dest_entry) % 2))) {</span>
<span class="lineNum">    2262 </span><span class="lineNoCov">              0 :                                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;recursion detected&quot;);</span>
<span class="lineNum">    2263 </span><span class="lineNoCov">              0 :                                                 return 0;</span>
<span class="lineNum">    2264 </span>                :                                         }
<span class="lineNum">    2265 </span><span class="lineNoCov">              0 :                                         SEPARATE_ZVAL(dest_entry);</span>
<span class="lineNum">    2266 </span><span class="lineNoCov">              0 :                                         SEPARATE_ZVAL(src_entry);</span>
<span class="lineNum">    2267 </span>                : 
<span class="lineNum">    2268 </span><span class="lineNoCov">              0 :                                         if (Z_TYPE_PP(dest_entry) == IS_NULL) {</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">              0 :                                                 convert_to_array_ex(dest_entry);</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">              0 :                                                 add_next_index_null(*dest_entry);</span>
<span class="lineNum">    2271 </span>                :                                         } else {
<span class="lineNum">    2272 </span><span class="lineNoCov">              0 :                                                 convert_to_array_ex(dest_entry);</span>
<span class="lineNum">    2273 </span>                :                                         }
<span class="lineNum">    2274 </span><span class="lineNoCov">              0 :                                         if (Z_TYPE_PP(src_entry) == IS_NULL) {</span>
<span class="lineNum">    2275 </span><span class="lineNoCov">              0 :                                                 convert_to_array_ex(src_entry);</span>
<span class="lineNum">    2276 </span><span class="lineNoCov">              0 :                                                 add_next_index_null(*src_entry);</span>
<span class="lineNum">    2277 </span>                :                                         } else {
<span class="lineNum">    2278 </span><span class="lineNoCov">              0 :                                                 convert_to_array_ex(src_entry);</span>
<span class="lineNum">    2279 </span>                :                                         }
<span class="lineNum">    2280 </span><span class="lineNoCov">              0 :                                         if (thash) {</span>
<span class="lineNum">    2281 </span><span class="lineNoCov">              0 :                                                 thash-&gt;nApplyCount++;</span>
<span class="lineNum">    2282 </span>                :                                         }
<span class="lineNum">    2283 </span><span class="lineNoCov">              0 :                                         if (!php_array_merge(Z_ARRVAL_PP(dest_entry), Z_ARRVAL_PP(src_entry), recursive TSRMLS_CC)) {</span>
<span class="lineNum">    2284 </span><span class="lineNoCov">              0 :                                                 if (thash) {</span>
<span class="lineNum">    2285 </span><span class="lineNoCov">              0 :                                                         thash-&gt;nApplyCount--;</span>
<span class="lineNum">    2286 </span>                :                                                 }
<span class="lineNum">    2287 </span><span class="lineNoCov">              0 :                                                 return 0;</span>
<span class="lineNum">    2288 </span>                :                                         }
<span class="lineNum">    2289 </span><span class="lineNoCov">              0 :                                         if (thash) {</span>
<span class="lineNum">    2290 </span><span class="lineNoCov">              0 :                                                 thash-&gt;nApplyCount--;</span>
<span class="lineNum">    2291 </span>                :                                         }
<span class="lineNum">    2292 </span>                :                                 } else {
<span class="lineNum">    2293 </span><span class="lineNoCov">              0 :                                         Z_ADDREF_PP(src_entry);</span>
<span class="lineNum">    2294 </span><span class="lineNoCov">              0 :                                         zend_hash_update(dest, string_key, string_key_len, src_entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2295 </span>                :                                 }
<span class="lineNum">    2296 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    2297 </span>                : 
<span class="lineNum">    2298 </span>                :                         case HASH_KEY_IS_LONG:
<span class="lineNum">    2299 </span><span class="lineCov">             42 :                                 Z_ADDREF_PP(src_entry);</span>
<span class="lineNum">    2300 </span><span class="lineCov">             42 :                                 zend_hash_next_index_insert(dest, src_entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2301 </span>                :                                 break;
<span class="lineNum">    2302 </span>                :                 }
<span class="lineNum">    2303 </span><span class="lineCov">             42 :                 zend_hash_move_forward_ex(src, &amp;pos);</span>
<span class="lineNum">    2304 </span>                :         }
<span class="lineNum">    2305 </span><span class="lineCov">              2 :         return 1;</span>
<span class="lineNum">    2306 </span>                : }
<a name="2307"><span class="lineNum">    2307 </span>                : /* }}} */</a>
<span class="lineNum">    2308 </span>                : 
<span class="lineNum">    2309 </span><span class="lineNoCov">              0 : PHPAPI int php_array_replace_recursive(HashTable *dest, HashTable *src TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    2310 </span>                : {
<span class="lineNum">    2311 </span>                :         zval **src_entry, **dest_entry;
<span class="lineNum">    2312 </span>                :         char *string_key;
<span class="lineNum">    2313 </span>                :         uint string_key_len;
<span class="lineNum">    2314 </span>                :         ulong num_key;
<span class="lineNum">    2315 </span>                :         HashPosition pos;
<span class="lineNum">    2316 </span>                : 
<span class="lineNum">    2317 </span><span class="lineNoCov">              0 :         for (zend_hash_internal_pointer_reset_ex(src, &amp;pos);</span>
<span class="lineNum">    2318 </span><span class="lineNoCov">              0 :              zend_hash_get_current_data_ex(src, (void **)&amp;src_entry, &amp;pos) == SUCCESS;</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">              0 :              zend_hash_move_forward_ex(src, &amp;pos)) {</span>
<span class="lineNum">    2320 </span><span class="lineNoCov">              0 :                 switch (zend_hash_get_current_key_ex(src, &amp;string_key, &amp;string_key_len, &amp;num_key, 0, &amp;pos)) {</span>
<span class="lineNum">    2321 </span>                :                         case HASH_KEY_IS_STRING:
<span class="lineNum">    2322 </span><span class="lineNoCov">              0 :                                 if (Z_TYPE_PP(src_entry) != IS_ARRAY ||</span>
<span class="lineNum">    2323 </span><span class="lineNoCov">              0 :                                         zend_hash_find(dest, string_key, string_key_len, (void **)&amp;dest_entry) == FAILURE ||</span>
<span class="lineNum">    2324 </span><span class="lineNoCov">              0 :                                         Z_TYPE_PP(dest_entry) != IS_ARRAY) {</span>
<span class="lineNum">    2325 </span>                : 
<span class="lineNum">    2326 </span><span class="lineNoCov">              0 :                                         Z_ADDREF_PP(src_entry);</span>
<span class="lineNum">    2327 </span><span class="lineNoCov">              0 :                                         zend_hash_update(dest, string_key, string_key_len, src_entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2328 </span>                : 
<span class="lineNum">    2329 </span><span class="lineNoCov">              0 :                                         continue;</span>
<span class="lineNum">    2330 </span>                :                                 }
<span class="lineNum">    2331 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    2332 </span>                : 
<span class="lineNum">    2333 </span>                :                         case HASH_KEY_IS_LONG:
<span class="lineNum">    2334 </span><span class="lineNoCov">              0 :                                 if (Z_TYPE_PP(src_entry) != IS_ARRAY ||</span>
<span class="lineNum">    2335 </span><span class="lineNoCov">              0 :                                         zend_hash_index_find(dest, num_key, (void **)&amp;dest_entry) == FAILURE ||</span>
<span class="lineNum">    2336 </span><span class="lineNoCov">              0 :                                         Z_TYPE_PP(dest_entry) != IS_ARRAY) {</span>
<span class="lineNum">    2337 </span>                : 
<span class="lineNum">    2338 </span><span class="lineNoCov">              0 :                                         Z_ADDREF_PP(src_entry);</span>
<span class="lineNum">    2339 </span><span class="lineNoCov">              0 :                                         zend_hash_index_update(dest, num_key, src_entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2340 </span>                : 
<span class="lineNum">    2341 </span><span class="lineNoCov">              0 :                                         continue;</span>
<span class="lineNum">    2342 </span>                :                                 }
<span class="lineNum">    2343 </span>                :                                 break;
<span class="lineNum">    2344 </span>                :                 }
<span class="lineNum">    2345 </span>                : 
<span class="lineNum">    2346 </span><span class="lineNoCov">              0 :                 if (Z_ARRVAL_PP(dest_entry)-&gt;nApplyCount &gt; 1 || Z_ARRVAL_PP(src_entry)-&gt;nApplyCount &gt; 1 || (*src_entry == *dest_entry &amp;&amp; Z_ISREF_PP(dest_entry) &amp;&amp; (Z_REFCOUNT_PP(dest_entry) % 2))) {</span>
<span class="lineNum">    2347 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;recursion detected&quot;);</span>
<span class="lineNum">    2348 </span><span class="lineNoCov">              0 :                         return 0;</span>
<span class="lineNum">    2349 </span>                :                 }
<span class="lineNum">    2350 </span><span class="lineNoCov">              0 :                 SEPARATE_ZVAL(dest_entry);</span>
<span class="lineNum">    2351 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_PP(dest_entry)-&gt;nApplyCount++;</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_PP(src_entry)-&gt;nApplyCount++;</span>
<span class="lineNum">    2353 </span>                :                 
<span class="lineNum">    2354 </span>                : 
<span class="lineNum">    2355 </span><span class="lineNoCov">              0 :                 if (!php_array_replace_recursive(Z_ARRVAL_PP(dest_entry), Z_ARRVAL_PP(src_entry) TSRMLS_CC)) {</span>
<span class="lineNum">    2356 </span><span class="lineNoCov">              0 :                         Z_ARRVAL_PP(dest_entry)-&gt;nApplyCount--;</span>
<span class="lineNum">    2357 </span><span class="lineNoCov">              0 :                         Z_ARRVAL_PP(src_entry)-&gt;nApplyCount--;</span>
<span class="lineNum">    2358 </span><span class="lineNoCov">              0 :                         return 0;</span>
<span class="lineNum">    2359 </span>                :                 }
<span class="lineNum">    2360 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_PP(dest_entry)-&gt;nApplyCount--;</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">              0 :                 Z_ARRVAL_PP(src_entry)-&gt;nApplyCount--;</span>
<span class="lineNum">    2362 </span>                :         }
<span class="lineNum">    2363 </span>                : 
<span class="lineNum">    2364 </span><span class="lineNoCov">              0 :         return 1;</span>
<span class="lineNum">    2365 </span>                : }
<a name="2366"><span class="lineNum">    2366 </span>                : /* }}} */</a>
<span class="lineNum">    2367 </span>                : 
<span class="lineNum">    2368 </span><span class="lineCov">              1 : static void php_array_merge_or_replace_wrapper(INTERNAL_FUNCTION_PARAMETERS, int recursive, int replace) /* {{{ */</span>
<span class="lineNum">    2369 </span>                : {
<span class="lineNum">    2370 </span><span class="lineCov">              1 :         zval ***args = NULL;</span>
<span class="lineNum">    2371 </span><span class="lineCov">              1 :         int argc, i, init_size = 0;</span>
<span class="lineNum">    2372 </span>                : 
<span class="lineNum">    2373 </span><span class="lineCov">              1 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;+&quot;, &amp;args, &amp;argc) == FAILURE) {</span>
<span class="lineNum">    2374 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2375 </span>                :         }
<span class="lineNum">    2376 </span>                : 
<span class="lineNum">    2377 </span><span class="lineCov">              3 :         for (i = 0; i &lt; argc; i++) {</span>
<span class="lineNum">    2378 </span><span class="lineCov">              2 :                 if (Z_TYPE_PP(args[i]) != IS_ARRAY) {</span>
<span class="lineNum">    2379 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is not an array&quot;, i + 1);</span>
<span class="lineNum">    2380 </span><span class="lineNoCov">              0 :                         efree(args);</span>
<span class="lineNum">    2381 </span><span class="lineNoCov">              0 :                         RETURN_NULL();</span>
<span class="lineNum">    2382 </span>                :                 } else {
<span class="lineNum">    2383 </span><span class="lineCov">              2 :                         int num = zend_hash_num_elements(Z_ARRVAL_PP(args[i]));</span>
<span class="lineNum">    2384 </span>                : 
<span class="lineNum">    2385 </span><span class="lineCov">              2 :                         if (num &gt; init_size) {</span>
<span class="lineNum">    2386 </span><span class="lineCov">              1 :                                 init_size = num;</span>
<span class="lineNum">    2387 </span>                :                         }
<span class="lineNum">    2388 </span>                :                 }
<span class="lineNum">    2389 </span>                :         }
<span class="lineNum">    2390 </span>                : 
<span class="lineNum">    2391 </span><span class="lineCov">              1 :         array_init_size(return_value, init_size);</span>
<span class="lineNum">    2392 </span>                : 
<span class="lineNum">    2393 </span><span class="lineCov">              3 :         for (i = 0; i &lt; argc; i++) {</span>
<span class="lineNum">    2394 </span><span class="lineCov">              8 :                 SEPARATE_ZVAL(args[i]);</span>
<span class="lineNum">    2395 </span><span class="lineCov">              2 :                 if (!replace) {</span>
<span class="lineNum">    2396 </span><span class="lineCov">              2 :                         php_array_merge(Z_ARRVAL_P(return_value), Z_ARRVAL_PP(args[i]), recursive TSRMLS_CC);</span>
<span class="lineNum">    2397 </span><span class="lineNoCov">              0 :                 } else if (recursive &amp;&amp; i &gt; 0) { /* First array will be copied directly instead */</span>
<span class="lineNum">    2398 </span><span class="lineNoCov">              0 :                         php_array_replace_recursive(Z_ARRVAL_P(return_value), Z_ARRVAL_PP(args[i]) TSRMLS_CC);</span>
<span class="lineNum">    2399 </span>                :                 } else {
<span class="lineNum">    2400 </span><span class="lineNoCov">              0 :                         zend_hash_merge(Z_ARRVAL_P(return_value), Z_ARRVAL_PP(args[i]), (copy_ctor_func_t) zval_add_ref, NULL, sizeof(zval *), 1);</span>
<span class="lineNum">    2401 </span>                :                 }
<span class="lineNum">    2402 </span>                :         }
<span class="lineNum">    2403 </span>                : 
<span class="lineNum">    2404 </span><span class="lineCov">              1 :         efree(args);</span>
<span class="lineNum">    2405 </span>                : }
<span class="lineNum">    2406 </span>                : /* }}} */
<span class="lineNum">    2407 </span>                : 
<a name="2408"><span class="lineNum">    2408 </span>                : /* {{{ proto array array_merge(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    2409 </span>                :    Merges elements from passed arrays into one array */
<span class="lineNum">    2410 </span><span class="lineCov">              1 : PHP_FUNCTION(array_merge)</span>
<span class="lineNum">    2411 </span>                : {
<span class="lineNum">    2412 </span><span class="lineCov">              1 :         php_array_merge_or_replace_wrapper(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0, 0);</span>
<span class="lineNum">    2413 </span><span class="lineCov">              1 : }</span>
<span class="lineNum">    2414 </span>                : /* }}} */
<span class="lineNum">    2415 </span>                : 
<a name="2416"><span class="lineNum">    2416 </span>                : /* {{{ proto array array_merge_recursive(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    2417 </span>                :    Recursively merges elements from passed arrays into one array */
<span class="lineNum">    2418 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_merge_recursive)</span>
<span class="lineNum">    2419 </span>                : {
<span class="lineNum">    2420 </span><span class="lineNoCov">              0 :         php_array_merge_or_replace_wrapper(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1, 0);</span>
<span class="lineNum">    2421 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    2422 </span>                : /* }}} */
<span class="lineNum">    2423 </span>                : 
<a name="2424"><span class="lineNum">    2424 </span>                : /* {{{ proto array array_replace(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    2425 </span>                :    Replaces elements from passed arrays into one array */
<span class="lineNum">    2426 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_replace)</span>
<span class="lineNum">    2427 </span>                : {
<span class="lineNum">    2428 </span><span class="lineNoCov">              0 :         php_array_merge_or_replace_wrapper(INTERNAL_FUNCTION_PARAM_PASSTHRU, 0, 1);</span>
<span class="lineNum">    2429 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    2430 </span>                : /* }}} */
<span class="lineNum">    2431 </span>                : 
<a name="2432"><span class="lineNum">    2432 </span>                : /* {{{ proto array array_replace_recursive(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    2433 </span>                :    Recursively replaces elements from passed arrays into one array */
<span class="lineNum">    2434 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_replace_recursive)</span>
<span class="lineNum">    2435 </span>                : {
<span class="lineNum">    2436 </span><span class="lineNoCov">              0 :         php_array_merge_or_replace_wrapper(INTERNAL_FUNCTION_PARAM_PASSTHRU, 1, 1);</span>
<span class="lineNum">    2437 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    2438 </span>                : /* }}} */
<span class="lineNum">    2439 </span>                : 
<a name="2440"><span class="lineNum">    2440 </span>                : /* {{{ proto array array_keys(array input [, mixed search_value[, bool strict]])</a>
<span class="lineNum">    2441 </span>                :    Return just the keys from the input array, optionally only for the specified search_value */
<span class="lineNum">    2442 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_keys)</span>
<span class="lineNum">    2443 </span>                : {
<span class="lineNum">    2444 </span>                :         zval *input,                            /* Input array */
<span class="lineNum">    2445 </span><span class="lineNoCov">              0 :              *search_value = NULL,      /* Value to search for */</span>
<span class="lineNum">    2446 </span>                :              **entry,                           /* An entry in the input array */
<span class="lineNum">    2447 </span>                :                res,                                     /* Result of comparison */
<span class="lineNum">    2448 </span>                :               *new_val;                         /* New value */
<span class="lineNum">    2449 </span>                :         int    add_key;                         /* Flag to indicate whether a key should be added */
<span class="lineNum">    2450 </span>                :         char  *string_key;                      /* String key */
<span class="lineNum">    2451 </span>                :         uint   string_key_len;
<span class="lineNum">    2452 </span>                :         ulong  num_key;                         /* Numeric key */
<span class="lineNum">    2453 </span><span class="lineNoCov">              0 :         zend_bool strict = 0;           /* do strict comparison */</span>
<span class="lineNum">    2454 </span>                :         HashPosition pos;
<span class="lineNum">    2455 </span><span class="lineNoCov">              0 :         int (*is_equal_func)(zval *, zval *, zval * TSRMLS_DC) = is_equal_function;</span>
<span class="lineNum">    2456 </span>                : 
<span class="lineNum">    2457 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|zb&quot;, &amp;input, &amp;search_value, &amp;strict) == FAILURE) {</span>
<span class="lineNum">    2458 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2459 </span>                :         }
<span class="lineNum">    2460 </span>                : 
<span class="lineNum">    2461 </span><span class="lineNoCov">              0 :         if (strict) {</span>
<span class="lineNum">    2462 </span><span class="lineNoCov">              0 :                 is_equal_func = is_identical_function;</span>
<span class="lineNum">    2463 </span>                :         }
<span class="lineNum">    2464 </span>                : 
<span class="lineNum">    2465 </span>                :         /* Initialize return array */
<span class="lineNum">    2466 </span><span class="lineNoCov">              0 :         if (search_value != NULL) {</span>
<span class="lineNum">    2467 </span><span class="lineNoCov">              0 :                 array_init(return_value);</span>
<span class="lineNum">    2468 </span>                :         } else {
<span class="lineNum">    2469 </span><span class="lineNoCov">              0 :                 array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(input)));</span>
<span class="lineNum">    2470 </span>                :         }
<span class="lineNum">    2471 </span><span class="lineNoCov">              0 :         add_key = 1;</span>
<span class="lineNum">    2472 </span>                : 
<span class="lineNum">    2473 </span>                :         /* Go through input array and add keys to the return array */
<span class="lineNum">    2474 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    2475 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    2476 </span><span class="lineNoCov">              0 :                 if (search_value != NULL) {</span>
<span class="lineNum">    2477 </span><span class="lineNoCov">              0 :                         is_equal_func(&amp;res, search_value, *entry TSRMLS_CC);</span>
<span class="lineNum">    2478 </span><span class="lineNoCov">              0 :                         add_key = zval_is_true(&amp;res);</span>
<span class="lineNum">    2479 </span>                :                 }
<span class="lineNum">    2480 </span>                : 
<span class="lineNum">    2481 </span><span class="lineNoCov">              0 :                 if (add_key) {</span>
<span class="lineNum">    2482 </span><span class="lineNoCov">              0 :                         MAKE_STD_ZVAL(new_val);</span>
<span class="lineNum">    2483 </span>                : 
<span class="lineNum">    2484 </span><span class="lineNoCov">              0 :                         switch (zend_hash_get_current_key_ex(Z_ARRVAL_P(input), &amp;string_key, &amp;string_key_len, &amp;num_key, 1, &amp;pos)) {</span>
<span class="lineNum">    2485 </span>                :                                 case HASH_KEY_IS_STRING:
<span class="lineNum">    2486 </span><span class="lineNoCov">              0 :                                         ZVAL_STRINGL(new_val, string_key, string_key_len - 1, 0);</span>
<span class="lineNum">    2487 </span><span class="lineNoCov">              0 :                                         zend_hash_next_index_insert(Z_ARRVAL_P(return_value), &amp;new_val, sizeof(zval *), NULL);</span>
<span class="lineNum">    2488 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    2489 </span>                : 
<span class="lineNum">    2490 </span>                :                                 case HASH_KEY_IS_LONG:
<span class="lineNum">    2491 </span><span class="lineNoCov">              0 :                                         Z_TYPE_P(new_val) = IS_LONG;</span>
<span class="lineNum">    2492 </span><span class="lineNoCov">              0 :                                         Z_LVAL_P(new_val) = num_key;</span>
<span class="lineNum">    2493 </span><span class="lineNoCov">              0 :                                         zend_hash_next_index_insert(Z_ARRVAL_P(return_value), &amp;new_val, sizeof(zval *), NULL);</span>
<span class="lineNum">    2494 </span>                :                                         break;
<span class="lineNum">    2495 </span>                :                         }
<span class="lineNum">    2496 </span>                :                 }
<span class="lineNum">    2497 </span>                : 
<span class="lineNum">    2498 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    2499 </span>                :         }
<span class="lineNum">    2500 </span>                : }
<span class="lineNum">    2501 </span>                : /* }}} */
<span class="lineNum">    2502 </span>                : 
<a name="2503"><span class="lineNum">    2503 </span>                : /* {{{ proto array array_values(array input)</a>
<span class="lineNum">    2504 </span>                :    Return just the values from the input array */
<span class="lineNum">    2505 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_values)</span>
<span class="lineNum">    2506 </span>                : {
<span class="lineNum">    2507 </span>                :         zval     *input,                /* Input array */
<span class="lineNum">    2508 </span>                :                         **entry;                /* An entry in the input array */
<span class="lineNum">    2509 </span>                :         HashPosition pos;
<span class="lineNum">    2510 </span>                : 
<span class="lineNum">    2511 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;input) == FAILURE) {</span>
<span class="lineNum">    2512 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2513 </span>                :         }
<span class="lineNum">    2514 </span>                : 
<span class="lineNum">    2515 </span>                :         /* Initialize return array */
<span class="lineNum">    2516 </span><span class="lineNoCov">              0 :         array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(input)));</span>
<span class="lineNum">    2517 </span>                : 
<span class="lineNum">    2518 </span>                :         /* Go through input array and add values to the return array */
<span class="lineNum">    2519 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    2520 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    2521 </span><span class="lineNoCov">              0 :                 zval_add_ref(entry);</span>
<span class="lineNum">    2522 </span><span class="lineNoCov">              0 :                 zend_hash_next_index_insert(Z_ARRVAL_P(return_value), entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2523 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    2524 </span>                :         }
<span class="lineNum">    2525 </span>                : }
<span class="lineNum">    2526 </span>                : /* }}} */
<span class="lineNum">    2527 </span>                : 
<a name="2528"><span class="lineNum">    2528 </span>                : /* {{{ proto array array_count_values(array input)</a>
<span class="lineNum">    2529 </span>                :    Return the value as key and the frequency of that value in input as value */
<span class="lineNum">    2530 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_count_values)</span>
<span class="lineNum">    2531 </span>                : {
<span class="lineNum">    2532 </span>                :         zval    *input,                 /* Input array */
<span class="lineNum">    2533 </span>                :                         **entry,                /* An entry in the input array */
<span class="lineNum">    2534 </span>                :                         **tmp;
<span class="lineNum">    2535 </span>                :         HashTable *myht;
<span class="lineNum">    2536 </span>                :         HashPosition pos;
<span class="lineNum">    2537 </span>                : 
<span class="lineNum">    2538 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;input) == FAILURE) {</span>
<span class="lineNum">    2539 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2540 </span>                :         }
<span class="lineNum">    2541 </span>                : 
<span class="lineNum">    2542 </span>                :         /* Initialize return array */
<span class="lineNum">    2543 </span><span class="lineNoCov">              0 :         array_init(return_value);</span>
<span class="lineNum">    2544 </span>                : 
<span class="lineNum">    2545 </span>                :         /* Go through input array and add values to the return array */
<span class="lineNum">    2546 </span><span class="lineNoCov">              0 :         myht = Z_ARRVAL_P(input);</span>
<span class="lineNum">    2547 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(myht, &amp;pos);</span>
<span class="lineNum">    2548 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(myht, (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    2549 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(entry) == IS_LONG) {</span>
<span class="lineNum">    2550 </span><span class="lineNoCov">              0 :                         if (zend_hash_index_find(Z_ARRVAL_P(return_value), Z_LVAL_PP(entry), (void **)&amp;tmp) == FAILURE) {</span>
<span class="lineNum">    2551 </span>                :                                 zval *data;
<span class="lineNum">    2552 </span><span class="lineNoCov">              0 :                                 MAKE_STD_ZVAL(data);</span>
<span class="lineNum">    2553 </span><span class="lineNoCov">              0 :                                 ZVAL_LONG(data, 1);</span>
<span class="lineNum">    2554 </span><span class="lineNoCov">              0 :                                 zend_hash_index_update(Z_ARRVAL_P(return_value), Z_LVAL_PP(entry), &amp;data, sizeof(data), NULL);</span>
<span class="lineNum">    2555 </span>                :                         } else {
<span class="lineNum">    2556 </span><span class="lineNoCov">              0 :                                 Z_LVAL_PP(tmp)++;</span>
<span class="lineNum">    2557 </span>                :                         }
<span class="lineNum">    2558 </span><span class="lineNoCov">              0 :                 } else if (Z_TYPE_PP(entry) == IS_STRING) {</span>
<span class="lineNum">    2559 </span><span class="lineNoCov">              0 :                         if (zend_symtable_find(Z_ARRVAL_P(return_value), Z_STRVAL_PP(entry), Z_STRLEN_PP(entry) + 1, (void**)&amp;tmp) == FAILURE) {</span>
<span class="lineNum">    2560 </span>                :                                 zval *data;
<span class="lineNum">    2561 </span><span class="lineNoCov">              0 :                                 MAKE_STD_ZVAL(data);</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">              0 :                                 ZVAL_LONG(data, 1);</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">              0 :                                 zend_symtable_update(Z_ARRVAL_P(return_value), Z_STRVAL_PP(entry), Z_STRLEN_PP(entry) + 1, &amp;data, sizeof(data), NULL);</span>
<span class="lineNum">    2564 </span>                :                         } else {
<span class="lineNum">    2565 </span><span class="lineNoCov">              0 :                                 Z_LVAL_PP(tmp)++;</span>
<span class="lineNum">    2566 </span>                :                         }
<span class="lineNum">    2567 </span>                :                 } else {
<span class="lineNum">    2568 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Can only count STRING and INTEGER values!&quot;);</span>
<span class="lineNum">    2569 </span>                :                 }
<span class="lineNum">    2570 </span>                : 
<span class="lineNum">    2571 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(myht, &amp;pos);</span>
<span class="lineNum">    2572 </span>                :         }
<span class="lineNum">    2573 </span>                : }
<span class="lineNum">    2574 </span>                : /* }}} */
<span class="lineNum">    2575 </span>                : 
<a name="2576"><span class="lineNum">    2576 </span>                : /* {{{ proto array array_reverse(array input [, bool preserve keys])</a>
<span class="lineNum">    2577 </span>                :    Return input as a new array with the order of the entries reversed */
<span class="lineNum">    2578 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_reverse)</span>
<span class="lineNum">    2579 </span>                : {
<span class="lineNum">    2580 </span>                :         zval     *input,                                /* Input array */
<span class="lineNum">    2581 </span>                :                         **entry;                                /* An entry in the input array */
<span class="lineNum">    2582 </span>                :         char     *string_key;
<span class="lineNum">    2583 </span>                :         uint      string_key_len;
<span class="lineNum">    2584 </span>                :         ulong     num_key;
<span class="lineNum">    2585 </span><span class="lineNoCov">              0 :         zend_bool preserve_keys = 0;    /* whether to preserve keys */</span>
<span class="lineNum">    2586 </span>                :         HashPosition pos;
<span class="lineNum">    2587 </span>                : 
<span class="lineNum">    2588 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|b&quot;, &amp;input, &amp;preserve_keys) == FAILURE) {</span>
<span class="lineNum">    2589 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2590 </span>                :         }
<span class="lineNum">    2591 </span>                : 
<span class="lineNum">    2592 </span>                :         /* Initialize return array */
<span class="lineNum">    2593 </span><span class="lineNoCov">              0 :         array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(input)));</span>
<span class="lineNum">    2594 </span>                : 
<span class="lineNum">    2595 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_end_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    2596 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    2597 </span><span class="lineNoCov">              0 :                 zval_add_ref(entry);</span>
<span class="lineNum">    2598 </span>                : 
<span class="lineNum">    2599 </span><span class="lineNoCov">              0 :                 switch (zend_hash_get_current_key_ex(Z_ARRVAL_P(input), &amp;string_key, &amp;string_key_len, &amp;num_key, 0, &amp;pos)) {</span>
<span class="lineNum">    2600 </span>                :                         case HASH_KEY_IS_STRING:
<span class="lineNum">    2601 </span><span class="lineNoCov">              0 :                                 zend_hash_update(Z_ARRVAL_P(return_value), string_key, string_key_len, entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2602 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    2603 </span>                : 
<span class="lineNum">    2604 </span>                :                         case HASH_KEY_IS_LONG:
<span class="lineNum">    2605 </span><span class="lineNoCov">              0 :                                 if (preserve_keys) {</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">              0 :                                         zend_hash_index_update(Z_ARRVAL_P(return_value), num_key, entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2607 </span>                :                                 } else {
<span class="lineNum">    2608 </span><span class="lineNoCov">              0 :                                         zend_hash_next_index_insert(Z_ARRVAL_P(return_value), entry, sizeof(zval *), NULL);</span>
<span class="lineNum">    2609 </span>                :                                 }
<span class="lineNum">    2610 </span>                :                                 break;
<span class="lineNum">    2611 </span>                :                 }
<span class="lineNum">    2612 </span>                : 
<span class="lineNum">    2613 </span><span class="lineNoCov">              0 :                 zend_hash_move_backwards_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    2614 </span>                :         }
<span class="lineNum">    2615 </span>                : }
<span class="lineNum">    2616 </span>                : /* }}} */
<span class="lineNum">    2617 </span>                : 
<a name="2618"><span class="lineNum">    2618 </span>                : /* {{{ proto array array_pad(array input, int pad_size, mixed pad_value)</a>
<span class="lineNum">    2619 </span>                :    Returns a copy of input array padded with pad_value to size pad_size */
<span class="lineNum">    2620 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_pad)</span>
<span class="lineNum">    2621 </span>                : {
<span class="lineNum">    2622 </span>                :         zval  *input;           /* Input array */
<span class="lineNum">    2623 </span>                :         zval  *pad_value;       /* Padding value obviously */
<span class="lineNum">    2624 </span>                :         zval ***pads;           /* Array to pass to splice */
<span class="lineNum">    2625 </span>                :         HashTable *new_hash;/* Return value from splice */
<span class="lineNum">    2626 </span>                :         HashTable  old_hash;
<span class="lineNum">    2627 </span>                :         long pad_size;          /* Size to pad to */
<span class="lineNum">    2628 </span>                :         long pad_size_abs;      /* Absolute value of pad_size */
<span class="lineNum">    2629 </span>                :         int     input_size;             /* Size of the input array */
<span class="lineNum">    2630 </span>                :         int     num_pads;               /* How many pads do we need */
<span class="lineNum">    2631 </span>                :         int     do_pad;                 /* Whether we should do padding at all */
<span class="lineNum">    2632 </span>                :         int     i;
<span class="lineNum">    2633 </span>                : 
<span class="lineNum">    2634 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;alz&quot;, &amp;input, &amp;pad_size, &amp;pad_value) == FAILURE) {</span>
<span class="lineNum">    2635 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2636 </span>                :         }
<span class="lineNum">    2637 </span>                : 
<span class="lineNum">    2638 </span>                :         /* Do some initial calculations */
<span class="lineNum">    2639 </span><span class="lineNoCov">              0 :         input_size = zend_hash_num_elements(Z_ARRVAL_P(input));</span>
<span class="lineNum">    2640 </span><span class="lineNoCov">              0 :         pad_size_abs = abs(pad_size);</span>
<span class="lineNum">    2641 </span><span class="lineNoCov">              0 :         if (pad_size_abs &lt; 0) {</span>
<span class="lineNum">    2642 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;You may only pad up to 1048576 elements at a time&quot;);</span>
<span class="lineNum">    2643 </span>                :                 zval_dtor(return_value);
<span class="lineNum">    2644 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    2645 </span>                :         }
<span class="lineNum">    2646 </span><span class="lineNoCov">              0 :         do_pad = (input_size &gt;= pad_size_abs) ? 0 : 1;</span>
<span class="lineNum">    2647 </span>                : 
<span class="lineNum">    2648 </span>                :         /* Copy the original array */
<span class="lineNum">    2649 </span><span class="lineNoCov">              0 :         RETVAL_ZVAL(input, 1, 0);</span>
<span class="lineNum">    2650 </span>                : 
<span class="lineNum">    2651 </span>                :         /* If no need to pad, no need to continue */
<span class="lineNum">    2652 </span><span class="lineNoCov">              0 :         if (!do_pad) {</span>
<span class="lineNum">    2653 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2654 </span>                :         }
<span class="lineNum">    2655 </span>                : 
<span class="lineNum">    2656 </span>                :         /* Populate the pads array */
<span class="lineNum">    2657 </span><span class="lineNoCov">              0 :         num_pads = pad_size_abs - input_size;</span>
<span class="lineNum">    2658 </span><span class="lineNoCov">              0 :         if (num_pads &gt; 1048576) {</span>
<span class="lineNum">    2659 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;You may only pad up to 1048576 elements at a time&quot;);</span>
<span class="lineNum">    2660 </span>                :                 zval_dtor(return_value);
<span class="lineNum">    2661 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    2662 </span>                :         }
<span class="lineNum">    2663 </span><span class="lineNoCov">              0 :         pads = (zval ***)safe_emalloc(num_pads, sizeof(zval **), 0);</span>
<span class="lineNum">    2664 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; num_pads; i++) {</span>
<span class="lineNum">    2665 </span><span class="lineNoCov">              0 :                 pads[i] = &amp;pad_value;</span>
<span class="lineNum">    2666 </span>                :         }
<span class="lineNum">    2667 </span>                : 
<span class="lineNum">    2668 </span>                :         /* Pad on the right or on the left */
<span class="lineNum">    2669 </span><span class="lineNoCov">              0 :         if (pad_size &gt; 0) {</span>
<span class="lineNum">    2670 </span><span class="lineNoCov">              0 :                 new_hash = php_splice(Z_ARRVAL_P(return_value), input_size, 0, pads, num_pads, NULL);</span>
<span class="lineNum">    2671 </span>                :         } else {
<span class="lineNum">    2672 </span><span class="lineNoCov">              0 :                 new_hash = php_splice(Z_ARRVAL_P(return_value), 0, 0, pads, num_pads, NULL);</span>
<span class="lineNum">    2673 </span>                :         }
<span class="lineNum">    2674 </span>                : 
<span class="lineNum">    2675 </span>                :         /* Copy the result hash into return value */
<span class="lineNum">    2676 </span><span class="lineNoCov">              0 :         old_hash = *Z_ARRVAL_P(return_value);</span>
<span class="lineNum">    2677 </span><span class="lineNoCov">              0 :         if (Z_ARRVAL_P(return_value) == &amp;EG(symbol_table)) {</span>
<span class="lineNum">    2678 </span><span class="lineNoCov">              0 :                 zend_reset_all_cv(&amp;EG(symbol_table) TSRMLS_CC);</span>
<span class="lineNum">    2679 </span>                :         }
<span class="lineNum">    2680 </span><span class="lineNoCov">              0 :         *Z_ARRVAL_P(return_value) = *new_hash;</span>
<span class="lineNum">    2681 </span><span class="lineNoCov">              0 :         FREE_HASHTABLE(new_hash);</span>
<span class="lineNum">    2682 </span><span class="lineNoCov">              0 :         zend_hash_destroy(&amp;old_hash);</span>
<span class="lineNum">    2683 </span>                : 
<span class="lineNum">    2684 </span>                :         /* Clean up */
<span class="lineNum">    2685 </span><span class="lineNoCov">              0 :         efree(pads);</span>
<span class="lineNum">    2686 </span>                : }
<span class="lineNum">    2687 </span>                : /* }}} */
<span class="lineNum">    2688 </span>                : 
<a name="2689"><span class="lineNum">    2689 </span>                : /* {{{ proto array array_flip(array input)</a>
<span class="lineNum">    2690 </span>                :    Return array with key &lt;-&gt; value flipped */
<span class="lineNum">    2691 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_flip)</span>
<span class="lineNum">    2692 </span>                : {
<span class="lineNum">    2693 </span>                :         zval *array, **entry, *data;
<span class="lineNum">    2694 </span>                :         char *string_key;
<span class="lineNum">    2695 </span>                :         uint str_key_len;
<span class="lineNum">    2696 </span>                :         ulong num_key;
<span class="lineNum">    2697 </span>                :         HashPosition pos;
<span class="lineNum">    2698 </span>                : 
<span class="lineNum">    2699 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;array) == FAILURE) {</span>
<span class="lineNum">    2700 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2701 </span>                :         }
<span class="lineNum">    2702 </span>                : 
<span class="lineNum">    2703 </span><span class="lineNoCov">              0 :         array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(array)));</span>
<span class="lineNum">    2704 </span>                : 
<span class="lineNum">    2705 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">    2706 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(array), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    2707 </span><span class="lineNoCov">              0 :                 MAKE_STD_ZVAL(data);</span>
<span class="lineNum">    2708 </span><span class="lineNoCov">              0 :                 switch (zend_hash_get_current_key_ex(Z_ARRVAL_P(array), &amp;string_key, &amp;str_key_len, &amp;num_key, 1, &amp;pos)) {</span>
<span class="lineNum">    2709 </span>                :                         case HASH_KEY_IS_STRING:
<span class="lineNum">    2710 </span><span class="lineNoCov">              0 :                                 ZVAL_STRINGL(data, string_key, str_key_len - 1, 0);</span>
<span class="lineNum">    2711 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    2712 </span>                :                         case HASH_KEY_IS_LONG:
<span class="lineNum">    2713 </span><span class="lineNoCov">              0 :                                 Z_TYPE_P(data) = IS_LONG;</span>
<span class="lineNum">    2714 </span><span class="lineNoCov">              0 :                                 Z_LVAL_P(data) = num_key;</span>
<span class="lineNum">    2715 </span>                :                                 break;
<span class="lineNum">    2716 </span>                :                 }
<span class="lineNum">    2717 </span>                : 
<span class="lineNum">    2718 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(entry) == IS_LONG) {</span>
<span class="lineNum">    2719 </span><span class="lineNoCov">              0 :                         zend_hash_index_update(Z_ARRVAL_P(return_value), Z_LVAL_PP(entry), &amp;data, sizeof(data), NULL);</span>
<span class="lineNum">    2720 </span><span class="lineNoCov">              0 :                 } else if (Z_TYPE_PP(entry) == IS_STRING) {</span>
<span class="lineNum">    2721 </span><span class="lineNoCov">              0 :                         zend_symtable_update(Z_ARRVAL_P(return_value), Z_STRVAL_PP(entry), Z_STRLEN_PP(entry) + 1, &amp;data, sizeof(data), NULL);</span>
<span class="lineNum">    2722 </span>                :                 } else {
<span class="lineNum">    2723 </span><span class="lineNoCov">              0 :                         zval_ptr_dtor(&amp;data); /* will free also zval structure */</span>
<span class="lineNum">    2724 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Can only flip STRING and INTEGER values!&quot;);</span>
<span class="lineNum">    2725 </span>                :                 }
<span class="lineNum">    2726 </span>                : 
<span class="lineNum">    2727 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">    2728 </span>                :         }
<span class="lineNum">    2729 </span>                : }
<span class="lineNum">    2730 </span>                : /* }}} */
<span class="lineNum">    2731 </span>                : 
<a name="2732"><span class="lineNum">    2732 </span>                : /* {{{ proto array array_change_key_case(array input [, int case=CASE_LOWER])</a>
<span class="lineNum">    2733 </span>                :    Retuns an array with all string keys lowercased [or uppercased] */
<span class="lineNum">    2734 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_change_key_case)</span>
<span class="lineNum">    2735 </span>                : {
<span class="lineNum">    2736 </span>                :         zval *array, **entry;
<span class="lineNum">    2737 </span>                :         char *string_key;
<span class="lineNum">    2738 </span>                :         char *new_key;
<span class="lineNum">    2739 </span>                :         uint str_key_len;
<span class="lineNum">    2740 </span>                :         ulong num_key;
<span class="lineNum">    2741 </span><span class="lineNoCov">              0 :         long change_to_upper=0;</span>
<span class="lineNum">    2742 </span>                :         HashPosition pos;
<span class="lineNum">    2743 </span>                : 
<span class="lineNum">    2744 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;change_to_upper) == FAILURE) {</span>
<span class="lineNum">    2745 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2746 </span>                :         }
<span class="lineNum">    2747 </span>                : 
<span class="lineNum">    2748 </span><span class="lineNoCov">              0 :         array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(array)));</span>
<span class="lineNum">    2749 </span>                : 
<span class="lineNum">    2750 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">    2751 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(array), (void **)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    2752 </span><span class="lineNoCov">              0 :                 zval_add_ref(entry);</span>
<span class="lineNum">    2753 </span>                : 
<span class="lineNum">    2754 </span><span class="lineNoCov">              0 :                 switch (zend_hash_get_current_key_ex(Z_ARRVAL_P(array), &amp;string_key, &amp;str_key_len, &amp;num_key, 0, &amp;pos)) {</span>
<span class="lineNum">    2755 </span>                :                         case HASH_KEY_IS_LONG:
<span class="lineNum">    2756 </span><span class="lineNoCov">              0 :                                 zend_hash_index_update(Z_ARRVAL_P(return_value), num_key, entry, sizeof(entry), NULL);</span>
<span class="lineNum">    2757 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    2758 </span>                :                         case HASH_KEY_IS_STRING:
<span class="lineNum">    2759 </span><span class="lineNoCov">              0 :                                 new_key = estrndup(string_key, str_key_len - 1);</span>
<span class="lineNum">    2760 </span><span class="lineNoCov">              0 :                                 if (change_to_upper) {</span>
<span class="lineNum">    2761 </span><span class="lineNoCov">              0 :                                         php_strtoupper(new_key, str_key_len - 1);</span>
<span class="lineNum">    2762 </span>                :                                 } else {
<span class="lineNum">    2763 </span><span class="lineNoCov">              0 :                                         php_strtolower(new_key, str_key_len - 1);</span>
<span class="lineNum">    2764 </span>                :                                 }
<span class="lineNum">    2765 </span><span class="lineNoCov">              0 :                                 zend_hash_update(Z_ARRVAL_P(return_value), new_key, str_key_len, entry, sizeof(entry), NULL);</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">              0 :                                 efree(new_key);</span>
<span class="lineNum">    2767 </span>                :                                 break;
<span class="lineNum">    2768 </span>                :                 }
<span class="lineNum">    2769 </span>                : 
<span class="lineNum">    2770 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">    2771 </span>                :         }
<span class="lineNum">    2772 </span>                : }
<span class="lineNum">    2773 </span>                : /* }}} */
<span class="lineNum">    2774 </span>                : 
<a name="2775"><span class="lineNum">    2775 </span>                : /* {{{ proto array array_unique(array input [, int sort_flags])</a>
<span class="lineNum">    2776 </span>                :    Removes duplicate values from array */
<span class="lineNum">    2777 </span><span class="lineCov">              1 : PHP_FUNCTION(array_unique)</span>
<span class="lineNum">    2778 </span>                : {
<span class="lineNum">    2779 </span>                :         zval *array, *tmp;
<span class="lineNum">    2780 </span>                :         Bucket *p;
<span class="lineNum">    2781 </span>                :         struct bucketindex {
<span class="lineNum">    2782 </span>                :                 Bucket *b;
<span class="lineNum">    2783 </span>                :                 unsigned int i;
<span class="lineNum">    2784 </span>                :         };
<span class="lineNum">    2785 </span>                :         struct bucketindex *arTmp, *cmpdata, *lastkept;
<span class="lineNum">    2786 </span>                :         unsigned int i;
<span class="lineNum">    2787 </span><span class="lineCov">              1 :         long sort_type = PHP_SORT_STRING;</span>
<span class="lineNum">    2788 </span>                : 
<span class="lineNum">    2789 </span><span class="lineCov">              1 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;array, &amp;sort_type) == FAILURE) {</span>
<span class="lineNum">    2790 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2791 </span>                :         }
<span class="lineNum">    2792 </span>                : 
<span class="lineNum">    2793 </span><span class="lineCov">              1 :         php_set_compare_func(sort_type TSRMLS_CC);</span>
<span class="lineNum">    2794 </span>                : 
<span class="lineNum">    2795 </span><span class="lineCov">              1 :         array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(array)));</span>
<span class="lineNum">    2796 </span><span class="lineCov">              1 :         zend_hash_copy(Z_ARRVAL_P(return_value), Z_ARRVAL_P(array), (copy_ctor_func_t) zval_add_ref, (void *)&amp;tmp, sizeof(zval*));</span>
<span class="lineNum">    2797 </span>                : 
<span class="lineNum">    2798 </span><span class="lineCov">              1 :         if (Z_ARRVAL_P(array)-&gt;nNumOfElements &lt;= 1) {     /* nothing to do */</span>
<span class="lineNum">    2799 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2800 </span>                :         }
<span class="lineNum">    2801 </span>                : 
<span class="lineNum">    2802 </span>                :         /* create and sort array with pointers to the target_hash buckets */
<span class="lineNum">    2803 </span><span class="lineCov">              1 :         arTmp = (struct bucketindex *) pemalloc((Z_ARRVAL_P(array)-&gt;nNumOfElements + 1) * sizeof(struct bucketindex), Z_ARRVAL_P(array)-&gt;persistent);</span>
<span class="lineNum">    2804 </span><span class="lineCov">              1 :         if (!arTmp) {</span>
<span class="lineNum">    2805 </span>                :                 zval_dtor(return_value);
<span class="lineNum">    2806 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    2807 </span>                :         }
<span class="lineNum">    2808 </span><span class="lineCov">             43 :         for (i = 0, p = Z_ARRVAL_P(array)-&gt;pListHead; p; i++, p = p-&gt;pListNext) {</span>
<span class="lineNum">    2809 </span><span class="lineCov">             42 :                 arTmp[i].b = p;</span>
<span class="lineNum">    2810 </span><span class="lineCov">             42 :                 arTmp[i].i = i;</span>
<span class="lineNum">    2811 </span>                :         }
<span class="lineNum">    2812 </span><span class="lineCov">              1 :         arTmp[i].b = NULL;</span>
<span class="lineNum">    2813 </span><span class="lineCov">              1 :         zend_qsort((void *) arTmp, i, sizeof(struct bucketindex), php_array_data_compare TSRMLS_CC);</span>
<span class="lineNum">    2814 </span>                : 
<span class="lineNum">    2815 </span>                :         /* go through the sorted array and delete duplicates from the copy */
<span class="lineNum">    2816 </span><span class="lineCov">              1 :         lastkept = arTmp;</span>
<span class="lineNum">    2817 </span><span class="lineCov">             42 :         for (cmpdata = arTmp + 1; cmpdata-&gt;b; cmpdata++) {</span>
<span class="lineNum">    2818 </span><span class="lineCov">             41 :                 if (php_array_data_compare(lastkept, cmpdata TSRMLS_CC)) {</span>
<span class="lineNum">    2819 </span><span class="lineCov">             41 :                         lastkept = cmpdata;</span>
<span class="lineNum">    2820 </span>                :                 } else {
<span class="lineNum">    2821 </span><span class="lineNoCov">              0 :                         if (lastkept-&gt;i &gt; cmpdata-&gt;i) {</span>
<span class="lineNum">    2822 </span><span class="lineNoCov">              0 :                                 p = lastkept-&gt;b;</span>
<span class="lineNum">    2823 </span><span class="lineNoCov">              0 :                                 lastkept = cmpdata;</span>
<span class="lineNum">    2824 </span>                :                         } else {
<span class="lineNum">    2825 </span><span class="lineNoCov">              0 :                                 p = cmpdata-&gt;b;</span>
<span class="lineNum">    2826 </span>                :                         }
<span class="lineNum">    2827 </span><span class="lineNoCov">              0 :                         if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    2828 </span><span class="lineNoCov">              0 :                                 zend_hash_index_del(Z_ARRVAL_P(return_value), p-&gt;h);</span>
<span class="lineNum">    2829 </span>                :                         } else {
<span class="lineNum">    2830 </span><span class="lineNoCov">              0 :                                 if (Z_ARRVAL_P(return_value) == &amp;EG(symbol_table)) {</span>
<span class="lineNum">    2831 </span><span class="lineNoCov">              0 :                                         zend_delete_global_variable(p-&gt;arKey, p-&gt;nKeyLength - 1 TSRMLS_CC);</span>
<span class="lineNum">    2832 </span>                :                                 } else {
<span class="lineNum">    2833 </span><span class="lineNoCov">              0 :                                         zend_hash_quick_del(Z_ARRVAL_P(return_value), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h);</span>
<span class="lineNum">    2834 </span>                :                                 }
<span class="lineNum">    2835 </span>                :                         }
<span class="lineNum">    2836 </span>                :                 }
<span class="lineNum">    2837 </span>                :         }
<span class="lineNum">    2838 </span><span class="lineCov">              1 :         pefree(arTmp, Z_ARRVAL_P(array)-&gt;persistent);</span>
<span class="lineNum">    2839 </span>                : }
<a name="2840"><span class="lineNum">    2840 </span>                : /* }}} */</a>
<span class="lineNum">    2841 </span>                : 
<span class="lineNum">    2842 </span><span class="lineNoCov">              0 : static int zval_compare(zval **a, zval **b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    2843 </span>                : {
<span class="lineNum">    2844 </span>                :         zval result;
<span class="lineNum">    2845 </span>                :         zval *first;
<span class="lineNum">    2846 </span>                :         zval *second;
<span class="lineNum">    2847 </span>                : 
<span class="lineNum">    2848 </span><span class="lineNoCov">              0 :         first = *((zval **) a);</span>
<span class="lineNum">    2849 </span><span class="lineNoCov">              0 :         second = *((zval **) b);</span>
<span class="lineNum">    2850 </span>                : 
<span class="lineNum">    2851 </span><span class="lineNoCov">              0 :         if (string_compare_function(&amp;result, first, second TSRMLS_CC) == FAILURE) {</span>
<span class="lineNum">    2852 </span><span class="lineNoCov">              0 :                 return 0;</span>
<span class="lineNum">    2853 </span>                :         }
<span class="lineNum">    2854 </span>                : 
<span class="lineNum">    2855 </span><span class="lineNoCov">              0 :         if (Z_TYPE(result) == IS_DOUBLE) {</span>
<span class="lineNum">    2856 </span><span class="lineNoCov">              0 :                 if (Z_DVAL(result) &lt; 0) {</span>
<span class="lineNum">    2857 </span><span class="lineNoCov">              0 :                         return -1;</span>
<span class="lineNum">    2858 </span><span class="lineNoCov">              0 :                 } else if (Z_DVAL(result) &gt; 0) {</span>
<span class="lineNum">    2859 </span><span class="lineNoCov">              0 :                         return 1;</span>
<span class="lineNum">    2860 </span>                :                 } else {
<span class="lineNum">    2861 </span><span class="lineNoCov">              0 :                         return 0;</span>
<span class="lineNum">    2862 </span>                :                 }
<span class="lineNum">    2863 </span>                :         }
<span class="lineNum">    2864 </span>                : 
<span class="lineNum">    2865 </span><span class="lineNoCov">              0 :         convert_to_long(&amp;result);</span>
<span class="lineNum">    2866 </span>                : 
<span class="lineNum">    2867 </span><span class="lineNoCov">              0 :         if (Z_LVAL(result) &lt; 0) {</span>
<span class="lineNum">    2868 </span><span class="lineNoCov">              0 :                 return -1;</span>
<span class="lineNum">    2869 </span><span class="lineNoCov">              0 :         } else if (Z_LVAL(result) &gt; 0) {</span>
<span class="lineNum">    2870 </span><span class="lineNoCov">              0 :                 return 1;</span>
<span class="lineNum">    2871 </span>                :         }
<span class="lineNum">    2872 </span>                : 
<span class="lineNum">    2873 </span><span class="lineNoCov">              0 :         return 0;</span>
<span class="lineNum">    2874 </span>                : }
<a name="2875"><span class="lineNum">    2875 </span>                : /* }}} */</a>
<span class="lineNum">    2876 </span>                : 
<span class="lineNum">    2877 </span><span class="lineNoCov">              0 : static int zval_user_compare(zval **a, zval **b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    2878 </span>                : {
<span class="lineNum">    2879 </span>                :         zval **args[2];
<span class="lineNum">    2880 </span>                :         zval *retval_ptr;
<span class="lineNum">    2881 </span>                : 
<span class="lineNum">    2882 </span><span class="lineNoCov">              0 :         args[0] = (zval **) a;</span>
<span class="lineNum">    2883 </span><span class="lineNoCov">              0 :         args[1] = (zval **) b;</span>
<span class="lineNum">    2884 </span>                : 
<span class="lineNum">    2885 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).param_count = 2;</span>
<span class="lineNum">    2886 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).params = args;</span>
<span class="lineNum">    2887 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).retval_ptr_ptr = &amp;retval_ptr;</span>
<span class="lineNum">    2888 </span><span class="lineNoCov">              0 :         BG(user_compare_fci).no_separation = 0;</span>
<span class="lineNum">    2889 </span>                : 
<span class="lineNum">    2890 </span><span class="lineNoCov">              0 :         if (zend_call_function(&amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache) TSRMLS_CC) == SUCCESS &amp;&amp; retval_ptr) {</span>
<span class="lineNum">    2891 </span>                :                 long retval;
<span class="lineNum">    2892 </span>                : 
<span class="lineNum">    2893 </span><span class="lineNoCov">              0 :                 convert_to_long_ex(&amp;retval_ptr);</span>
<span class="lineNum">    2894 </span><span class="lineNoCov">              0 :                 retval = Z_LVAL_P(retval_ptr);</span>
<span class="lineNum">    2895 </span><span class="lineNoCov">              0 :                 zval_ptr_dtor(&amp;retval_ptr);</span>
<span class="lineNum">    2896 </span><span class="lineNoCov">              0 :                 return retval &lt; 0 ? -1 : retval &gt; 0 ? 1 : 0;;</span>
<span class="lineNum">    2897 </span>                :         } else {
<span class="lineNum">    2898 </span><span class="lineNoCov">              0 :                 return 0;</span>
<span class="lineNum">    2899 </span>                :         }
<span class="lineNum">    2900 </span>                : }
<a name="2901"><span class="lineNum">    2901 </span>                : /* }}} */</a>
<span class="lineNum">    2902 </span>                : 
<span class="lineNum">    2903 </span><span class="lineNoCov">              0 : static void php_array_intersect_key(INTERNAL_FUNCTION_PARAMETERS, int data_compare_type) /* {{{ */</span>
<span class="lineNum">    2904 </span>                : {
<span class="lineNum">    2905 </span>                :         Bucket *p;
<span class="lineNum">    2906 </span>                :         int argc, i;
<span class="lineNum">    2907 </span>                :         zval ***args;
<span class="lineNum">    2908 </span><span class="lineNoCov">              0 :         int (*intersect_data_compare_func)(zval **, zval ** TSRMLS_DC) = NULL;</span>
<span class="lineNum">    2909 </span>                :         zend_bool ok;
<span class="lineNum">    2910 </span>                :         zval **data;
<span class="lineNum">    2911 </span>                :         int req_args;
<span class="lineNum">    2912 </span>                :         char *param_spec;
<span class="lineNum">    2913 </span>                : 
<span class="lineNum">    2914 </span>                :         /* Get the argument count */
<span class="lineNum">    2915 </span><span class="lineNoCov">              0 :         argc = ZEND_NUM_ARGS();</span>
<span class="lineNum">    2916 </span><span class="lineNoCov">              0 :         if (data_compare_type == INTERSECT_COMP_DATA_USER) {</span>
<span class="lineNum">    2917 </span>                :                 /* INTERSECT_COMP_DATA_USER - array_uintersect_assoc() */
<span class="lineNum">    2918 </span><span class="lineNoCov">              0 :                 req_args = 3;</span>
<span class="lineNum">    2919 </span><span class="lineNoCov">              0 :                 param_spec = &quot;+f&quot;;</span>
<span class="lineNum">    2920 </span><span class="lineNoCov">              0 :                 intersect_data_compare_func = zval_user_compare;</span>
<span class="lineNum">    2921 </span>                :         } else {
<span class="lineNum">    2922 </span>                :                 /*      INTERSECT_COMP_DATA_NONE - array_intersect_key()
<span class="lineNum">    2923 </span>                :                         INTERSECT_COMP_DATA_INTERNAL - array_intersect_assoc() */
<span class="lineNum">    2924 </span><span class="lineNoCov">              0 :                 req_args = 2;</span>
<span class="lineNum">    2925 </span><span class="lineNoCov">              0 :                 param_spec = &quot;+&quot;;</span>
<span class="lineNum">    2926 </span>                :                                 
<span class="lineNum">    2927 </span><span class="lineNoCov">              0 :                 if (data_compare_type == INTERSECT_COMP_DATA_INTERNAL) {</span>
<span class="lineNum">    2928 </span><span class="lineNoCov">              0 :                         intersect_data_compare_func = zval_compare;</span>
<span class="lineNum">    2929 </span>                :                 }
<span class="lineNum">    2930 </span>                :         }
<span class="lineNum">    2931 </span>                :         
<span class="lineNum">    2932 </span><span class="lineNoCov">              0 :         if (argc &lt; req_args) {</span>
<span class="lineNum">    2933 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;at least %d parameters are required, %d given&quot;, req_args, argc);</span>
<span class="lineNum">    2934 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2935 </span>                :         }
<span class="lineNum">    2936 </span>                : 
<span class="lineNum">    2937 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, param_spec, &amp;args, &amp;argc, &amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache)) == FAILURE) {</span>
<span class="lineNum">    2938 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    2939 </span>                :         }
<span class="lineNum">    2940 </span>                : 
<span class="lineNum">    2941 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; argc; i++) {</span>
<span class="lineNum">    2942 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(args[i]) != IS_ARRAY) {</span>
<span class="lineNum">    2943 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is not an array&quot;, i + 1);</span>
<span class="lineNum">    2944 </span><span class="lineNoCov">              0 :                         RETVAL_NULL();</span>
<span class="lineNum">    2945 </span><span class="lineNoCov">              0 :                         goto out;</span>
<span class="lineNum">    2946 </span>                :                 }
<span class="lineNum">    2947 </span>                :         }
<span class="lineNum">    2948 </span>                : 
<span class="lineNum">    2949 </span><span class="lineNoCov">              0 :         array_init(return_value);</span>
<span class="lineNum">    2950 </span>                : 
<span class="lineNum">    2951 </span><span class="lineNoCov">              0 :         for (p = Z_ARRVAL_PP(args[0])-&gt;pListHead; p != NULL; p = p-&gt;pListNext) {</span>
<span class="lineNum">    2952 </span><span class="lineNoCov">              0 :                 if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    2953 </span><span class="lineNoCov">              0 :                         ok = 1;</span>
<span class="lineNum">    2954 </span><span class="lineNoCov">              0 :                         for (i = 1; i &lt; argc; i++) {</span>
<span class="lineNum">    2955 </span><span class="lineNoCov">              0 :                                 if (zend_hash_index_find(Z_ARRVAL_PP(args[i]), p-&gt;h, (void**)&amp;data) == FAILURE ||</span>
<span class="lineNum">    2956 </span>                :                                         (intersect_data_compare_func &amp;&amp;
<span class="lineNum">    2957 </span><span class="lineNoCov">              0 :                                         intersect_data_compare_func((zval**)p-&gt;pData, data TSRMLS_CC) != 0)</span>
<span class="lineNum">    2958 </span>                :                                 ) {
<span class="lineNum">    2959 </span><span class="lineNoCov">              0 :                                         ok = 0;</span>
<span class="lineNum">    2960 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    2961 </span>                :                                 }
<span class="lineNum">    2962 </span>                :                         }
<span class="lineNum">    2963 </span><span class="lineNoCov">              0 :                         if (ok) {</span>
<span class="lineNum">    2964 </span><span class="lineNoCov">              0 :                                 Z_ADDREF_PP((zval**)p-&gt;pData);</span>
<span class="lineNum">    2965 </span><span class="lineNoCov">              0 :                                 zend_hash_index_update(Z_ARRVAL_P(return_value), p-&gt;h, p-&gt;pData, sizeof(zval*), NULL);</span>
<span class="lineNum">    2966 </span>                :                         }
<span class="lineNum">    2967 </span>                :                 } else {
<span class="lineNum">    2968 </span><span class="lineNoCov">              0 :                         ok = 1;</span>
<span class="lineNum">    2969 </span><span class="lineNoCov">              0 :                         for (i = 1; i &lt; argc; i++) {</span>
<span class="lineNum">    2970 </span><span class="lineNoCov">              0 :                                 if (zend_hash_quick_find(Z_ARRVAL_PP(args[i]), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h, (void**)&amp;data) == FAILURE ||</span>
<span class="lineNum">    2971 </span>                :                                         (intersect_data_compare_func &amp;&amp;
<span class="lineNum">    2972 </span><span class="lineNoCov">              0 :                                         intersect_data_compare_func((zval**)p-&gt;pData, data TSRMLS_CC) != 0)</span>
<span class="lineNum">    2973 </span>                :                                 ) {
<span class="lineNum">    2974 </span><span class="lineNoCov">              0 :                                         ok = 0;</span>
<span class="lineNum">    2975 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    2976 </span>                :                                 }
<span class="lineNum">    2977 </span>                :                         }
<span class="lineNum">    2978 </span><span class="lineNoCov">              0 :                         if (ok) {</span>
<span class="lineNum">    2979 </span><span class="lineNoCov">              0 :                                 Z_ADDREF_PP((zval**)p-&gt;pData);</span>
<span class="lineNum">    2980 </span><span class="lineNoCov">              0 :                                 zend_hash_quick_update(Z_ARRVAL_P(return_value), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h, p-&gt;pData, sizeof(zval*), NULL);</span>
<span class="lineNum">    2981 </span>                :                         }
<span class="lineNum">    2982 </span>                :                 }
<span class="lineNum">    2983 </span>                :         }
<span class="lineNum">    2984 </span>                : out:
<span class="lineNum">    2985 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    2986 </span>                : }
<a name="2987"><span class="lineNum">    2987 </span>                : /* }}} */</a>
<span class="lineNum">    2988 </span>                : 
<span class="lineNum">    2989 </span><span class="lineNoCov">              0 : static void php_array_intersect(INTERNAL_FUNCTION_PARAMETERS, int behavior, int data_compare_type, int key_compare_type) /* {{{ */</span>
<span class="lineNum">    2990 </span>                : {
<span class="lineNum">    2991 </span><span class="lineNoCov">              0 :         zval ***args = NULL;</span>
<span class="lineNum">    2992 </span>                :         HashTable *hash;
<span class="lineNum">    2993 </span><span class="lineNoCov">              0 :         int arr_argc, i, c = 0;</span>
<span class="lineNum">    2994 </span>                :         Bucket ***lists, **list, ***ptrs, *p;
<span class="lineNum">    2995 </span>                :         int req_args;
<span class="lineNum">    2996 </span>                :         char *param_spec;
<span class="lineNum">    2997 </span>                :         zend_fcall_info fci1, fci2;
<span class="lineNum">    2998 </span><span class="lineNoCov">              0 :         zend_fcall_info_cache fci1_cache = empty_fcall_info_cache, fci2_cache = empty_fcall_info_cache;</span>
<span class="lineNum">    2999 </span>                :         zend_fcall_info *fci_key, *fci_data;
<span class="lineNum">    3000 </span>                :         zend_fcall_info_cache *fci_key_cache, *fci_data_cache;
<span class="lineNum">    3001 </span>                :         PHP_ARRAY_CMP_FUNC_VARS;
<span class="lineNum">    3002 </span>                : 
<span class="lineNum">    3003 </span>                :         int (*intersect_key_compare_func)(const void *, const void * TSRMLS_DC);
<span class="lineNum">    3004 </span>                :         int (*intersect_data_compare_func)(const void *, const void * TSRMLS_DC);
<span class="lineNum">    3005 </span>                : 
<span class="lineNum">    3006 </span><span class="lineNoCov">              0 :         if (behavior == INTERSECT_NORMAL) {</span>
<span class="lineNum">    3007 </span><span class="lineNoCov">              0 :                 intersect_key_compare_func = php_array_key_compare;</span>
<span class="lineNum">    3008 </span>                : 
<span class="lineNum">    3009 </span><span class="lineNoCov">              0 :                 if (data_compare_type == INTERSECT_COMP_DATA_INTERNAL) {</span>
<span class="lineNum">    3010 </span>                :                         /* array_intersect() */
<span class="lineNum">    3011 </span><span class="lineNoCov">              0 :                         req_args = 2;</span>
<span class="lineNum">    3012 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+&quot;;</span>
<span class="lineNum">    3013 </span><span class="lineNoCov">              0 :                         intersect_data_compare_func = php_array_data_compare;</span>
<span class="lineNum">    3014 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == INTERSECT_COMP_DATA_USER) {</span>
<span class="lineNum">    3015 </span>                :                         /* array_uintersect() */
<span class="lineNum">    3016 </span><span class="lineNoCov">              0 :                         req_args = 3;</span>
<span class="lineNum">    3017 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+f&quot;;</span>
<span class="lineNum">    3018 </span><span class="lineNoCov">              0 :                         intersect_data_compare_func = php_array_user_compare;</span>
<span class="lineNum">    3019 </span>                :                 } else {
<span class="lineNum">    3020 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;data_compare_type is %d. This should never happen. Please report as a bug&quot;, data_compare_type);</span>
<span class="lineNum">    3021 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3022 </span>                :                 }
<span class="lineNum">    3023 </span>                : 
<span class="lineNum">    3024 </span><span class="lineNoCov">              0 :                 if (ZEND_NUM_ARGS() &lt; req_args) {</span>
<span class="lineNum">    3025 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;at least %d parameters are required, %d given&quot;, req_args, ZEND_NUM_ARGS());</span>
<span class="lineNum">    3026 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3027 </span>                :                 }
<span class="lineNum">    3028 </span>                : 
<span class="lineNum">    3029 </span><span class="lineNoCov">              0 :                 if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, param_spec, &amp;args, &amp;arr_argc, &amp;fci1, &amp;fci1_cache) == FAILURE) {</span>
<span class="lineNum">    3030 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3031 </span>                :                 }
<span class="lineNum">    3032 </span><span class="lineNoCov">              0 :                 fci_data = &amp;fci1;</span>
<span class="lineNum">    3033 </span><span class="lineNoCov">              0 :                 fci_data_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3034 </span>                : 
<span class="lineNum">    3035 </span><span class="lineNoCov">              0 :         } else if (behavior &amp; INTERSECT_ASSOC) { /* triggered also when INTERSECT_KEY */</span>
<span class="lineNum">    3036 </span>                :                 /* INTERSECT_KEY is subset of INTERSECT_ASSOC. When having the former
<span class="lineNum">    3037 </span>                :                  * no comparison of the data is done (part of INTERSECT_ASSOC) */
<span class="lineNum">    3038 </span><span class="lineNoCov">              0 :                 intersect_key_compare_func = php_array_key_compare;</span>
<span class="lineNum">    3039 </span>                : 
<span class="lineNum">    3040 </span><span class="lineNoCov">              0 :                 if (data_compare_type == INTERSECT_COMP_DATA_INTERNAL &amp;&amp; key_compare_type == INTERSECT_COMP_KEY_INTERNAL) {</span>
<span class="lineNum">    3041 </span>                :                         /* array_intersect_assoc() or array_intersect_key() */
<span class="lineNum">    3042 </span><span class="lineNoCov">              0 :                         req_args = 2;</span>
<span class="lineNum">    3043 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+&quot;;</span>
<span class="lineNum">    3044 </span><span class="lineNoCov">              0 :                         intersect_key_compare_func = php_array_key_compare;</span>
<span class="lineNum">    3045 </span><span class="lineNoCov">              0 :                         intersect_data_compare_func = php_array_data_compare;</span>
<span class="lineNum">    3046 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == INTERSECT_COMP_DATA_USER &amp;&amp; key_compare_type == INTERSECT_COMP_KEY_INTERNAL) {</span>
<span class="lineNum">    3047 </span>                :                         /* array_uintersect_assoc() */
<span class="lineNum">    3048 </span><span class="lineNoCov">              0 :                         req_args = 3;</span>
<span class="lineNum">    3049 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+f&quot;;</span>
<span class="lineNum">    3050 </span><span class="lineNoCov">              0 :                         intersect_key_compare_func = php_array_key_compare;</span>
<span class="lineNum">    3051 </span><span class="lineNoCov">              0 :                         intersect_data_compare_func = php_array_user_compare;</span>
<span class="lineNum">    3052 </span><span class="lineNoCov">              0 :                         fci_data = &amp;fci1;</span>
<span class="lineNum">    3053 </span><span class="lineNoCov">              0 :                         fci_data_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3054 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == INTERSECT_COMP_DATA_INTERNAL &amp;&amp; key_compare_type == INTERSECT_COMP_KEY_USER) {</span>
<span class="lineNum">    3055 </span>                :                         /* array_intersect_uassoc() or array_intersect_ukey() */
<span class="lineNum">    3056 </span><span class="lineNoCov">              0 :                         req_args = 3;</span>
<span class="lineNum">    3057 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+f&quot;;</span>
<span class="lineNum">    3058 </span><span class="lineNoCov">              0 :                         intersect_key_compare_func = php_array_user_key_compare;</span>
<span class="lineNum">    3059 </span><span class="lineNoCov">              0 :                         intersect_data_compare_func = php_array_data_compare;</span>
<span class="lineNum">    3060 </span><span class="lineNoCov">              0 :                         fci_key = &amp;fci1;</span>
<span class="lineNum">    3061 </span><span class="lineNoCov">              0 :                         fci_key_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3062 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == INTERSECT_COMP_DATA_USER &amp;&amp; key_compare_type == INTERSECT_COMP_KEY_USER) {</span>
<span class="lineNum">    3063 </span>                :                         /* array_uintersect_uassoc() */
<span class="lineNum">    3064 </span><span class="lineNoCov">              0 :                         req_args = 4;</span>
<span class="lineNum">    3065 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+ff&quot;;</span>
<span class="lineNum">    3066 </span><span class="lineNoCov">              0 :                         intersect_key_compare_func = php_array_user_key_compare;</span>
<span class="lineNum">    3067 </span><span class="lineNoCov">              0 :                         intersect_data_compare_func = php_array_user_compare;</span>
<span class="lineNum">    3068 </span><span class="lineNoCov">              0 :                         fci_data = &amp;fci1;</span>
<span class="lineNum">    3069 </span><span class="lineNoCov">              0 :                         fci_data_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3070 </span><span class="lineNoCov">              0 :                         fci_key = &amp;fci2;</span>
<span class="lineNum">    3071 </span><span class="lineNoCov">              0 :                         fci_key_cache = &amp;fci2_cache;</span>
<span class="lineNum">    3072 </span>                :                 } else {
<span class="lineNum">    3073 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;data_compare_type is %d. key_compare_type is %d. This should never happen. Please report as a bug&quot;, data_compare_type, key_compare_type);</span>
<span class="lineNum">    3074 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3075 </span>                :                 }
<span class="lineNum">    3076 </span>                : 
<span class="lineNum">    3077 </span><span class="lineNoCov">              0 :                 if (ZEND_NUM_ARGS() &lt; req_args) {</span>
<span class="lineNum">    3078 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;at least %d parameters are required, %d given&quot;, req_args, ZEND_NUM_ARGS());</span>
<span class="lineNum">    3079 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3080 </span>                :                 }
<span class="lineNum">    3081 </span>                : 
<span class="lineNum">    3082 </span><span class="lineNoCov">              0 :                 if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, param_spec, &amp;args, &amp;arr_argc, &amp;fci1, &amp;fci1_cache, &amp;fci2, &amp;fci2_cache) == FAILURE) {</span>
<span class="lineNum">    3083 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3084 </span>                :                 }
<span class="lineNum">    3085 </span>                : 
<span class="lineNum">    3086 </span>                :         } else {
<span class="lineNum">    3087 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;behavior is %d. This should never happen. Please report as a bug&quot;, behavior);</span>
<span class="lineNum">    3088 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    3089 </span>                :         }
<span class="lineNum">    3090 </span>                : 
<span class="lineNum">    3091 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_BACKUP();</span>
<span class="lineNum">    3092 </span>                : 
<span class="lineNum">    3093 </span>                :         /* for each argument, create and sort list with pointers to the hash buckets */
<span class="lineNum">    3094 </span><span class="lineNoCov">              0 :         lists = (Bucket ***)safe_emalloc(arr_argc, sizeof(Bucket **), 0);</span>
<span class="lineNum">    3095 </span><span class="lineNoCov">              0 :         ptrs = (Bucket ***)safe_emalloc(arr_argc, sizeof(Bucket **), 0);</span>
<span class="lineNum">    3096 </span><span class="lineNoCov">              0 :         php_set_compare_func(PHP_SORT_STRING TSRMLS_CC);</span>
<span class="lineNum">    3097 </span>                : 
<span class="lineNum">    3098 </span><span class="lineNoCov">              0 :         if (behavior == INTERSECT_NORMAL &amp;&amp; data_compare_type == INTERSECT_COMP_DATA_USER) {</span>
<span class="lineNum">    3099 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci) = *fci_data;</span>
<span class="lineNum">    3100 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci_cache) = *fci_data_cache;</span>
<span class="lineNum">    3101 </span><span class="lineNoCov">              0 :         } else if (behavior &amp; INTERSECT_ASSOC &amp;&amp; key_compare_type == INTERSECT_COMP_KEY_USER) {</span>
<span class="lineNum">    3102 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci) = *fci_key;</span>
<span class="lineNum">    3103 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci_cache) = *fci_key_cache;</span>
<span class="lineNum">    3104 </span>                :         }
<span class="lineNum">    3105 </span>                : 
<span class="lineNum">    3106 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; arr_argc; i++) {</span>
<span class="lineNum">    3107 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(args[i]) != IS_ARRAY) {</span>
<span class="lineNum">    3108 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is not an array&quot;, i + 1);</span>
<span class="lineNum">    3109 </span><span class="lineNoCov">              0 :                         arr_argc = i; /* only free up to i - 1 */</span>
<span class="lineNum">    3110 </span><span class="lineNoCov">              0 :                         goto out;</span>
<span class="lineNum">    3111 </span>                :                 }
<span class="lineNum">    3112 </span><span class="lineNoCov">              0 :                 hash = Z_ARRVAL_PP(args[i]);</span>
<span class="lineNum">    3113 </span><span class="lineNoCov">              0 :                 list = (Bucket **) pemalloc((hash-&gt;nNumOfElements + 1) * sizeof(Bucket *), hash-&gt;persistent);</span>
<span class="lineNum">    3114 </span><span class="lineNoCov">              0 :                 if (!list) {</span>
<span class="lineNum">    3115 </span><span class="lineNoCov">              0 :                         PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">    3116 </span>                : 
<span class="lineNum">    3117 </span><span class="lineNoCov">              0 :                         efree(ptrs);</span>
<span class="lineNum">    3118 </span><span class="lineNoCov">              0 :                         efree(lists);</span>
<span class="lineNum">    3119 </span><span class="lineNoCov">              0 :                         efree(args);</span>
<span class="lineNum">    3120 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">    3121 </span>                :                 }
<span class="lineNum">    3122 </span><span class="lineNoCov">              0 :                 lists[i] = list;</span>
<span class="lineNum">    3123 </span><span class="lineNoCov">              0 :                 ptrs[i] = list;</span>
<span class="lineNum">    3124 </span><span class="lineNoCov">              0 :                 for (p = hash-&gt;pListHead; p; p = p-&gt;pListNext) {</span>
<span class="lineNum">    3125 </span><span class="lineNoCov">              0 :                         *list++ = p;</span>
<span class="lineNum">    3126 </span>                :                 }
<span class="lineNum">    3127 </span><span class="lineNoCov">              0 :                 *list = NULL;</span>
<span class="lineNum">    3128 </span><span class="lineNoCov">              0 :                 if (behavior == INTERSECT_NORMAL) {</span>
<span class="lineNum">    3129 </span><span class="lineNoCov">              0 :                         zend_qsort((void *) lists[i], hash-&gt;nNumOfElements, sizeof(Bucket *), intersect_data_compare_func TSRMLS_CC);</span>
<span class="lineNum">    3130 </span><span class="lineNoCov">              0 :                 } else if (behavior &amp; INTERSECT_ASSOC) { /* triggered also when INTERSECT_KEY */</span>
<span class="lineNum">    3131 </span><span class="lineNoCov">              0 :                         zend_qsort((void *) lists[i], hash-&gt;nNumOfElements, sizeof(Bucket *), intersect_key_compare_func TSRMLS_CC);</span>
<span class="lineNum">    3132 </span>                :                 }
<span class="lineNum">    3133 </span>                :         }
<span class="lineNum">    3134 </span>                : 
<span class="lineNum">    3135 </span>                :         /* copy the argument array */
<span class="lineNum">    3136 </span><span class="lineNoCov">              0 :         RETVAL_ZVAL(*args[0], 1, 0);</span>
<span class="lineNum">    3137 </span><span class="lineNoCov">              0 :         if (return_value-&gt;value.ht == &amp;EG(symbol_table)) {</span>
<span class="lineNum">    3138 </span>                :                 HashTable *ht;
<span class="lineNum">    3139 </span>                :                 zval *tmp;
<span class="lineNum">    3140 </span>                : 
<span class="lineNum">    3141 </span><span class="lineNoCov">              0 :                 ALLOC_HASHTABLE(ht);</span>
<span class="lineNum">    3142 </span><span class="lineNoCov">              0 :                 zend_hash_init(ht, zend_hash_num_elements(return_value-&gt;value.ht), NULL, ZVAL_PTR_DTOR, 0);</span>
<span class="lineNum">    3143 </span><span class="lineNoCov">              0 :                 zend_hash_copy(ht, return_value-&gt;value.ht, (copy_ctor_func_t) zval_add_ref, (void *) &amp;tmp, sizeof(zval *));</span>
<span class="lineNum">    3144 </span><span class="lineNoCov">              0 :                 return_value-&gt;value.ht = ht;</span>
<span class="lineNum">    3145 </span>                :         }
<span class="lineNum">    3146 </span>                : 
<span class="lineNum">    3147 </span>                :         /* go through the lists and look for common values */
<span class="lineNum">    3148 </span><span class="lineNoCov">              0 :         while (*ptrs[0]) {</span>
<span class="lineNum">    3149 </span><span class="lineNoCov">              0 :                 if ((behavior &amp; INTERSECT_ASSOC) /* triggered also when INTERSECT_KEY */</span>
<span class="lineNum">    3150 </span>                :                         &amp;&amp;
<span class="lineNum">    3151 </span>                :                         key_compare_type == INTERSECT_COMP_KEY_USER) {
<span class="lineNum">    3152 </span>                : 
<span class="lineNum">    3153 </span><span class="lineNoCov">              0 :                         BG(user_compare_fci) = *fci_key;</span>
<span class="lineNum">    3154 </span><span class="lineNoCov">              0 :                         BG(user_compare_fci_cache) = *fci_key_cache;</span>
<span class="lineNum">    3155 </span>                :                 }
<span class="lineNum">    3156 </span>                : 
<span class="lineNum">    3157 </span><span class="lineNoCov">              0 :                 for (i = 1; i &lt; arr_argc; i++) {</span>
<span class="lineNum">    3158 </span><span class="lineNoCov">              0 :                         if (behavior &amp; INTERSECT_NORMAL) {</span>
<span class="lineNum">    3159 </span><span class="lineNoCov">              0 :                                 while (*ptrs[i] &amp;&amp; (0 &lt; (c = intersect_data_compare_func(ptrs[0], ptrs[i] TSRMLS_CC)))) {</span>
<span class="lineNum">    3160 </span><span class="lineNoCov">              0 :                                         ptrs[i]++;</span>
<span class="lineNum">    3161 </span>                :                                 }
<span class="lineNum">    3162 </span><span class="lineNoCov">              0 :                         } else if (behavior &amp; INTERSECT_ASSOC) { /* triggered also when INTERSECT_KEY */</span>
<span class="lineNum">    3163 </span><span class="lineNoCov">              0 :                                 while (*ptrs[i] &amp;&amp; (0 &lt; (c = intersect_key_compare_func(ptrs[0], ptrs[i] TSRMLS_CC)))) {</span>
<span class="lineNum">    3164 </span><span class="lineNoCov">              0 :                                         ptrs[i]++;</span>
<span class="lineNum">    3165 </span>                :                                 }
<span class="lineNum">    3166 </span><span class="lineNoCov">              0 :                                 if ((!c &amp;&amp; *ptrs[i]) &amp;&amp; (behavior == INTERSECT_ASSOC)) { /* only when INTERSECT_ASSOC */</span>
<span class="lineNum">    3167 </span>                :                                         /* this means that ptrs[i] is not NULL so we can compare
<span class="lineNum">    3168 </span>                :                                          * and &quot;c==0&quot; is from last operation
<span class="lineNum">    3169 </span>                :                                          * in this branch of code we enter only when INTERSECT_ASSOC
<span class="lineNum">    3170 </span>                :                                          * since when we have INTERSECT_KEY compare of data is not wanted. */
<span class="lineNum">    3171 </span><span class="lineNoCov">              0 :                                         if (data_compare_type == INTERSECT_COMP_DATA_USER) {</span>
<span class="lineNum">    3172 </span><span class="lineNoCov">              0 :                                                 BG(user_compare_fci) = *fci_data;</span>
<span class="lineNum">    3173 </span><span class="lineNoCov">              0 :                                                 BG(user_compare_fci_cache) = *fci_data_cache;</span>
<span class="lineNum">    3174 </span>                :                                         }
<span class="lineNum">    3175 </span><span class="lineNoCov">              0 :                                         if (intersect_data_compare_func(ptrs[0], ptrs[i] TSRMLS_CC) != 0) {</span>
<span class="lineNum">    3176 </span><span class="lineNoCov">              0 :                                                 c = 1;</span>
<span class="lineNum">    3177 </span><span class="lineNoCov">              0 :                                                 if (key_compare_type == INTERSECT_COMP_KEY_USER) {</span>
<span class="lineNum">    3178 </span><span class="lineNoCov">              0 :                                                         BG(user_compare_fci) = *fci_key;</span>
<span class="lineNum">    3179 </span><span class="lineNoCov">              0 :                                                         BG(user_compare_fci_cache) = *fci_key_cache;</span>
<span class="lineNum">    3180 </span>                :                                                         /* When KEY_USER, the last parameter is always the callback */
<span class="lineNum">    3181 </span>                :                                                 }
<span class="lineNum">    3182 </span>                :                                                 /* we are going to the break */
<span class="lineNum">    3183 </span>                :                                         } else {
<span class="lineNum">    3184 </span>                :                                                 /* continue looping */
<span class="lineNum">    3185 </span>                :                                         }
<span class="lineNum">    3186 </span>                :                                 }
<span class="lineNum">    3187 </span>                :                         }
<span class="lineNum">    3188 </span><span class="lineNoCov">              0 :                         if (!*ptrs[i]) {</span>
<span class="lineNum">    3189 </span>                :                                 /* delete any values corresponding to remains of ptrs[0] */
<span class="lineNum">    3190 </span>                :                                 /* and exit because they do not present in at least one of */
<span class="lineNum">    3191 </span>                :                                 /* the other arguments */
<span class="lineNum">    3192 </span>                :                                 for (;;) {
<span class="lineNum">    3193 </span><span class="lineNoCov">              0 :                                         p = *ptrs[0]++;</span>
<span class="lineNum">    3194 </span><span class="lineNoCov">              0 :                                         if (!p) {</span>
<span class="lineNum">    3195 </span><span class="lineNoCov">              0 :                                                 goto out;</span>
<span class="lineNum">    3196 </span>                :                                         }
<span class="lineNum">    3197 </span><span class="lineNoCov">              0 :                                         if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    3198 </span><span class="lineNoCov">              0 :                                                 zend_hash_index_del(Z_ARRVAL_P(return_value), p-&gt;h);</span>
<span class="lineNum">    3199 </span>                :                                         } else {
<span class="lineNum">    3200 </span><span class="lineNoCov">              0 :                                                 zend_hash_quick_del(Z_ARRVAL_P(return_value), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h);</span>
<span class="lineNum">    3201 </span>                :                                         }
<span class="lineNum">    3202 </span><span class="lineNoCov">              0 :                                 }</span>
<span class="lineNum">    3203 </span>                :                         }
<span class="lineNum">    3204 </span><span class="lineNoCov">              0 :                         if (c) /* here we get if not all are equal */</span>
<span class="lineNum">    3205 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    3206 </span><span class="lineNoCov">              0 :                         ptrs[i]++;</span>
<span class="lineNum">    3207 </span>                :                 }
<span class="lineNum">    3208 </span><span class="lineNoCov">              0 :                 if (c) {</span>
<span class="lineNum">    3209 </span>                :                         /* Value of ptrs[0] not in all arguments, delete all entries */
<span class="lineNum">    3210 </span>                :                         /* with value &lt; value of ptrs[i] */
<span class="lineNum">    3211 </span>                :                         for (;;) {
<span class="lineNum">    3212 </span><span class="lineNoCov">              0 :                                 p = *ptrs[0];</span>
<span class="lineNum">    3213 </span><span class="lineNoCov">              0 :                                 if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    3214 </span><span class="lineNoCov">              0 :                                         zend_hash_index_del(Z_ARRVAL_P(return_value), p-&gt;h);</span>
<span class="lineNum">    3215 </span>                :                                 } else {
<span class="lineNum">    3216 </span><span class="lineNoCov">              0 :                                         zend_hash_quick_del(Z_ARRVAL_P(return_value), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h);</span>
<span class="lineNum">    3217 </span>                :                                 }
<span class="lineNum">    3218 </span><span class="lineNoCov">              0 :                                 if (!*++ptrs[0]) {</span>
<span class="lineNum">    3219 </span><span class="lineNoCov">              0 :                                         goto out;</span>
<span class="lineNum">    3220 </span>                :                                 }
<span class="lineNum">    3221 </span><span class="lineNoCov">              0 :                                 if (behavior == INTERSECT_NORMAL) {</span>
<span class="lineNum">    3222 </span><span class="lineNoCov">              0 :                                         if (0 &lt;= intersect_data_compare_func(ptrs[0], ptrs[i] TSRMLS_CC)) {</span>
<span class="lineNum">    3223 </span><span class="lineNoCov">              0 :                                                 break;</span>
<span class="lineNum">    3224 </span>                :                                         }
<span class="lineNum">    3225 </span><span class="lineNoCov">              0 :                                 } else if (behavior &amp; INTERSECT_ASSOC) { /* triggered also when INTERSECT_KEY */</span>
<span class="lineNum">    3226 </span>                :                                         /* no need of looping because indexes are unique */
<span class="lineNum">    3227 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3228 </span>                :                                 }
<span class="lineNum">    3229 </span><span class="lineNoCov">              0 :                         }</span>
<span class="lineNum">    3230 </span>                :                 } else {
<span class="lineNum">    3231 </span>                :                         /* ptrs[0] is present in all the arguments */
<span class="lineNum">    3232 </span>                :                         /* Skip all entries with same value as ptrs[0] */
<span class="lineNum">    3233 </span>                :                         for (;;) {
<span class="lineNum">    3234 </span><span class="lineNoCov">              0 :                                 if (!*++ptrs[0]) {</span>
<span class="lineNum">    3235 </span><span class="lineNoCov">              0 :                                         goto out;</span>
<span class="lineNum">    3236 </span>                :                                 }
<span class="lineNum">    3237 </span><span class="lineNoCov">              0 :                                 if (behavior == INTERSECT_NORMAL) {</span>
<span class="lineNum">    3238 </span><span class="lineNoCov">              0 :                                         if (intersect_data_compare_func(ptrs[0] - 1, ptrs[0] TSRMLS_CC)) {</span>
<span class="lineNum">    3239 </span><span class="lineNoCov">              0 :                                                 break;</span>
<span class="lineNum">    3240 </span>                :                                         }
<span class="lineNum">    3241 </span><span class="lineNoCov">              0 :                                 } else if (behavior &amp; INTERSECT_ASSOC) { /* triggered also when INTERSECT_KEY */</span>
<span class="lineNum">    3242 </span>                :                                         /* no need of looping because indexes are unique */
<span class="lineNum">    3243 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3244 </span>                :                                 }
<span class="lineNum">    3245 </span><span class="lineNoCov">              0 :                         }</span>
<span class="lineNum">    3246 </span>                :                 }
<span class="lineNum">    3247 </span>                :         }
<span class="lineNum">    3248 </span>                : out:
<span class="lineNum">    3249 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; arr_argc; i++) {</span>
<span class="lineNum">    3250 </span><span class="lineNoCov">              0 :                 hash = Z_ARRVAL_PP(args[i]);</span>
<span class="lineNum">    3251 </span><span class="lineNoCov">              0 :                 pefree(lists[i], hash-&gt;persistent);</span>
<span class="lineNum">    3252 </span>                :         }
<span class="lineNum">    3253 </span>                : 
<span class="lineNum">    3254 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">    3255 </span>                : 
<span class="lineNum">    3256 </span><span class="lineNoCov">              0 :         efree(ptrs);</span>
<span class="lineNum">    3257 </span><span class="lineNoCov">              0 :         efree(lists);</span>
<span class="lineNum">    3258 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    3259 </span>                : }
<span class="lineNum">    3260 </span>                : /* }}} */
<span class="lineNum">    3261 </span>                : 
<a name="3262"><span class="lineNum">    3262 </span>                : /* {{{ proto array array_intersect_key(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    3263 </span>                :    Returns the entries of arr1 that have keys which are present in all the other arguments. Kind of equivalent to array_diff(array_keys($arr1), array_keys($arr2)[,array_keys(...)]). Equivalent of array_intersect_assoc() but does not do compare of the data. */
<span class="lineNum">    3264 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_intersect_key)</span>
<span class="lineNum">    3265 </span>                : {
<span class="lineNum">    3266 </span><span class="lineNoCov">              0 :         php_array_intersect_key(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_COMP_DATA_NONE);</span>
<span class="lineNum">    3267 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3268 </span>                : /* }}} */
<span class="lineNum">    3269 </span>                : 
<a name="3270"><span class="lineNum">    3270 </span>                : /* {{{ proto array array_intersect_ukey(array arr1, array arr2 [, array ...], callback key_compare_func)</a>
<span class="lineNum">    3271 </span>                :    Returns the entries of arr1 that have keys which are present in all the other arguments. Kind of equivalent to array_diff(array_keys($arr1), array_keys($arr2)[,array_keys(...)]). The comparison of the keys is performed by a user supplied function. Equivalent of array_intersect_uassoc() but does not do compare of the data. */
<span class="lineNum">    3272 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_intersect_ukey)</span>
<span class="lineNum">    3273 </span>                : {
<span class="lineNum">    3274 </span><span class="lineNoCov">              0 :         php_array_intersect(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_KEY, INTERSECT_COMP_DATA_INTERNAL, INTERSECT_COMP_KEY_USER);</span>
<span class="lineNum">    3275 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3276 </span>                : /* }}} */
<span class="lineNum">    3277 </span>                : 
<a name="3278"><span class="lineNum">    3278 </span>                : /* {{{ proto array array_intersect(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    3279 </span>                :    Returns the entries of arr1 that have values which are present in all the other arguments */
<span class="lineNum">    3280 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_intersect)</span>
<span class="lineNum">    3281 </span>                : {
<span class="lineNum">    3282 </span><span class="lineNoCov">              0 :         php_array_intersect(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_NORMAL, INTERSECT_COMP_DATA_INTERNAL, INTERSECT_COMP_KEY_INTERNAL);</span>
<span class="lineNum">    3283 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3284 </span>                : /* }}} */
<span class="lineNum">    3285 </span>                : 
<a name="3286"><span class="lineNum">    3286 </span>                : /* {{{ proto array array_uintersect(array arr1, array arr2 [, array ...], callback data_compare_func)</a>
<span class="lineNum">    3287 </span>                :    Returns the entries of arr1 that have values which are present in all the other arguments. Data is compared by using an user-supplied callback. */
<span class="lineNum">    3288 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_uintersect)</span>
<span class="lineNum">    3289 </span>                : {
<span class="lineNum">    3290 </span><span class="lineNoCov">              0 :         php_array_intersect(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_NORMAL, INTERSECT_COMP_DATA_USER, INTERSECT_COMP_KEY_INTERNAL);</span>
<span class="lineNum">    3291 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3292 </span>                : /* }}} */
<span class="lineNum">    3293 </span>                : 
<a name="3294"><span class="lineNum">    3294 </span>                : /* {{{ proto array array_intersect_assoc(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    3295 </span>                :    Returns the entries of arr1 that have values which are present in all the other arguments. Keys are used to do more restrictive check */
<span class="lineNum">    3296 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_intersect_assoc)</span>
<span class="lineNum">    3297 </span>                : {
<span class="lineNum">    3298 </span><span class="lineNoCov">              0 :         php_array_intersect_key(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_COMP_DATA_INTERNAL);</span>
<span class="lineNum">    3299 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3300 </span>                : /* }}} */
<span class="lineNum">    3301 </span>                : 
<a name="3302"><span class="lineNum">    3302 </span>                : /* {{{ proto array array_intersect_uassoc(array arr1, array arr2 [, array ...], callback key_compare_func) U</a>
<span class="lineNum">    3303 </span>                :    Returns the entries of arr1 that have values which are present in all the other arguments. Keys are used to do more restrictive check and they are compared by using an user-supplied callback. */
<span class="lineNum">    3304 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_intersect_uassoc)</span>
<span class="lineNum">    3305 </span>                : {
<span class="lineNum">    3306 </span><span class="lineNoCov">              0 :         php_array_intersect(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_ASSOC, INTERSECT_COMP_DATA_INTERNAL, INTERSECT_COMP_KEY_USER);</span>
<span class="lineNum">    3307 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3308 </span>                : /* }}} */
<span class="lineNum">    3309 </span>                : 
<a name="3310"><span class="lineNum">    3310 </span>                : /* {{{ proto array array_uintersect_assoc(array arr1, array arr2 [, array ...], callback data_compare_func) U</a>
<span class="lineNum">    3311 </span>                :    Returns the entries of arr1 that have values which are present in all the other arguments. Keys are used to do more restrictive check. Data is compared by using an user-supplied callback. */
<span class="lineNum">    3312 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_uintersect_assoc)</span>
<span class="lineNum">    3313 </span>                : {
<span class="lineNum">    3314 </span><span class="lineNoCov">              0 :         php_array_intersect_key(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_COMP_DATA_USER);</span>
<span class="lineNum">    3315 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3316 </span>                : /* }}} */
<span class="lineNum">    3317 </span>                : 
<a name="3318"><span class="lineNum">    3318 </span>                : /* {{{ proto array array_uintersect_uassoc(array arr1, array arr2 [, array ...], callback data_compare_func, callback key_compare_func)</a>
<span class="lineNum">    3319 </span>                :    Returns the entries of arr1 that have values which are present in all the other arguments. Keys are used to do more restrictive check. Both data and keys are compared by using user-supplied callbacks. */
<span class="lineNum">    3320 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_uintersect_uassoc)</span>
<span class="lineNum">    3321 </span>                : {
<span class="lineNum">    3322 </span><span class="lineNoCov">              0 :         php_array_intersect(INTERNAL_FUNCTION_PARAM_PASSTHRU, INTERSECT_ASSOC, INTERSECT_COMP_DATA_USER, INTERSECT_COMP_KEY_USER);</span>
<span class="lineNum">    3323 </span><span class="lineNoCov">              0 : }</span>
<a name="3324"><span class="lineNum">    3324 </span>                : /* }}} */</a>
<span class="lineNum">    3325 </span>                : 
<span class="lineNum">    3326 </span><span class="lineNoCov">              0 : static void php_array_diff_key(INTERNAL_FUNCTION_PARAMETERS, int data_compare_type) /* {{{ */</span>
<span class="lineNum">    3327 </span>                : {
<span class="lineNum">    3328 </span>                :         Bucket *p;
<span class="lineNum">    3329 </span>                :         int argc, i;
<span class="lineNum">    3330 </span>                :         zval ***args;
<span class="lineNum">    3331 </span><span class="lineNoCov">              0 :         int (*diff_data_compare_func)(zval **, zval ** TSRMLS_DC) = NULL;</span>
<span class="lineNum">    3332 </span>                :         zend_bool ok;
<span class="lineNum">    3333 </span>                :         zval **data;
<span class="lineNum">    3334 </span>                : 
<span class="lineNum">    3335 </span>                :         /* Get the argument count */
<span class="lineNum">    3336 </span><span class="lineNoCov">              0 :         argc = ZEND_NUM_ARGS();</span>
<span class="lineNum">    3337 </span><span class="lineNoCov">              0 :         if (data_compare_type == DIFF_COMP_DATA_USER) {</span>
<span class="lineNum">    3338 </span><span class="lineNoCov">              0 :                 if (argc &lt; 3) {</span>
<span class="lineNum">    3339 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;at least 3 parameters are required, %d given&quot;, ZEND_NUM_ARGS());</span>
<span class="lineNum">    3340 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3341 </span>                :                 }
<span class="lineNum">    3342 </span><span class="lineNoCov">              0 :                 if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;+f&quot;, &amp;args, &amp;argc, &amp;BG(user_compare_fci), &amp;BG(user_compare_fci_cache)) == FAILURE) {</span>
<span class="lineNum">    3343 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3344 </span>                :                 }
<span class="lineNum">    3345 </span><span class="lineNoCov">              0 :                 diff_data_compare_func = zval_user_compare;</span>
<span class="lineNum">    3346 </span>                :         } else {
<span class="lineNum">    3347 </span><span class="lineNoCov">              0 :                 if (argc &lt; 2) {</span>
<span class="lineNum">    3348 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;at least 2 parameters are required, %d given&quot;, ZEND_NUM_ARGS());</span>
<span class="lineNum">    3349 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3350 </span>                :                 }
<span class="lineNum">    3351 </span><span class="lineNoCov">              0 :                 if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;+&quot;, &amp;args, &amp;argc) == FAILURE) {</span>
<span class="lineNum">    3352 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3353 </span>                :                 }
<span class="lineNum">    3354 </span><span class="lineNoCov">              0 :                 if (data_compare_type == DIFF_COMP_DATA_INTERNAL) {</span>
<span class="lineNum">    3355 </span><span class="lineNoCov">              0 :                         diff_data_compare_func = zval_compare;</span>
<span class="lineNum">    3356 </span>                :                 }
<span class="lineNum">    3357 </span>                :         }
<span class="lineNum">    3358 </span>                : 
<span class="lineNum">    3359 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; argc; i++) {</span>
<span class="lineNum">    3360 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(args[i]) != IS_ARRAY) {</span>
<span class="lineNum">    3361 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is not an array&quot;, i + 1);</span>
<span class="lineNum">    3362 </span><span class="lineNoCov">              0 :                         RETVAL_NULL();</span>
<span class="lineNum">    3363 </span><span class="lineNoCov">              0 :                         goto out;</span>
<span class="lineNum">    3364 </span>                :                 }
<span class="lineNum">    3365 </span>                :         }
<span class="lineNum">    3366 </span>                : 
<span class="lineNum">    3367 </span><span class="lineNoCov">              0 :         array_init(return_value);</span>
<span class="lineNum">    3368 </span>                : 
<span class="lineNum">    3369 </span><span class="lineNoCov">              0 :         for (p = Z_ARRVAL_PP(args[0])-&gt;pListHead; p != NULL; p = p-&gt;pListNext) {</span>
<span class="lineNum">    3370 </span><span class="lineNoCov">              0 :                 if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    3371 </span><span class="lineNoCov">              0 :                         ok = 1;</span>
<span class="lineNum">    3372 </span><span class="lineNoCov">              0 :                         for (i = 1; i &lt; argc; i++) {</span>
<span class="lineNum">    3373 </span><span class="lineNoCov">              0 :                                 if (zend_hash_index_find(Z_ARRVAL_PP(args[i]), p-&gt;h, (void**)&amp;data) == SUCCESS &amp;&amp;</span>
<span class="lineNum">    3374 </span>                :                                         (!diff_data_compare_func ||
<span class="lineNum">    3375 </span><span class="lineNoCov">              0 :                                         diff_data_compare_func((zval**)p-&gt;pData, data TSRMLS_CC) == 0)</span>
<span class="lineNum">    3376 </span>                :                                 ) {
<span class="lineNum">    3377 </span><span class="lineNoCov">              0 :                                         ok = 0;</span>
<span class="lineNum">    3378 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3379 </span>                :                                 }
<span class="lineNum">    3380 </span>                :                         }
<span class="lineNum">    3381 </span><span class="lineNoCov">              0 :                         if (ok) {</span>
<span class="lineNum">    3382 </span><span class="lineNoCov">              0 :                                 Z_ADDREF_PP((zval**)p-&gt;pData);</span>
<span class="lineNum">    3383 </span><span class="lineNoCov">              0 :                                 zend_hash_index_update(Z_ARRVAL_P(return_value), p-&gt;h, p-&gt;pData, sizeof(zval*), NULL);</span>
<span class="lineNum">    3384 </span>                :                         }
<span class="lineNum">    3385 </span>                :                 } else {
<span class="lineNum">    3386 </span><span class="lineNoCov">              0 :                         ok = 1;</span>
<span class="lineNum">    3387 </span><span class="lineNoCov">              0 :                         for (i = 1; i &lt; argc; i++) {</span>
<span class="lineNum">    3388 </span><span class="lineNoCov">              0 :                                 if (zend_hash_quick_find(Z_ARRVAL_PP(args[i]), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h, (void**)&amp;data) == SUCCESS &amp;&amp;</span>
<span class="lineNum">    3389 </span>                :                                         (!diff_data_compare_func ||
<span class="lineNum">    3390 </span><span class="lineNoCov">              0 :                                         diff_data_compare_func((zval**)p-&gt;pData, data TSRMLS_CC) == 0)</span>
<span class="lineNum">    3391 </span>                :                                 ) {
<span class="lineNum">    3392 </span><span class="lineNoCov">              0 :                                         ok = 0;</span>
<span class="lineNum">    3393 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3394 </span>                :                                 }
<span class="lineNum">    3395 </span>                :                         }
<span class="lineNum">    3396 </span><span class="lineNoCov">              0 :                         if (ok) {</span>
<span class="lineNum">    3397 </span><span class="lineNoCov">              0 :                                 Z_ADDREF_PP((zval**)p-&gt;pData);</span>
<span class="lineNum">    3398 </span><span class="lineNoCov">              0 :                                 zend_hash_quick_update(Z_ARRVAL_P(return_value), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h, p-&gt;pData, sizeof(zval*), NULL);</span>
<span class="lineNum">    3399 </span>                :                         }
<span class="lineNum">    3400 </span>                :                 }
<span class="lineNum">    3401 </span>                :         }
<span class="lineNum">    3402 </span>                : out:
<span class="lineNum">    3403 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    3404 </span>                : }
<a name="3405"><span class="lineNum">    3405 </span>                : /* }}} */</a>
<span class="lineNum">    3406 </span>                : 
<span class="lineNum">    3407 </span><span class="lineNoCov">              0 : static void php_array_diff(INTERNAL_FUNCTION_PARAMETERS, int behavior, int data_compare_type, int key_compare_type) /* {{{ */</span>
<span class="lineNum">    3408 </span>                : {
<span class="lineNum">    3409 </span><span class="lineNoCov">              0 :         zval ***args = NULL;</span>
<span class="lineNum">    3410 </span>                :         HashTable *hash;
<span class="lineNum">    3411 </span>                :         int arr_argc, i, c;
<span class="lineNum">    3412 </span>                :         Bucket ***lists, **list, ***ptrs, *p;
<span class="lineNum">    3413 </span>                :         int req_args;
<span class="lineNum">    3414 </span>                :         char *param_spec;
<span class="lineNum">    3415 </span>                :         zend_fcall_info fci1, fci2;
<span class="lineNum">    3416 </span><span class="lineNoCov">              0 :         zend_fcall_info_cache fci1_cache = empty_fcall_info_cache, fci2_cache = empty_fcall_info_cache;</span>
<span class="lineNum">    3417 </span>                :         zend_fcall_info *fci_key, *fci_data;
<span class="lineNum">    3418 </span>                :         zend_fcall_info_cache *fci_key_cache, *fci_data_cache;
<span class="lineNum">    3419 </span>                :         PHP_ARRAY_CMP_FUNC_VARS;
<span class="lineNum">    3420 </span>                : 
<span class="lineNum">    3421 </span>                :         int (*diff_key_compare_func)(const void *, const void * TSRMLS_DC);
<span class="lineNum">    3422 </span>                :         int (*diff_data_compare_func)(const void *, const void * TSRMLS_DC);
<span class="lineNum">    3423 </span>                : 
<span class="lineNum">    3424 </span><span class="lineNoCov">              0 :         if (behavior == DIFF_NORMAL) {</span>
<span class="lineNum">    3425 </span><span class="lineNoCov">              0 :                 diff_key_compare_func = php_array_key_compare;</span>
<span class="lineNum">    3426 </span>                : 
<span class="lineNum">    3427 </span><span class="lineNoCov">              0 :                 if (data_compare_type == DIFF_COMP_DATA_INTERNAL) {</span>
<span class="lineNum">    3428 </span>                :                         /* array_diff */
<span class="lineNum">    3429 </span><span class="lineNoCov">              0 :                         req_args = 2;</span>
<span class="lineNum">    3430 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+&quot;;</span>
<span class="lineNum">    3431 </span><span class="lineNoCov">              0 :                         diff_data_compare_func = php_array_data_compare;</span>
<span class="lineNum">    3432 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == DIFF_COMP_DATA_USER) {</span>
<span class="lineNum">    3433 </span>                :                         /* array_udiff */
<span class="lineNum">    3434 </span><span class="lineNoCov">              0 :                         req_args = 3;</span>
<span class="lineNum">    3435 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+f&quot;;</span>
<span class="lineNum">    3436 </span><span class="lineNoCov">              0 :                         diff_data_compare_func = php_array_user_compare;</span>
<span class="lineNum">    3437 </span>                :                 } else {
<span class="lineNum">    3438 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;data_compare_type is %d. This should never happen. Please report as a bug&quot;, data_compare_type);</span>
<span class="lineNum">    3439 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3440 </span>                :                 }
<span class="lineNum">    3441 </span>                : 
<span class="lineNum">    3442 </span><span class="lineNoCov">              0 :                 if (ZEND_NUM_ARGS() &lt; req_args) {</span>
<span class="lineNum">    3443 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;at least %d parameters are required, %d given&quot;, req_args, ZEND_NUM_ARGS());</span>
<span class="lineNum">    3444 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3445 </span>                :                 }
<span class="lineNum">    3446 </span>                : 
<span class="lineNum">    3447 </span><span class="lineNoCov">              0 :                 if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, param_spec, &amp;args, &amp;arr_argc, &amp;fci1, &amp;fci1_cache) == FAILURE) {</span>
<span class="lineNum">    3448 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3449 </span>                :                 }
<span class="lineNum">    3450 </span><span class="lineNoCov">              0 :                 fci_data = &amp;fci1;</span>
<span class="lineNum">    3451 </span><span class="lineNoCov">              0 :                 fci_data_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3452 </span>                : 
<span class="lineNum">    3453 </span><span class="lineNoCov">              0 :         } else if (behavior &amp; DIFF_ASSOC) { /* triggered also if DIFF_KEY */</span>
<span class="lineNum">    3454 </span>                :                 /* DIFF_KEY is subset of DIFF_ASSOC. When having the former
<span class="lineNum">    3455 </span>                :                  * no comparison of the data is done (part of DIFF_ASSOC) */
<span class="lineNum">    3456 </span>                : 
<span class="lineNum">    3457 </span><span class="lineNoCov">              0 :                 if (data_compare_type == DIFF_COMP_DATA_INTERNAL &amp;&amp; key_compare_type == DIFF_COMP_KEY_INTERNAL) {</span>
<span class="lineNum">    3458 </span>                :                         /* array_diff_assoc() or array_diff_key() */
<span class="lineNum">    3459 </span><span class="lineNoCov">              0 :                         req_args = 2;</span>
<span class="lineNum">    3460 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+&quot;;</span>
<span class="lineNum">    3461 </span><span class="lineNoCov">              0 :                         diff_key_compare_func = php_array_key_compare;</span>
<span class="lineNum">    3462 </span><span class="lineNoCov">              0 :                         diff_data_compare_func = php_array_data_compare;</span>
<span class="lineNum">    3463 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == DIFF_COMP_DATA_USER &amp;&amp; key_compare_type == DIFF_COMP_KEY_INTERNAL) {</span>
<span class="lineNum">    3464 </span>                :                         /* array_udiff_assoc() */
<span class="lineNum">    3465 </span><span class="lineNoCov">              0 :                         req_args = 3;</span>
<span class="lineNum">    3466 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+f&quot;;</span>
<span class="lineNum">    3467 </span><span class="lineNoCov">              0 :                         diff_key_compare_func = php_array_key_compare;</span>
<span class="lineNum">    3468 </span><span class="lineNoCov">              0 :                         diff_data_compare_func = php_array_user_compare;</span>
<span class="lineNum">    3469 </span><span class="lineNoCov">              0 :                         fci_data = &amp;fci1;</span>
<span class="lineNum">    3470 </span><span class="lineNoCov">              0 :                         fci_data_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3471 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == DIFF_COMP_DATA_INTERNAL &amp;&amp; key_compare_type == DIFF_COMP_KEY_USER) {</span>
<span class="lineNum">    3472 </span>                :                         /* array_diff_uassoc() or array_diff_ukey() */
<span class="lineNum">    3473 </span><span class="lineNoCov">              0 :                         req_args = 3;</span>
<span class="lineNum">    3474 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+f&quot;;</span>
<span class="lineNum">    3475 </span><span class="lineNoCov">              0 :                         diff_key_compare_func = php_array_user_key_compare;</span>
<span class="lineNum">    3476 </span><span class="lineNoCov">              0 :                         diff_data_compare_func = php_array_data_compare;</span>
<span class="lineNum">    3477 </span><span class="lineNoCov">              0 :                         fci_key = &amp;fci1;</span>
<span class="lineNum">    3478 </span><span class="lineNoCov">              0 :                         fci_key_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3479 </span><span class="lineNoCov">              0 :                 } else if (data_compare_type == DIFF_COMP_DATA_USER &amp;&amp; key_compare_type == DIFF_COMP_KEY_USER) {</span>
<span class="lineNum">    3480 </span>                :                         /* array_udiff_uassoc() */
<span class="lineNum">    3481 </span><span class="lineNoCov">              0 :                         req_args = 4;</span>
<span class="lineNum">    3482 </span><span class="lineNoCov">              0 :                         param_spec = &quot;+ff&quot;;</span>
<span class="lineNum">    3483 </span><span class="lineNoCov">              0 :                         diff_key_compare_func = php_array_user_key_compare;</span>
<span class="lineNum">    3484 </span><span class="lineNoCov">              0 :                         diff_data_compare_func = php_array_user_compare;</span>
<span class="lineNum">    3485 </span><span class="lineNoCov">              0 :                         fci_data = &amp;fci1;</span>
<span class="lineNum">    3486 </span><span class="lineNoCov">              0 :                         fci_data_cache = &amp;fci1_cache;</span>
<span class="lineNum">    3487 </span><span class="lineNoCov">              0 :                         fci_key = &amp;fci2;</span>
<span class="lineNum">    3488 </span><span class="lineNoCov">              0 :                         fci_key_cache = &amp;fci2_cache;</span>
<span class="lineNum">    3489 </span>                :                 } else {
<span class="lineNum">    3490 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;data_compare_type is %d. key_compare_type is %d. This should never happen. Please report as a bug&quot;, data_compare_type, key_compare_type);</span>
<span class="lineNum">    3491 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3492 </span>                :                 }
<span class="lineNum">    3493 </span>                : 
<span class="lineNum">    3494 </span><span class="lineNoCov">              0 :                 if (ZEND_NUM_ARGS() &lt; req_args) {</span>
<span class="lineNum">    3495 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;at least %d parameters are required, %d given&quot;, req_args, ZEND_NUM_ARGS());</span>
<span class="lineNum">    3496 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3497 </span>                :                 }
<span class="lineNum">    3498 </span>                : 
<span class="lineNum">    3499 </span><span class="lineNoCov">              0 :                 if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, param_spec, &amp;args, &amp;arr_argc, &amp;fci1, &amp;fci1_cache, &amp;fci2, &amp;fci2_cache) == FAILURE) {</span>
<span class="lineNum">    3500 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3501 </span>                :                 }
<span class="lineNum">    3502 </span>                : 
<span class="lineNum">    3503 </span>                :         } else {
<span class="lineNum">    3504 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;behavior is %d. This should never happen. Please report as a bug&quot;, behavior);</span>
<span class="lineNum">    3505 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    3506 </span>                :         }
<span class="lineNum">    3507 </span>                : 
<span class="lineNum">    3508 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_BACKUP();</span>
<span class="lineNum">    3509 </span>                : 
<span class="lineNum">    3510 </span>                :         /* for each argument, create and sort list with pointers to the hash buckets */
<span class="lineNum">    3511 </span><span class="lineNoCov">              0 :         lists = (Bucket ***)safe_emalloc(arr_argc, sizeof(Bucket **), 0);</span>
<span class="lineNum">    3512 </span><span class="lineNoCov">              0 :         ptrs = (Bucket ***)safe_emalloc(arr_argc, sizeof(Bucket **), 0);</span>
<span class="lineNum">    3513 </span><span class="lineNoCov">              0 :         php_set_compare_func(PHP_SORT_STRING TSRMLS_CC);</span>
<span class="lineNum">    3514 </span>                : 
<span class="lineNum">    3515 </span><span class="lineNoCov">              0 :         if (behavior == DIFF_NORMAL &amp;&amp; data_compare_type == DIFF_COMP_DATA_USER) {</span>
<span class="lineNum">    3516 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci) = *fci_data;</span>
<span class="lineNum">    3517 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci_cache) = *fci_data_cache;</span>
<span class="lineNum">    3518 </span><span class="lineNoCov">              0 :         } else if (behavior &amp; DIFF_ASSOC &amp;&amp; key_compare_type == DIFF_COMP_KEY_USER) {</span>
<span class="lineNum">    3519 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci) = *fci_key;</span>
<span class="lineNum">    3520 </span><span class="lineNoCov">              0 :                 BG(user_compare_fci_cache) = *fci_key_cache;</span>
<span class="lineNum">    3521 </span>                :         }
<span class="lineNum">    3522 </span>                : 
<span class="lineNum">    3523 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; arr_argc; i++) {</span>
<span class="lineNum">    3524 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(args[i]) != IS_ARRAY) {</span>
<span class="lineNum">    3525 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is not an array&quot;, i + 1);</span>
<span class="lineNum">    3526 </span><span class="lineNoCov">              0 :                         arr_argc = i; /* only free up to i - 1 */</span>
<span class="lineNum">    3527 </span><span class="lineNoCov">              0 :                         goto out;</span>
<span class="lineNum">    3528 </span>                :                 }
<span class="lineNum">    3529 </span><span class="lineNoCov">              0 :                 hash = Z_ARRVAL_PP(args[i]);</span>
<span class="lineNum">    3530 </span><span class="lineNoCov">              0 :                 list = (Bucket **) pemalloc((hash-&gt;nNumOfElements + 1) * sizeof(Bucket *), hash-&gt;persistent);</span>
<span class="lineNum">    3531 </span><span class="lineNoCov">              0 :                 if (!list) {</span>
<span class="lineNum">    3532 </span><span class="lineNoCov">              0 :                         PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">    3533 </span>                : 
<span class="lineNum">    3534 </span><span class="lineNoCov">              0 :                         efree(ptrs);</span>
<span class="lineNum">    3535 </span><span class="lineNoCov">              0 :                         efree(lists);</span>
<span class="lineNum">    3536 </span><span class="lineNoCov">              0 :                         efree(args);</span>
<span class="lineNum">    3537 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">    3538 </span>                :                 }
<span class="lineNum">    3539 </span><span class="lineNoCov">              0 :                 lists[i] = list;</span>
<span class="lineNum">    3540 </span><span class="lineNoCov">              0 :                 ptrs[i] = list;</span>
<span class="lineNum">    3541 </span><span class="lineNoCov">              0 :                 for (p = hash-&gt;pListHead; p; p = p-&gt;pListNext) {</span>
<span class="lineNum">    3542 </span><span class="lineNoCov">              0 :                         *list++ = p;</span>
<span class="lineNum">    3543 </span>                :                 }
<span class="lineNum">    3544 </span><span class="lineNoCov">              0 :                 *list = NULL;</span>
<span class="lineNum">    3545 </span><span class="lineNoCov">              0 :                 if (behavior == DIFF_NORMAL) {</span>
<span class="lineNum">    3546 </span><span class="lineNoCov">              0 :                         zend_qsort((void *) lists[i], hash-&gt;nNumOfElements, sizeof(Bucket *), diff_data_compare_func TSRMLS_CC);</span>
<span class="lineNum">    3547 </span><span class="lineNoCov">              0 :                 } else if (behavior &amp; DIFF_ASSOC) { /* triggered also when DIFF_KEY */</span>
<span class="lineNum">    3548 </span><span class="lineNoCov">              0 :                         zend_qsort((void *) lists[i], hash-&gt;nNumOfElements, sizeof(Bucket *), diff_key_compare_func TSRMLS_CC);</span>
<span class="lineNum">    3549 </span>                :                 }
<span class="lineNum">    3550 </span>                :         }
<span class="lineNum">    3551 </span>                : 
<span class="lineNum">    3552 </span>                :         /* copy the argument array */
<span class="lineNum">    3553 </span><span class="lineNoCov">              0 :         RETVAL_ZVAL(*args[0], 1, 0);</span>
<span class="lineNum">    3554 </span><span class="lineNoCov">              0 :         if (return_value-&gt;value.ht == &amp;EG(symbol_table)) {</span>
<span class="lineNum">    3555 </span>                :                 HashTable *ht;
<span class="lineNum">    3556 </span>                :                 zval *tmp;
<span class="lineNum">    3557 </span>                : 
<span class="lineNum">    3558 </span><span class="lineNoCov">              0 :                 ALLOC_HASHTABLE(ht);</span>
<span class="lineNum">    3559 </span><span class="lineNoCov">              0 :                 zend_hash_init(ht, zend_hash_num_elements(return_value-&gt;value.ht), NULL, ZVAL_PTR_DTOR, 0);</span>
<span class="lineNum">    3560 </span><span class="lineNoCov">              0 :                 zend_hash_copy(ht, return_value-&gt;value.ht, (copy_ctor_func_t) zval_add_ref, (void *) &amp;tmp, sizeof(zval *));</span>
<span class="lineNum">    3561 </span><span class="lineNoCov">              0 :                 return_value-&gt;value.ht = ht;</span>
<span class="lineNum">    3562 </span>                :         }
<span class="lineNum">    3563 </span>                : 
<span class="lineNum">    3564 </span>                :         /* go through the lists and look for values of ptr[0] that are not in the others */
<span class="lineNum">    3565 </span><span class="lineNoCov">              0 :         while (*ptrs[0]) {</span>
<span class="lineNum">    3566 </span><span class="lineNoCov">              0 :                 if ((behavior &amp; DIFF_ASSOC) /* triggered also when DIFF_KEY */</span>
<span class="lineNum">    3567 </span>                :                         &amp;&amp;
<span class="lineNum">    3568 </span>                :                         key_compare_type == DIFF_COMP_KEY_USER
<span class="lineNum">    3569 </span>                :                 ) {
<span class="lineNum">    3570 </span><span class="lineNoCov">              0 :                         BG(user_compare_fci) = *fci_key;</span>
<span class="lineNum">    3571 </span><span class="lineNoCov">              0 :                         BG(user_compare_fci_cache) = *fci_key_cache;</span>
<span class="lineNum">    3572 </span>                :                 }
<span class="lineNum">    3573 </span><span class="lineNoCov">              0 :                 c = 1;</span>
<span class="lineNum">    3574 </span><span class="lineNoCov">              0 :                 for (i = 1; i &lt; arr_argc; i++) {</span>
<span class="lineNum">    3575 </span><span class="lineNoCov">              0 :                         Bucket **ptr = ptrs[i];</span>
<span class="lineNum">    3576 </span><span class="lineNoCov">              0 :                         if (behavior == DIFF_NORMAL) {</span>
<span class="lineNum">    3577 </span><span class="lineNoCov">              0 :                                 while (*ptrs[i] &amp;&amp; (0 &lt; (c = diff_data_compare_func(ptrs[0], ptrs[i] TSRMLS_CC)))) {</span>
<span class="lineNum">    3578 </span><span class="lineNoCov">              0 :                                         ptrs[i]++;</span>
<span class="lineNum">    3579 </span>                :                                 }
<span class="lineNum">    3580 </span><span class="lineNoCov">              0 :                         } else if (behavior &amp; DIFF_ASSOC) { /* triggered also when DIFF_KEY */</span>
<span class="lineNum">    3581 </span><span class="lineNoCov">              0 :                                 while (*ptr &amp;&amp; (0 != (c = diff_key_compare_func(ptrs[0], ptr TSRMLS_CC)))) {</span>
<span class="lineNum">    3582 </span><span class="lineNoCov">              0 :                                         ptr++;</span>
<span class="lineNum">    3583 </span>                :                                 }
<span class="lineNum">    3584 </span>                :                         }
<span class="lineNum">    3585 </span><span class="lineNoCov">              0 :                         if (!c) {</span>
<span class="lineNum">    3586 </span><span class="lineNoCov">              0 :                                 if (behavior == DIFF_NORMAL) {</span>
<span class="lineNum">    3587 </span><span class="lineNoCov">              0 :                                         if (*ptrs[i]) {</span>
<span class="lineNum">    3588 </span><span class="lineNoCov">              0 :                                                 ptrs[i]++;</span>
<span class="lineNum">    3589 </span>                :                                         }
<span class="lineNum">    3590 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3591 </span><span class="lineNoCov">              0 :                                 } else if (behavior == DIFF_ASSOC) {  /* only when DIFF_ASSOC */</span>
<span class="lineNum">    3592 </span>                :                                         /* In this branch is execute only when DIFF_ASSOC. If behavior == DIFF_KEY
<span class="lineNum">    3593 </span>                :                                          * data comparison is not needed - skipped. */
<span class="lineNum">    3594 </span><span class="lineNoCov">              0 :                                         if (*ptr) {</span>
<span class="lineNum">    3595 </span><span class="lineNoCov">              0 :                                                 if (data_compare_type == DIFF_COMP_DATA_USER) {</span>
<span class="lineNum">    3596 </span><span class="lineNoCov">              0 :                                                         BG(user_compare_fci) = *fci_data;</span>
<span class="lineNum">    3597 </span><span class="lineNoCov">              0 :                                                         BG(user_compare_fci_cache) = *fci_data_cache;</span>
<span class="lineNum">    3598 </span>                :                                                 }
<span class="lineNum">    3599 </span><span class="lineNoCov">              0 :                                                 if (diff_data_compare_func(ptrs[0], ptr TSRMLS_CC) != 0) {</span>
<span class="lineNum">    3600 </span>                :                                                         /* the data is not the same */
<span class="lineNum">    3601 </span><span class="lineNoCov">              0 :                                                         c = -1;</span>
<span class="lineNum">    3602 </span><span class="lineNoCov">              0 :                                                         if (key_compare_type == DIFF_COMP_KEY_USER) {</span>
<span class="lineNum">    3603 </span><span class="lineNoCov">              0 :                                                                 BG(user_compare_fci) = *fci_key;</span>
<span class="lineNum">    3604 </span><span class="lineNoCov">              0 :                                                                 BG(user_compare_fci_cache) = *fci_key_cache;</span>
<span class="lineNum">    3605 </span>                :                                                         }
<span class="lineNum">    3606 </span>                :                                                 } else {
<span class="lineNum">    3607 </span><span class="lineNoCov">              0 :                                                         break;</span>
<span class="lineNum">    3608 </span>                :                                                         /* we have found the element in other arrays thus we don't want it
<span class="lineNum">    3609 </span>                :                                                          * in the return_value -&gt; delete from there */
<span class="lineNum">    3610 </span>                :                                                 }
<span class="lineNum">    3611 </span>                :                                         }
<span class="lineNum">    3612 </span><span class="lineNoCov">              0 :                                 } else if (behavior == DIFF_KEY) { /* only when DIFF_KEY */</span>
<span class="lineNum">    3613 </span>                :                                         /* the behavior here differs from INTERSECT_KEY in php_intersect
<span class="lineNum">    3614 </span>                :                                          * since in the &quot;diff&quot; case we have to remove the entry from
<span class="lineNum">    3615 </span>                :                                          * return_value while when doing intersection the entry must not
<span class="lineNum">    3616 </span>                :                                          * be deleted. */
<span class="lineNum">    3617 </span><span class="lineNoCov">              0 :                                         break; /* remove the key */</span>
<span class="lineNum">    3618 </span>                :                                 }
<span class="lineNum">    3619 </span>                :                         }
<span class="lineNum">    3620 </span>                :                 }
<span class="lineNum">    3621 </span><span class="lineNoCov">              0 :                 if (!c) {</span>
<span class="lineNum">    3622 </span>                :                         /* ptrs[0] in one of the other arguments */
<span class="lineNum">    3623 </span>                :                         /* delete all entries with value as ptrs[0] */
<span class="lineNum">    3624 </span>                :                         for (;;) {
<span class="lineNum">    3625 </span><span class="lineNoCov">              0 :                                 p = *ptrs[0];</span>
<span class="lineNum">    3626 </span><span class="lineNoCov">              0 :                                 if (p-&gt;nKeyLength == 0) {</span>
<span class="lineNum">    3627 </span><span class="lineNoCov">              0 :                                         zend_hash_index_del(Z_ARRVAL_P(return_value), p-&gt;h);</span>
<span class="lineNum">    3628 </span>                :                                 } else {
<span class="lineNum">    3629 </span><span class="lineNoCov">              0 :                                         zend_hash_quick_del(Z_ARRVAL_P(return_value), p-&gt;arKey, p-&gt;nKeyLength, p-&gt;h);</span>
<span class="lineNum">    3630 </span>                :                                 }
<span class="lineNum">    3631 </span><span class="lineNoCov">              0 :                                 if (!*++ptrs[0]) {</span>
<span class="lineNum">    3632 </span><span class="lineNoCov">              0 :                                         goto out;</span>
<span class="lineNum">    3633 </span>                :                                 }
<span class="lineNum">    3634 </span><span class="lineNoCov">              0 :                                 if (behavior == DIFF_NORMAL) {</span>
<span class="lineNum">    3635 </span><span class="lineNoCov">              0 :                                         if (diff_data_compare_func(ptrs[0] - 1, ptrs[0] TSRMLS_CC)) {</span>
<span class="lineNum">    3636 </span><span class="lineNoCov">              0 :                                                 break;</span>
<span class="lineNum">    3637 </span>                :                                         }
<span class="lineNum">    3638 </span><span class="lineNoCov">              0 :                                 } else if (behavior &amp; DIFF_ASSOC) { /* triggered also when DIFF_KEY */</span>
<span class="lineNum">    3639 </span>                :                                         /* in this case no array_key_compare is needed */
<span class="lineNum">    3640 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3641 </span>                :                                 }
<span class="lineNum">    3642 </span><span class="lineNoCov">              0 :                         }</span>
<span class="lineNum">    3643 </span>                :                 } else {
<span class="lineNum">    3644 </span>                :                         /* ptrs[0] in none of the other arguments */
<span class="lineNum">    3645 </span>                :                         /* skip all entries with value as ptrs[0] */
<span class="lineNum">    3646 </span>                :                         for (;;) {
<span class="lineNum">    3647 </span><span class="lineNoCov">              0 :                                 if (!*++ptrs[0]) {</span>
<span class="lineNum">    3648 </span><span class="lineNoCov">              0 :                                         goto out;</span>
<span class="lineNum">    3649 </span>                :                                 }
<span class="lineNum">    3650 </span><span class="lineNoCov">              0 :                                 if (behavior == DIFF_NORMAL) {</span>
<span class="lineNum">    3651 </span><span class="lineNoCov">              0 :                                         if (diff_data_compare_func(ptrs[0] - 1, ptrs[0] TSRMLS_CC)) {</span>
<span class="lineNum">    3652 </span><span class="lineNoCov">              0 :                                                 break;</span>
<span class="lineNum">    3653 </span>                :                                         }
<span class="lineNum">    3654 </span><span class="lineNoCov">              0 :                                 } else if (behavior &amp; DIFF_ASSOC) { /* triggered also when DIFF_KEY */</span>
<span class="lineNum">    3655 </span>                :                                         /* in this case no array_key_compare is needed */
<span class="lineNum">    3656 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3657 </span>                :                                 }
<span class="lineNum">    3658 </span><span class="lineNoCov">              0 :                         }</span>
<span class="lineNum">    3659 </span>                :                 }
<span class="lineNum">    3660 </span>                :         }
<span class="lineNum">    3661 </span>                : out:
<span class="lineNum">    3662 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; arr_argc; i++) {</span>
<span class="lineNum">    3663 </span><span class="lineNoCov">              0 :                 hash = Z_ARRVAL_PP(args[i]);</span>
<span class="lineNum">    3664 </span><span class="lineNoCov">              0 :                 pefree(lists[i], hash-&gt;persistent);</span>
<span class="lineNum">    3665 </span>                :         }
<span class="lineNum">    3666 </span>                : 
<span class="lineNum">    3667 </span><span class="lineNoCov">              0 :         PHP_ARRAY_CMP_FUNC_RESTORE();</span>
<span class="lineNum">    3668 </span>                : 
<span class="lineNum">    3669 </span><span class="lineNoCov">              0 :         efree(ptrs);</span>
<span class="lineNum">    3670 </span><span class="lineNoCov">              0 :         efree(lists);</span>
<span class="lineNum">    3671 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    3672 </span>                : }
<span class="lineNum">    3673 </span>                : /* }}} */
<span class="lineNum">    3674 </span>                : 
<a name="3675"><span class="lineNum">    3675 </span>                : /* {{{ proto array array_diff_key(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    3676 </span>                :    Returns the entries of arr1 that have keys which are not present in any of the others arguments. This function is like array_diff() but works on the keys instead of the values. The associativity is preserved. */
<span class="lineNum">    3677 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_diff_key)</span>
<span class="lineNum">    3678 </span>                : {
<span class="lineNum">    3679 </span><span class="lineNoCov">              0 :         php_array_diff_key(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_COMP_DATA_NONE);</span>
<span class="lineNum">    3680 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3681 </span>                : /* }}} */
<span class="lineNum">    3682 </span>                : 
<a name="3683"><span class="lineNum">    3683 </span>                : /* {{{ proto array array_diff_ukey(array arr1, array arr2 [, array ...], callback key_comp_func)</a>
<span class="lineNum">    3684 </span>                :    Returns the entries of arr1 that have keys which are not present in any of the others arguments. User supplied function is used for comparing the keys. This function is like array_udiff() but works on the keys instead of the values. The associativity is preserved. */
<span class="lineNum">    3685 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_diff_ukey)</span>
<span class="lineNum">    3686 </span>                : {
<span class="lineNum">    3687 </span><span class="lineNoCov">              0 :         php_array_diff(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_KEY, DIFF_COMP_DATA_INTERNAL, DIFF_COMP_KEY_USER);</span>
<span class="lineNum">    3688 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3689 </span>                : /* }}} */
<span class="lineNum">    3690 </span>                : 
<a name="3691"><span class="lineNum">    3691 </span>                : /* {{{ proto array array_diff(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    3692 </span>                :    Returns the entries of arr1 that have values which are not present in any of the others arguments. */
<span class="lineNum">    3693 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_diff)</span>
<span class="lineNum">    3694 </span>                : {
<span class="lineNum">    3695 </span><span class="lineNoCov">              0 :         php_array_diff(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_NORMAL, DIFF_COMP_DATA_INTERNAL, DIFF_COMP_KEY_INTERNAL);</span>
<span class="lineNum">    3696 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3697 </span>                : /* }}} */
<span class="lineNum">    3698 </span>                : 
<a name="3699"><span class="lineNum">    3699 </span>                : /* {{{ proto array array_udiff(array arr1, array arr2 [, array ...], callback data_comp_func)</a>
<span class="lineNum">    3700 </span>                :    Returns the entries of arr1 that have values which are not present in any of the others arguments. Elements are compared by user supplied function. */
<span class="lineNum">    3701 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_udiff)</span>
<span class="lineNum">    3702 </span>                : {
<span class="lineNum">    3703 </span><span class="lineNoCov">              0 :         php_array_diff(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_NORMAL, DIFF_COMP_DATA_USER, DIFF_COMP_KEY_INTERNAL);</span>
<span class="lineNum">    3704 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3705 </span>                : /* }}} */
<span class="lineNum">    3706 </span>                : 
<a name="3707"><span class="lineNum">    3707 </span>                : /* {{{ proto array array_diff_assoc(array arr1, array arr2 [, array ...])</a>
<span class="lineNum">    3708 </span>                :    Returns the entries of arr1 that have values which are not present in any of the others arguments but do additional checks whether the keys are equal */
<span class="lineNum">    3709 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_diff_assoc)</span>
<span class="lineNum">    3710 </span>                : {
<span class="lineNum">    3711 </span><span class="lineNoCov">              0 :         php_array_diff_key(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_COMP_DATA_INTERNAL);</span>
<span class="lineNum">    3712 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3713 </span>                : /* }}} */
<span class="lineNum">    3714 </span>                : 
<a name="3715"><span class="lineNum">    3715 </span>                : /* {{{ proto array array_diff_uassoc(array arr1, array arr2 [, array ...], callback data_comp_func)</a>
<span class="lineNum">    3716 </span>                :    Returns the entries of arr1 that have values which are not present in any of the others arguments but do additional checks whether the keys are equal. Elements are compared by user supplied function. */
<span class="lineNum">    3717 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_diff_uassoc)</span>
<span class="lineNum">    3718 </span>                : {
<span class="lineNum">    3719 </span><span class="lineNoCov">              0 :         php_array_diff(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_ASSOC, DIFF_COMP_DATA_INTERNAL, DIFF_COMP_KEY_USER);</span>
<span class="lineNum">    3720 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3721 </span>                : /* }}} */
<span class="lineNum">    3722 </span>                : 
<a name="3723"><span class="lineNum">    3723 </span>                : /* {{{ proto array array_udiff_assoc(array arr1, array arr2 [, array ...], callback key_comp_func)</a>
<span class="lineNum">    3724 </span>                :    Returns the entries of arr1 that have values which are not present in any of the others arguments but do additional checks whether the keys are equal. Keys are compared by user supplied function. */
<span class="lineNum">    3725 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_udiff_assoc)</span>
<span class="lineNum">    3726 </span>                : {
<span class="lineNum">    3727 </span><span class="lineNoCov">              0 :         php_array_diff_key(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_COMP_DATA_USER);</span>
<span class="lineNum">    3728 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3729 </span>                : /* }}} */
<span class="lineNum">    3730 </span>                : 
<a name="3731"><span class="lineNum">    3731 </span>                : /* {{{ proto array array_udiff_uassoc(array arr1, array arr2 [, array ...], callback data_comp_func, callback key_comp_func)</a>
<span class="lineNum">    3732 </span>                :    Returns the entries of arr1 that have values which are not present in any of the others arguments but do additional checks whether the keys are equal. Keys and elements are compared by user supplied functions. */
<span class="lineNum">    3733 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_udiff_uassoc)</span>
<span class="lineNum">    3734 </span>                : {
<span class="lineNum">    3735 </span><span class="lineNoCov">              0 :         php_array_diff(INTERNAL_FUNCTION_PARAM_PASSTHRU, DIFF_ASSOC, DIFF_COMP_DATA_USER, DIFF_COMP_KEY_USER);</span>
<span class="lineNum">    3736 </span><span class="lineNoCov">              0 : }</span>
<span class="lineNum">    3737 </span>                : /* }}} */
<span class="lineNum">    3738 </span>                : 
<span class="lineNum">    3739 </span>                : #define MULTISORT_ORDER 0
<span class="lineNum">    3740 </span>                : #define MULTISORT_TYPE  1
<a name="3741"><span class="lineNum">    3741 </span>                : #define MULTISORT_LAST  2</a>
<span class="lineNum">    3742 </span>                : 
<span class="lineNum">    3743 </span><span class="lineNoCov">              0 : PHPAPI int php_multisort_compare(const void *a, const void *b TSRMLS_DC) /* {{{ */</span>
<span class="lineNum">    3744 </span>                : {
<span class="lineNum">    3745 </span><span class="lineNoCov">              0 :         Bucket **ab = *(Bucket ***)a;</span>
<span class="lineNum">    3746 </span><span class="lineNoCov">              0 :         Bucket **bb = *(Bucket ***)b;</span>
<span class="lineNum">    3747 </span>                :         int r;
<span class="lineNum">    3748 </span><span class="lineNoCov">              0 :         int result = 0;</span>
<span class="lineNum">    3749 </span>                :         zval temp;
<span class="lineNum">    3750 </span>                : 
<span class="lineNum">    3751 </span><span class="lineNoCov">              0 :         r = 0;</span>
<span class="lineNum">    3752 </span>                :         do {
<span class="lineNum">    3753 </span><span class="lineNoCov">              0 :                 php_set_compare_func(ARRAYG(multisort_flags)[MULTISORT_TYPE][r] TSRMLS_CC);</span>
<span class="lineNum">    3754 </span>                : 
<span class="lineNum">    3755 </span><span class="lineNoCov">              0 :                 ARRAYG(compare_func)(&amp;temp, *((zval **)ab[r]-&gt;pData), *((zval **)bb[r]-&gt;pData) TSRMLS_CC);</span>
<span class="lineNum">    3756 </span><span class="lineNoCov">              0 :                 result = ARRAYG(multisort_flags)[MULTISORT_ORDER][r] * Z_LVAL(temp);</span>
<span class="lineNum">    3757 </span><span class="lineNoCov">              0 :                 if (result != 0) {</span>
<span class="lineNum">    3758 </span><span class="lineNoCov">              0 :                         return result;</span>
<span class="lineNum">    3759 </span>                :                 }
<span class="lineNum">    3760 </span><span class="lineNoCov">              0 :                 r++;</span>
<span class="lineNum">    3761 </span><span class="lineNoCov">              0 :         } while (ab[r] != NULL);</span>
<span class="lineNum">    3762 </span>                : 
<span class="lineNum">    3763 </span><span class="lineNoCov">              0 :         return result;</span>
<span class="lineNum">    3764 </span>                : }
<span class="lineNum">    3765 </span>                : /* }}} */
<span class="lineNum">    3766 </span>                : 
<span class="lineNum">    3767 </span>                : #define MULTISORT_ABORT                                         \
<span class="lineNum">    3768 </span>                :         for (k = 0; k &lt; MULTISORT_LAST; k++) \
<span class="lineNum">    3769 </span>                :                 efree(ARRAYG(multisort_flags)[k]);      \
<span class="lineNum">    3770 </span>                :         efree(arrays);                                                  \
<span class="lineNum">    3771 </span>                :         efree(args);                                                    \
<span class="lineNum">    3772 </span>                :         RETURN_FALSE;
<span class="lineNum">    3773 </span>                : 
<a name="3774"><span class="lineNum">    3774 </span>                : /* {{{ proto bool array_multisort(array ar1 [, SORT_ASC|SORT_DESC [, SORT_REGULAR|SORT_NUMERIC|SORT_STRING|SORT_NATURAL|SORT_FLAG_CASE]] [, array ar2 [, SORT_ASC|SORT_DESC [, SORT_REGULAR|SORT_NUMERIC|SORT_STRING|SORT_NATURAL|SORT_FLAG_CASE]], ...])</a>
<span class="lineNum">    3775 </span>                :    Sort multiple arrays at once similar to how ORDER BY clause works in SQL */
<span class="lineNum">    3776 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_multisort)</span>
<span class="lineNum">    3777 </span>                : {
<span class="lineNum">    3778 </span>                :         zval***                 args;
<span class="lineNum">    3779 </span>                :         zval***                 arrays;
<span class="lineNum">    3780 </span>                :         Bucket***               indirect;
<span class="lineNum">    3781 </span>                :         Bucket*                 p;
<span class="lineNum">    3782 </span>                :         HashTable*              hash;
<span class="lineNum">    3783 </span>                :         int                             argc;
<span class="lineNum">    3784 </span>                :         int                             array_size;
<span class="lineNum">    3785 </span><span class="lineNoCov">              0 :         int                             num_arrays = 0;</span>
<span class="lineNum">    3786 </span>                :         int                             parse_state[MULTISORT_LAST];   /* 0 - flag not allowed 1 - flag allowed */
<span class="lineNum">    3787 </span><span class="lineNoCov">              0 :         int                             sort_order = PHP_SORT_ASC;</span>
<span class="lineNum">    3788 </span><span class="lineNoCov">              0 :         int                             sort_type  = PHP_SORT_REGULAR;</span>
<span class="lineNum">    3789 </span>                :         int                             i, k;
<span class="lineNum">    3790 </span>                : 
<span class="lineNum">    3791 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;+&quot;, &amp;args, &amp;argc) == FAILURE) {</span>
<span class="lineNum">    3792 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    3793 </span>                :         }
<span class="lineNum">    3794 </span>                : 
<span class="lineNum">    3795 </span>                :         /* Allocate space for storing pointers to input arrays and sort flags. */
<span class="lineNum">    3796 </span><span class="lineNoCov">              0 :         arrays = (zval ***)ecalloc(argc, sizeof(zval **));</span>
<span class="lineNum">    3797 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; MULTISORT_LAST; i++) {</span>
<span class="lineNum">    3798 </span><span class="lineNoCov">              0 :                 parse_state[i] = 0;</span>
<span class="lineNum">    3799 </span><span class="lineNoCov">              0 :                 ARRAYG(multisort_flags)[i] = (int *)ecalloc(argc, sizeof(int));</span>
<span class="lineNum">    3800 </span>                :         }
<span class="lineNum">    3801 </span>                : 
<span class="lineNum">    3802 </span>                :         /* Here we go through the input arguments and parse them. Each one can
<span class="lineNum">    3803 </span>                :          * be either an array or a sort flag which follows an array. If not
<span class="lineNum">    3804 </span>                :          * specified, the sort flags defaults to PHP_SORT_ASC and PHP_SORT_REGULAR
<span class="lineNum">    3805 </span>                :          * accordingly. There can't be two sort flags of the same type after an
<span class="lineNum">    3806 </span>                :          * array, and the very first argument has to be an array. */
<span class="lineNum">    3807 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; argc; i++) {</span>
<span class="lineNum">    3808 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(args[i]) == IS_ARRAY) {</span>
<span class="lineNum">    3809 </span>                :                         /* We see the next array, so we update the sort flags of
<span class="lineNum">    3810 </span>                :                          * the previous array and reset the sort flags. */
<span class="lineNum">    3811 </span><span class="lineNoCov">              0 :                         if (i &gt; 0) {</span>
<span class="lineNum">    3812 </span><span class="lineNoCov">              0 :                                 ARRAYG(multisort_flags)[MULTISORT_ORDER][num_arrays - 1] = sort_order;</span>
<span class="lineNum">    3813 </span><span class="lineNoCov">              0 :                                 ARRAYG(multisort_flags)[MULTISORT_TYPE][num_arrays - 1] = sort_type;</span>
<span class="lineNum">    3814 </span><span class="lineNoCov">              0 :                                 sort_order = PHP_SORT_ASC;</span>
<span class="lineNum">    3815 </span><span class="lineNoCov">              0 :                                 sort_type = PHP_SORT_REGULAR;</span>
<span class="lineNum">    3816 </span>                :                         }
<span class="lineNum">    3817 </span><span class="lineNoCov">              0 :                         arrays[num_arrays++] = args[i];</span>
<span class="lineNum">    3818 </span>                : 
<span class="lineNum">    3819 </span>                :                         /* Next one may be an array or a list of sort flags. */
<span class="lineNum">    3820 </span><span class="lineNoCov">              0 :                         for (k = 0; k &lt; MULTISORT_LAST; k++) {</span>
<span class="lineNum">    3821 </span><span class="lineNoCov">              0 :                                 parse_state[k] = 1;</span>
<span class="lineNum">    3822 </span>                :                         }
<span class="lineNum">    3823 </span><span class="lineNoCov">              0 :                 } else if (Z_TYPE_PP(args[i]) == IS_LONG) {</span>
<span class="lineNum">    3824 </span><span class="lineNoCov">              0 :                         switch (Z_LVAL_PP(args[i]) &amp; ~PHP_SORT_FLAG_CASE) {</span>
<span class="lineNum">    3825 </span>                :                                 case PHP_SORT_ASC:
<span class="lineNum">    3826 </span>                :                                 case PHP_SORT_DESC:
<span class="lineNum">    3827 </span>                :                                         /* flag allowed here */
<span class="lineNum">    3828 </span><span class="lineNoCov">              0 :                                         if (parse_state[MULTISORT_ORDER] == 1) {</span>
<span class="lineNum">    3829 </span>                :                                                 /* Save the flag and make sure then next arg is not the current flag. */
<span class="lineNum">    3830 </span><span class="lineNoCov">              0 :                                                 sort_order = Z_LVAL_PP(args[i]) == PHP_SORT_DESC ? -1 : 1;</span>
<span class="lineNum">    3831 </span><span class="lineNoCov">              0 :                                                 parse_state[MULTISORT_ORDER] = 0;</span>
<span class="lineNum">    3832 </span>                :                                         } else {
<span class="lineNum">    3833 </span><span class="lineNoCov">              0 :                                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is expected to be an array or sorting flag that has not already been specified&quot;, i + 1);</span>
<span class="lineNum">    3834 </span><span class="lineNoCov">              0 :                                                 MULTISORT_ABORT;</span>
<span class="lineNum">    3835 </span>                :                                         }
<span class="lineNum">    3836 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3837 </span>                : 
<span class="lineNum">    3838 </span>                :                                 case PHP_SORT_REGULAR:
<span class="lineNum">    3839 </span>                :                                 case PHP_SORT_NUMERIC:
<span class="lineNum">    3840 </span>                :                                 case PHP_SORT_STRING:
<span class="lineNum">    3841 </span>                :                                 case PHP_SORT_NATURAL:
<span class="lineNum">    3842 </span>                : #if HAVE_STRCOLL
<span class="lineNum">    3843 </span>                :                                 case PHP_SORT_LOCALE_STRING:
<span class="lineNum">    3844 </span>                : #endif
<span class="lineNum">    3845 </span>                :                                         /* flag allowed here */
<span class="lineNum">    3846 </span><span class="lineNoCov">              0 :                                         if (parse_state[MULTISORT_TYPE] == 1) {</span>
<span class="lineNum">    3847 </span>                :                                                 /* Save the flag and make sure then next arg is not the current flag. */
<span class="lineNum">    3848 </span><span class="lineNoCov">              0 :                                                 sort_type = Z_LVAL_PP(args[i]);</span>
<span class="lineNum">    3849 </span><span class="lineNoCov">              0 :                                                 parse_state[MULTISORT_TYPE] = 0;</span>
<span class="lineNum">    3850 </span>                :                                         } else {
<span class="lineNum">    3851 </span><span class="lineNoCov">              0 :                                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is expected to be an array or sorting flag that has not already been specified&quot;, i + 1);</span>
<span class="lineNum">    3852 </span><span class="lineNoCov">              0 :                                                 MULTISORT_ABORT;</span>
<span class="lineNum">    3853 </span>                :                                         }
<span class="lineNum">    3854 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    3855 </span>                : 
<span class="lineNum">    3856 </span>                :                                 default:
<span class="lineNum">    3857 </span><span class="lineNoCov">              0 :                                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is an unknown sort flag&quot;, i + 1);</span>
<span class="lineNum">    3858 </span><span class="lineNoCov">              0 :                                         MULTISORT_ABORT;</span>
<span class="lineNum">    3859 </span>                :                                         break;
<span class="lineNum">    3860 </span>                : 
<span class="lineNum">    3861 </span>                :                         }
<span class="lineNum">    3862 </span>                :                 } else {
<span class="lineNum">    3863 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d is expected to be an array or a sort flag&quot;, i + 1);</span>
<span class="lineNum">    3864 </span><span class="lineNoCov">              0 :                         MULTISORT_ABORT;</span>
<span class="lineNum">    3865 </span>                :                 }
<span class="lineNum">    3866 </span>                :         }
<span class="lineNum">    3867 </span>                :         /* Take care of the last array sort flags. */
<span class="lineNum">    3868 </span><span class="lineNoCov">              0 :         ARRAYG(multisort_flags)[MULTISORT_ORDER][num_arrays - 1] = sort_order;</span>
<span class="lineNum">    3869 </span><span class="lineNoCov">              0 :         ARRAYG(multisort_flags)[MULTISORT_TYPE][num_arrays - 1] = sort_type;</span>
<span class="lineNum">    3870 </span>                : 
<span class="lineNum">    3871 </span>                :         /* Make sure the arrays are of the same size. */
<span class="lineNum">    3872 </span><span class="lineNoCov">              0 :         array_size = zend_hash_num_elements(Z_ARRVAL_PP(arrays[0]));</span>
<span class="lineNum">    3873 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; num_arrays; i++) {</span>
<span class="lineNum">    3874 </span><span class="lineNoCov">              0 :                 if (zend_hash_num_elements(Z_ARRVAL_PP(arrays[i])) != array_size) {</span>
<span class="lineNum">    3875 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Array sizes are inconsistent&quot;);</span>
<span class="lineNum">    3876 </span><span class="lineNoCov">              0 :                         MULTISORT_ABORT;</span>
<span class="lineNum">    3877 </span>                :                 }
<span class="lineNum">    3878 </span>                :         }
<span class="lineNum">    3879 </span>                : 
<span class="lineNum">    3880 </span>                :         /* If all arrays are empty we don't need to do anything. */
<span class="lineNum">    3881 </span><span class="lineNoCov">              0 :         if (array_size &lt; 1) {</span>
<span class="lineNum">    3882 </span><span class="lineNoCov">              0 :                 for (k = 0; k &lt; MULTISORT_LAST; k++) {</span>
<span class="lineNum">    3883 </span><span class="lineNoCov">              0 :                         efree(ARRAYG(multisort_flags)[k]);</span>
<span class="lineNum">    3884 </span>                :                 }
<span class="lineNum">    3885 </span><span class="lineNoCov">              0 :                 efree(arrays);</span>
<span class="lineNum">    3886 </span><span class="lineNoCov">              0 :                 efree(args);</span>
<span class="lineNum">    3887 </span><span class="lineNoCov">              0 :                 RETURN_TRUE;</span>
<span class="lineNum">    3888 </span>                :         }
<span class="lineNum">    3889 </span>                : 
<span class="lineNum">    3890 </span>                :         /* Create the indirection array. This array is of size MxN, where
<span class="lineNum">    3891 </span>                :          * M is the number of entries in each input array and N is the number
<span class="lineNum">    3892 </span>                :          * of the input arrays + 1. The last column is NULL to indicate the end
<span class="lineNum">    3893 </span>                :          * of the row. */
<span class="lineNum">    3894 </span><span class="lineNoCov">              0 :         indirect = (Bucket ***)safe_emalloc(array_size, sizeof(Bucket **), 0);</span>
<span class="lineNum">    3895 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; array_size; i++) {</span>
<span class="lineNum">    3896 </span><span class="lineNoCov">              0 :                 indirect[i] = (Bucket **)safe_emalloc((num_arrays + 1), sizeof(Bucket *), 0);</span>
<span class="lineNum">    3897 </span>                :         }
<span class="lineNum">    3898 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; num_arrays; i++) {</span>
<span class="lineNum">    3899 </span><span class="lineNoCov">              0 :                 k = 0;</span>
<span class="lineNum">    3900 </span><span class="lineNoCov">              0 :                 for (p = Z_ARRVAL_PP(arrays[i])-&gt;pListHead; p; p = p-&gt;pListNext, k++) {</span>
<span class="lineNum">    3901 </span><span class="lineNoCov">              0 :                         indirect[k][i] = p;</span>
<span class="lineNum">    3902 </span>                :                 }
<span class="lineNum">    3903 </span>                :         }
<span class="lineNum">    3904 </span><span class="lineNoCov">              0 :         for (k = 0; k &lt; array_size; k++) {</span>
<span class="lineNum">    3905 </span><span class="lineNoCov">              0 :                 indirect[k][num_arrays] = NULL;</span>
<span class="lineNum">    3906 </span>                :         }
<span class="lineNum">    3907 </span>                : 
<span class="lineNum">    3908 </span>                :         /* Do the actual sort magic - bada-bim, bada-boom. */
<span class="lineNum">    3909 </span><span class="lineNoCov">              0 :         zend_qsort(indirect, array_size, sizeof(Bucket **), php_multisort_compare TSRMLS_CC);</span>
<span class="lineNum">    3910 </span>                : 
<span class="lineNum">    3911 </span>                :         /* Restructure the arrays based on sorted indirect - this is mostly taken from zend_hash_sort() function. */
<span class="lineNum">    3912 </span><span class="lineNoCov">              0 :         HANDLE_BLOCK_INTERRUPTIONS();</span>
<span class="lineNum">    3913 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; num_arrays; i++) {</span>
<span class="lineNum">    3914 </span><span class="lineNoCov">              0 :                 hash = Z_ARRVAL_PP(arrays[i]);</span>
<span class="lineNum">    3915 </span><span class="lineNoCov">              0 :                 hash-&gt;pListHead = indirect[0][i];;</span>
<span class="lineNum">    3916 </span><span class="lineNoCov">              0 :                 hash-&gt;pListTail = NULL;</span>
<span class="lineNum">    3917 </span><span class="lineNoCov">              0 :                 hash-&gt;pInternalPointer = hash-&gt;pListHead;</span>
<span class="lineNum">    3918 </span>                : 
<span class="lineNum">    3919 </span><span class="lineNoCov">              0 :                 for (k = 0; k &lt; array_size; k++) {</span>
<span class="lineNum">    3920 </span><span class="lineNoCov">              0 :                         if (hash-&gt;pListTail) {</span>
<span class="lineNum">    3921 </span><span class="lineNoCov">              0 :                                 hash-&gt;pListTail-&gt;pListNext = indirect[k][i];</span>
<span class="lineNum">    3922 </span>                :                         }
<span class="lineNum">    3923 </span><span class="lineNoCov">              0 :                         indirect[k][i]-&gt;pListLast = hash-&gt;pListTail;</span>
<span class="lineNum">    3924 </span><span class="lineNoCov">              0 :                         indirect[k][i]-&gt;pListNext = NULL;</span>
<span class="lineNum">    3925 </span><span class="lineNoCov">              0 :                         hash-&gt;pListTail = indirect[k][i];</span>
<span class="lineNum">    3926 </span>                :                 }
<span class="lineNum">    3927 </span>                : 
<span class="lineNum">    3928 </span><span class="lineNoCov">              0 :                 p = hash-&gt;pListHead;</span>
<span class="lineNum">    3929 </span><span class="lineNoCov">              0 :                 k = 0;</span>
<span class="lineNum">    3930 </span><span class="lineNoCov">              0 :                 while (p != NULL) {</span>
<span class="lineNum">    3931 </span><span class="lineNoCov">              0 :                         if (p-&gt;nKeyLength == 0)</span>
<span class="lineNum">    3932 </span><span class="lineNoCov">              0 :                                 p-&gt;h = k++;</span>
<span class="lineNum">    3933 </span><span class="lineNoCov">              0 :                         p = p-&gt;pListNext;</span>
<span class="lineNum">    3934 </span>                :                 }
<span class="lineNum">    3935 </span><span class="lineNoCov">              0 :                 hash-&gt;nNextFreeElement = array_size;</span>
<span class="lineNum">    3936 </span><span class="lineNoCov">              0 :                 zend_hash_rehash(hash);</span>
<span class="lineNum">    3937 </span>                :         }
<span class="lineNum">    3938 </span><span class="lineNoCov">              0 :         HANDLE_UNBLOCK_INTERRUPTIONS();</span>
<span class="lineNum">    3939 </span>                : 
<span class="lineNum">    3940 </span>                :         /* Clean up. */
<span class="lineNum">    3941 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; array_size; i++) {</span>
<span class="lineNum">    3942 </span><span class="lineNoCov">              0 :                 efree(indirect[i]);</span>
<span class="lineNum">    3943 </span>                :         }
<span class="lineNum">    3944 </span><span class="lineNoCov">              0 :         efree(indirect);</span>
<span class="lineNum">    3945 </span><span class="lineNoCov">              0 :         for (k = 0; k &lt; MULTISORT_LAST; k++) {</span>
<span class="lineNum">    3946 </span><span class="lineNoCov">              0 :                 efree(ARRAYG(multisort_flags)[k]);</span>
<span class="lineNum">    3947 </span>                :         }
<span class="lineNum">    3948 </span><span class="lineNoCov">              0 :         efree(arrays);</span>
<span class="lineNum">    3949 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    3950 </span><span class="lineNoCov">              0 :         RETURN_TRUE;</span>
<span class="lineNum">    3951 </span>                : }
<span class="lineNum">    3952 </span>                : /* }}} */
<span class="lineNum">    3953 </span>                : 
<a name="3954"><span class="lineNum">    3954 </span>                : /* {{{ proto mixed array_rand(array input [, int num_req])</a>
<span class="lineNum">    3955 </span>                :    Return key/keys for random entry/entries in the array */
<span class="lineNum">    3956 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_rand)</span>
<span class="lineNum">    3957 </span>                : {
<span class="lineNum">    3958 </span>                :         zval *input;
<span class="lineNum">    3959 </span><span class="lineNoCov">              0 :         long randval, num_req = 1;</span>
<span class="lineNum">    3960 </span>                :         int num_avail, key_type;
<span class="lineNum">    3961 </span>                :         char *string_key;
<span class="lineNum">    3962 </span>                :         uint string_key_len;
<span class="lineNum">    3963 </span>                :         ulong num_key;
<span class="lineNum">    3964 </span>                :         HashPosition pos;
<span class="lineNum">    3965 </span>                : 
<span class="lineNum">    3966 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|l&quot;, &amp;input, &amp;num_req) == FAILURE) {</span>
<span class="lineNum">    3967 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    3968 </span>                :         }
<span class="lineNum">    3969 </span>                : 
<span class="lineNum">    3970 </span><span class="lineNoCov">              0 :         num_avail = zend_hash_num_elements(Z_ARRVAL_P(input));</span>
<span class="lineNum">    3971 </span>                : 
<span class="lineNum">    3972 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() &gt; 1) {</span>
<span class="lineNum">    3973 </span><span class="lineNoCov">              0 :                 if (num_req &lt;= 0 || num_req &gt; num_avail) {</span>
<span class="lineNum">    3974 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Second argument has to be between 1 and the number of elements in the array&quot;);</span>
<span class="lineNum">    3975 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    3976 </span>                :                 }
<span class="lineNum">    3977 </span>                :         }
<span class="lineNum">    3978 </span>                : 
<span class="lineNum">    3979 </span>                :         /* Make the return value an array only if we need to pass back more than one result. */
<span class="lineNum">    3980 </span><span class="lineNoCov">              0 :         if (num_req &gt; 1) {</span>
<span class="lineNum">    3981 </span><span class="lineNoCov">              0 :                 array_init_size(return_value, num_req);</span>
<span class="lineNum">    3982 </span>                :         }
<span class="lineNum">    3983 </span>                : 
<span class="lineNum">    3984 </span>                :         /* We can't use zend_hash_index_find() because the array may have string keys or gaps. */
<span class="lineNum">    3985 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    3986 </span><span class="lineNoCov">              0 :         while (num_req &amp;&amp; (key_type = zend_hash_get_current_key_ex(Z_ARRVAL_P(input), &amp;string_key, &amp;string_key_len, &amp;num_key, 0, &amp;pos)) != HASH_KEY_NON_EXISTANT) {</span>
<span class="lineNum">    3987 </span>                : 
<span class="lineNum">    3988 </span><span class="lineNoCov">              0 :                 randval = php_rand(TSRMLS_C);</span>
<span class="lineNum">    3989 </span>                : 
<span class="lineNum">    3990 </span><span class="lineNoCov">              0 :                 if ((double) (randval / (PHP_RAND_MAX + 1.0)) &lt; (double) num_req / (double) num_avail) {</span>
<span class="lineNum">    3991 </span>                :                         /* If we are returning a single result, just do it. */
<span class="lineNum">    3992 </span><span class="lineNoCov">              0 :                         if (Z_TYPE_P(return_value) != IS_ARRAY) {</span>
<span class="lineNum">    3993 </span><span class="lineNoCov">              0 :                                 if (key_type == HASH_KEY_IS_STRING) {</span>
<span class="lineNum">    3994 </span><span class="lineNoCov">              0 :                                         RETURN_STRINGL(string_key, string_key_len - 1, 1);</span>
<span class="lineNum">    3995 </span>                :                                 } else {
<span class="lineNum">    3996 </span><span class="lineNoCov">              0 :                                         RETURN_LONG(num_key);</span>
<span class="lineNum">    3997 </span>                :                                 }
<span class="lineNum">    3998 </span>                :                         } else {
<span class="lineNum">    3999 </span>                :                                 /* Append the result to the return value. */
<span class="lineNum">    4000 </span><span class="lineNoCov">              0 :                                 if (key_type == HASH_KEY_IS_STRING) {</span>
<span class="lineNum">    4001 </span><span class="lineNoCov">              0 :                                         add_next_index_stringl(return_value, string_key, string_key_len - 1, 1);</span>
<span class="lineNum">    4002 </span>                :                                 } else {
<span class="lineNum">    4003 </span><span class="lineNoCov">              0 :                                         add_next_index_long(return_value, num_key);</span>
<span class="lineNum">    4004 </span>                :                                 }
<span class="lineNum">    4005 </span>                :                         }
<span class="lineNum">    4006 </span><span class="lineNoCov">              0 :                         num_req--;</span>
<span class="lineNum">    4007 </span>                :                 }
<span class="lineNum">    4008 </span><span class="lineNoCov">              0 :                 num_avail--;</span>
<span class="lineNum">    4009 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    4010 </span>                :         }
<span class="lineNum">    4011 </span>                : }
<span class="lineNum">    4012 </span>                : /* }}} */
<span class="lineNum">    4013 </span>                : 
<a name="4014"><span class="lineNum">    4014 </span>                : /* {{{ proto mixed array_sum(array input)</a>
<span class="lineNum">    4015 </span>                :    Returns the sum of the array entries */
<span class="lineNum">    4016 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_sum)</span>
<span class="lineNum">    4017 </span>                : {
<span class="lineNum">    4018 </span>                :         zval *input,
<span class="lineNum">    4019 </span>                :                  **entry,
<span class="lineNum">    4020 </span>                :                  entry_n;
<span class="lineNum">    4021 </span>                :         HashPosition pos;
<span class="lineNum">    4022 </span>                :         double dval;
<span class="lineNum">    4023 </span>                : 
<span class="lineNum">    4024 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;input) == FAILURE) {</span>
<span class="lineNum">    4025 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4026 </span>                :         }
<span class="lineNum">    4027 </span>                : 
<span class="lineNum">    4028 </span><span class="lineNoCov">              0 :         ZVAL_LONG(return_value, 0);</span>
<span class="lineNum">    4029 </span>                : 
<span class="lineNum">    4030 </span><span class="lineNoCov">              0 :         for (zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    4031 </span><span class="lineNoCov">              0 :                 zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void **)&amp;entry, &amp;pos) == SUCCESS;</span>
<span class="lineNum">    4032 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;pos)</span>
<span class="lineNum">    4033 </span><span class="lineNoCov">              0 :         ) {</span>
<span class="lineNum">    4034 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(entry) == IS_ARRAY || Z_TYPE_PP(entry) == IS_OBJECT) {</span>
<span class="lineNum">    4035 </span><span class="lineNoCov">              0 :                         continue;</span>
<span class="lineNum">    4036 </span>                :                 }
<span class="lineNum">    4037 </span><span class="lineNoCov">              0 :                 entry_n = **entry;</span>
<span class="lineNum">    4038 </span>                :                 zval_copy_ctor(&amp;entry_n);
<span class="lineNum">    4039 </span><span class="lineNoCov">              0 :                 convert_scalar_to_number(&amp;entry_n TSRMLS_CC);</span>
<span class="lineNum">    4040 </span>                : 
<span class="lineNum">    4041 </span><span class="lineNoCov">              0 :                 if (Z_TYPE(entry_n) == IS_LONG &amp;&amp; Z_TYPE_P(return_value) == IS_LONG) {</span>
<span class="lineNum">    4042 </span><span class="lineNoCov">              0 :                         dval = (double)Z_LVAL_P(return_value) + (double)Z_LVAL(entry_n);</span>
<span class="lineNum">    4043 </span><span class="lineNoCov">              0 :                         if ( (double)LONG_MIN &lt;= dval &amp;&amp; dval &lt;= (double)LONG_MAX ) {</span>
<span class="lineNum">    4044 </span><span class="lineNoCov">              0 :                                 Z_LVAL_P(return_value) += Z_LVAL(entry_n);</span>
<span class="lineNum">    4045 </span><span class="lineNoCov">              0 :                                 continue;</span>
<span class="lineNum">    4046 </span>                :                         }
<span class="lineNum">    4047 </span>                :                 }
<span class="lineNum">    4048 </span><span class="lineNoCov">              0 :                 convert_to_double(return_value);</span>
<span class="lineNum">    4049 </span><span class="lineNoCov">              0 :                 convert_to_double(&amp;entry_n);</span>
<span class="lineNum">    4050 </span><span class="lineNoCov">              0 :                 Z_DVAL_P(return_value) += Z_DVAL(entry_n);</span>
<span class="lineNum">    4051 </span>                :         }
<span class="lineNum">    4052 </span>                : }
<span class="lineNum">    4053 </span>                : /* }}} */
<span class="lineNum">    4054 </span>                : 
<a name="4055"><span class="lineNum">    4055 </span>                : /* {{{ proto mixed array_product(array input)</a>
<span class="lineNum">    4056 </span>                :    Returns the product of the array entries */
<span class="lineNum">    4057 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_product)</span>
<span class="lineNum">    4058 </span>                : {
<span class="lineNum">    4059 </span>                :         zval *input,
<span class="lineNum">    4060 </span>                :                  **entry,
<span class="lineNum">    4061 </span>                :                  entry_n;
<span class="lineNum">    4062 </span>                :         HashPosition pos;
<span class="lineNum">    4063 </span>                :         double dval;
<span class="lineNum">    4064 </span>                : 
<span class="lineNum">    4065 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a&quot;, &amp;input) == FAILURE) {</span>
<span class="lineNum">    4066 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4067 </span>                :         }
<span class="lineNum">    4068 </span>                : 
<span class="lineNum">    4069 </span><span class="lineNoCov">              0 :         ZVAL_LONG(return_value, 1);</span>
<span class="lineNum">    4070 </span><span class="lineNoCov">              0 :         if (!zend_hash_num_elements(Z_ARRVAL_P(input))) {</span>
<span class="lineNum">    4071 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4072 </span>                :         }
<span class="lineNum">    4073 </span>                : 
<span class="lineNum">    4074 </span><span class="lineNoCov">              0 :         for (zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    4075 </span><span class="lineNoCov">              0 :                 zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void **)&amp;entry, &amp;pos) == SUCCESS;</span>
<span class="lineNum">    4076 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;pos)</span>
<span class="lineNum">    4077 </span><span class="lineNoCov">              0 :         ) {</span>
<span class="lineNum">    4078 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(entry) == IS_ARRAY || Z_TYPE_PP(entry) == IS_OBJECT) {</span>
<span class="lineNum">    4079 </span><span class="lineNoCov">              0 :                         continue;</span>
<span class="lineNum">    4080 </span>                :                 }
<span class="lineNum">    4081 </span><span class="lineNoCov">              0 :                 entry_n = **entry;</span>
<span class="lineNum">    4082 </span>                :                 zval_copy_ctor(&amp;entry_n);
<span class="lineNum">    4083 </span><span class="lineNoCov">              0 :                 convert_scalar_to_number(&amp;entry_n TSRMLS_CC);</span>
<span class="lineNum">    4084 </span>                : 
<span class="lineNum">    4085 </span><span class="lineNoCov">              0 :                 if (Z_TYPE(entry_n) == IS_LONG &amp;&amp; Z_TYPE_P(return_value) == IS_LONG) {</span>
<span class="lineNum">    4086 </span><span class="lineNoCov">              0 :                         dval = (double)Z_LVAL_P(return_value) * (double)Z_LVAL(entry_n);</span>
<span class="lineNum">    4087 </span><span class="lineNoCov">              0 :                         if ( (double)LONG_MIN &lt;= dval &amp;&amp; dval &lt;= (double)LONG_MAX ) {</span>
<span class="lineNum">    4088 </span><span class="lineNoCov">              0 :                                 Z_LVAL_P(return_value) *= Z_LVAL(entry_n);</span>
<span class="lineNum">    4089 </span><span class="lineNoCov">              0 :                                 continue;</span>
<span class="lineNum">    4090 </span>                :                         }
<span class="lineNum">    4091 </span>                :                 }
<span class="lineNum">    4092 </span><span class="lineNoCov">              0 :                 convert_to_double(return_value);</span>
<span class="lineNum">    4093 </span><span class="lineNoCov">              0 :                 convert_to_double(&amp;entry_n);</span>
<span class="lineNum">    4094 </span><span class="lineNoCov">              0 :                 Z_DVAL_P(return_value) *= Z_DVAL(entry_n);</span>
<span class="lineNum">    4095 </span>                :         }
<span class="lineNum">    4096 </span>                : }
<span class="lineNum">    4097 </span>                : /* }}} */
<span class="lineNum">    4098 </span>                : 
<a name="4099"><span class="lineNum">    4099 </span>                : /* {{{ proto mixed array_reduce(array input, mixed callback [, mixed initial])</a>
<span class="lineNum">    4100 </span>                :    Iteratively reduce the array to a single value via the callback. */
<span class="lineNum">    4101 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_reduce)</span>
<span class="lineNum">    4102 </span>                : {
<span class="lineNum">    4103 </span>                :         zval *input;
<span class="lineNum">    4104 </span>                :         zval **args[2];
<span class="lineNum">    4105 </span>                :         zval **operand;
<span class="lineNum">    4106 </span><span class="lineNoCov">              0 :         zval *result = NULL;</span>
<span class="lineNum">    4107 </span>                :         zval *retval;
<span class="lineNum">    4108 </span>                :         zend_fcall_info fci;
<span class="lineNum">    4109 </span><span class="lineNoCov">              0 :         zend_fcall_info_cache fci_cache = empty_fcall_info_cache;</span>
<span class="lineNum">    4110 </span><span class="lineNoCov">              0 :         zval *initial = NULL;</span>
<span class="lineNum">    4111 </span>                :         HashPosition pos;
<span class="lineNum">    4112 </span>                :         HashTable *htbl;
<span class="lineNum">    4113 </span>                : 
<span class="lineNum">    4114 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;af|z&quot;, &amp;input, &amp;fci, &amp;fci_cache, &amp;initial) == FAILURE) {</span>
<span class="lineNum">    4115 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4116 </span>                :         }
<span class="lineNum">    4117 </span>                : 
<span class="lineNum">    4118 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() &gt; 2) {</span>
<span class="lineNum">    4119 </span><span class="lineNoCov">              0 :                 ALLOC_ZVAL(result);</span>
<span class="lineNum">    4120 </span><span class="lineNoCov">              0 :                 MAKE_COPY_ZVAL(&amp;initial, result);</span>
<span class="lineNum">    4121 </span>                :         } else {
<span class="lineNum">    4122 </span><span class="lineNoCov">              0 :                 MAKE_STD_ZVAL(result);</span>
<span class="lineNum">    4123 </span><span class="lineNoCov">              0 :                 ZVAL_NULL(result);</span>
<span class="lineNum">    4124 </span>                :         }
<span class="lineNum">    4125 </span>                : 
<span class="lineNum">    4126 </span>                :         /* (zval **)input points to an element of argument stack
<span class="lineNum">    4127 </span>                :          * the base pointer of which is subject to change.
<span class="lineNum">    4128 </span>                :          * thus we need to keep the pointer to the hashtable for safety */
<span class="lineNum">    4129 </span><span class="lineNoCov">              0 :         htbl = Z_ARRVAL_P(input);</span>
<span class="lineNum">    4130 </span>                : 
<span class="lineNum">    4131 </span><span class="lineNoCov">              0 :         if (zend_hash_num_elements(htbl) == 0) {</span>
<span class="lineNum">    4132 </span><span class="lineNoCov">              0 :                 if (result) {</span>
<span class="lineNum">    4133 </span><span class="lineNoCov">              0 :                         RETVAL_ZVAL(result, 1, 1);</span>
<span class="lineNum">    4134 </span>                :                 }
<span class="lineNum">    4135 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4136 </span>                :         }
<span class="lineNum">    4137 </span>                : 
<span class="lineNum">    4138 </span><span class="lineNoCov">              0 :         fci.retval_ptr_ptr = &amp;retval;</span>
<span class="lineNum">    4139 </span><span class="lineNoCov">              0 :         fci.param_count = 2;</span>
<span class="lineNum">    4140 </span><span class="lineNoCov">              0 :         fci.no_separation = 0;</span>
<span class="lineNum">    4141 </span>                : 
<span class="lineNum">    4142 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(htbl, &amp;pos);</span>
<span class="lineNum">    4143 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(htbl, (void **)&amp;operand, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    4144 </span>                : 
<span class="lineNum">    4145 </span><span class="lineNoCov">              0 :                 if (result) {</span>
<span class="lineNum">    4146 </span><span class="lineNoCov">              0 :                         args[0] = &amp;result;</span>
<span class="lineNum">    4147 </span><span class="lineNoCov">              0 :                         args[1] = operand;</span>
<span class="lineNum">    4148 </span><span class="lineNoCov">              0 :                         fci.params = args;</span>
<span class="lineNum">    4149 </span>                : 
<span class="lineNum">    4150 </span><span class="lineNoCov">              0 :                         if (zend_call_function(&amp;fci, &amp;fci_cache TSRMLS_CC) == SUCCESS &amp;&amp; retval) {</span>
<span class="lineNum">    4151 </span><span class="lineNoCov">              0 :                                 zval_ptr_dtor(&amp;result);</span>
<span class="lineNum">    4152 </span><span class="lineNoCov">              0 :                                 result = retval;</span>
<span class="lineNum">    4153 </span>                :                         } else {
<span class="lineNum">    4154 </span><span class="lineNoCov">              0 :                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;An error occurred while invoking the reduction callback&quot;);</span>
<span class="lineNum">    4155 </span><span class="lineNoCov">              0 :                                 return;</span>
<span class="lineNum">    4156 </span>                :                         }
<span class="lineNum">    4157 </span>                :                 } else {
<span class="lineNum">    4158 </span><span class="lineNoCov">              0 :                         result = *operand;</span>
<span class="lineNum">    4159 </span><span class="lineNoCov">              0 :                         zval_add_ref(&amp;result);</span>
<span class="lineNum">    4160 </span>                :                 }
<span class="lineNum">    4161 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(htbl, &amp;pos);</span>
<span class="lineNum">    4162 </span>                :         }
<span class="lineNum">    4163 </span><span class="lineNoCov">              0 :         RETVAL_ZVAL(result, 1, 1);</span>
<span class="lineNum">    4164 </span>                : }
<span class="lineNum">    4165 </span>                : /* }}} */
<span class="lineNum">    4166 </span>                : 
<a name="4167"><span class="lineNum">    4167 </span>                : /* {{{ proto array array_filter(array input [, mixed callback])</a>
<span class="lineNum">    4168 </span>                :    Filters elements from the array via the callback. */
<span class="lineNum">    4169 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_filter)</span>
<span class="lineNum">    4170 </span>                : {
<span class="lineNum">    4171 </span>                :         zval *array;
<span class="lineNum">    4172 </span>                :         zval **operand;
<span class="lineNum">    4173 </span>                :         zval **args[1];
<span class="lineNum">    4174 </span><span class="lineNoCov">              0 :         zval *retval = NULL;</span>
<span class="lineNum">    4175 </span><span class="lineNoCov">              0 :         zend_bool have_callback = 0;</span>
<span class="lineNum">    4176 </span>                :         char *string_key;
<span class="lineNum">    4177 </span><span class="lineNoCov">              0 :         zend_fcall_info fci = empty_fcall_info;</span>
<span class="lineNum">    4178 </span><span class="lineNoCov">              0 :         zend_fcall_info_cache fci_cache = empty_fcall_info_cache;</span>
<span class="lineNum">    4179 </span>                :         uint string_key_len;
<span class="lineNum">    4180 </span>                :         ulong num_key;
<span class="lineNum">    4181 </span>                :         HashPosition pos;
<span class="lineNum">    4182 </span>                : 
<span class="lineNum">    4183 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;a|f&quot;, &amp;array, &amp;fci, &amp;fci_cache) == FAILURE) {</span>
<span class="lineNum">    4184 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4185 </span>                :         }
<span class="lineNum">    4186 </span>                : 
<span class="lineNum">    4187 </span><span class="lineNoCov">              0 :         array_init(return_value);</span>
<span class="lineNum">    4188 </span><span class="lineNoCov">              0 :         if (zend_hash_num_elements(Z_ARRVAL_P(array)) == 0) {</span>
<span class="lineNum">    4189 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4190 </span>                :         }
<span class="lineNum">    4191 </span>                : 
<span class="lineNum">    4192 </span><span class="lineNoCov">              0 :         if (ZEND_NUM_ARGS() &gt; 1) {</span>
<span class="lineNum">    4193 </span><span class="lineNoCov">              0 :                 have_callback = 1;</span>
<span class="lineNum">    4194 </span><span class="lineNoCov">              0 :                 fci.no_separation = 0;</span>
<span class="lineNum">    4195 </span><span class="lineNoCov">              0 :                 fci.retval_ptr_ptr = &amp;retval;</span>
<span class="lineNum">    4196 </span><span class="lineNoCov">              0 :                 fci.param_count = 1;</span>
<span class="lineNum">    4197 </span>                :         }
<span class="lineNum">    4198 </span>                : 
<span class="lineNum">    4199 </span><span class="lineNoCov">              0 :         for (zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(array), &amp;pos);</span>
<span class="lineNum">    4200 </span><span class="lineNoCov">              0 :                 zend_hash_get_current_data_ex(Z_ARRVAL_P(array), (void **)&amp;operand, &amp;pos) == SUCCESS;</span>
<span class="lineNum">    4201 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(array), &amp;pos)</span>
<span class="lineNum">    4202 </span><span class="lineNoCov">              0 :         ) {</span>
<span class="lineNum">    4203 </span><span class="lineNoCov">              0 :                 if (have_callback) {</span>
<span class="lineNum">    4204 </span><span class="lineNoCov">              0 :                         args[0] = operand;</span>
<span class="lineNum">    4205 </span><span class="lineNoCov">              0 :                         fci.params = args;</span>
<span class="lineNum">    4206 </span>                : 
<span class="lineNum">    4207 </span><span class="lineNoCov">              0 :                         if (zend_call_function(&amp;fci, &amp;fci_cache TSRMLS_CC) == SUCCESS &amp;&amp; retval) {</span>
<span class="lineNum">    4208 </span><span class="lineNoCov">              0 :                                 if (!zend_is_true(retval)) {</span>
<span class="lineNum">    4209 </span><span class="lineNoCov">              0 :                                         zval_ptr_dtor(&amp;retval);</span>
<span class="lineNum">    4210 </span><span class="lineNoCov">              0 :                                         continue;</span>
<span class="lineNum">    4211 </span>                :                                 } else {
<span class="lineNum">    4212 </span><span class="lineNoCov">              0 :                                         zval_ptr_dtor(&amp;retval);</span>
<span class="lineNum">    4213 </span>                :                                 }
<span class="lineNum">    4214 </span>                :                         } else {
<span class="lineNum">    4215 </span><span class="lineNoCov">              0 :                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;An error occurred while invoking the filter callback&quot;);</span>
<span class="lineNum">    4216 </span><span class="lineNoCov">              0 :                                 return;</span>
<span class="lineNum">    4217 </span>                :                         }
<span class="lineNum">    4218 </span><span class="lineNoCov">              0 :                 } else if (!zend_is_true(*operand)) {</span>
<span class="lineNum">    4219 </span><span class="lineNoCov">              0 :                         continue;</span>
<span class="lineNum">    4220 </span>                :                 }
<span class="lineNum">    4221 </span>                : 
<span class="lineNum">    4222 </span><span class="lineNoCov">              0 :                 zval_add_ref(operand);</span>
<span class="lineNum">    4223 </span><span class="lineNoCov">              0 :                 switch (zend_hash_get_current_key_ex(Z_ARRVAL_P(array), &amp;string_key, &amp;string_key_len, &amp;num_key, 0, &amp;pos)) {</span>
<span class="lineNum">    4224 </span>                :                         case HASH_KEY_IS_STRING:
<span class="lineNum">    4225 </span><span class="lineNoCov">              0 :                                 zend_hash_update(Z_ARRVAL_P(return_value), string_key, string_key_len, operand, sizeof(zval *), NULL);</span>
<span class="lineNum">    4226 </span><span class="lineNoCov">              0 :                                 break;</span>
<span class="lineNum">    4227 </span>                : 
<span class="lineNum">    4228 </span>                :                         case HASH_KEY_IS_LONG:
<span class="lineNum">    4229 </span><span class="lineNoCov">              0 :                                 zend_hash_index_update(Z_ARRVAL_P(return_value), num_key, operand, sizeof(zval *), NULL);</span>
<span class="lineNum">    4230 </span>                :                                 break;
<span class="lineNum">    4231 </span>                :                 }
<span class="lineNum">    4232 </span>                :         }
<span class="lineNum">    4233 </span>                : }
<span class="lineNum">    4234 </span>                : /* }}} */
<span class="lineNum">    4235 </span>                : 
<a name="4236"><span class="lineNum">    4236 </span>                : /* {{{ proto array array_map(mixed callback, array input1 [, array input2 ,...])</a>
<span class="lineNum">    4237 </span>                :    Applies the callback to the elements in given arrays. */
<span class="lineNum">    4238 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_map)</span>
<span class="lineNum">    4239 </span>                : {
<span class="lineNum">    4240 </span><span class="lineNoCov">              0 :         zval ***arrays = NULL;</span>
<span class="lineNum">    4241 </span><span class="lineNoCov">              0 :         int n_arrays = 0;</span>
<span class="lineNum">    4242 </span>                :         zval ***params;
<span class="lineNum">    4243 </span>                :         zval *result, *null;
<span class="lineNum">    4244 </span>                :         HashPosition *array_pos;
<span class="lineNum">    4245 </span>                :         zval **args;
<span class="lineNum">    4246 </span><span class="lineNoCov">              0 :         zend_fcall_info fci = empty_fcall_info;</span>
<span class="lineNum">    4247 </span><span class="lineNoCov">              0 :         zend_fcall_info_cache fci_cache = empty_fcall_info_cache;</span>
<span class="lineNum">    4248 </span><span class="lineNoCov">              0 :         int i, k, maxlen = 0;</span>
<span class="lineNum">    4249 </span>                :         int *array_len;
<span class="lineNum">    4250 </span>                : 
<span class="lineNum">    4251 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;f!+&quot;, &amp;fci, &amp;fci_cache, &amp;arrays, &amp;n_arrays) == FAILURE) {</span>
<span class="lineNum">    4252 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4253 </span>                :         }
<span class="lineNum">    4254 </span>                : 
<span class="lineNum">    4255 </span><span class="lineNoCov">              0 :         RETVAL_NULL();</span>
<span class="lineNum">    4256 </span>                : 
<span class="lineNum">    4257 </span><span class="lineNoCov">              0 :         args = (zval **)safe_emalloc(n_arrays, sizeof(zval *), 0);</span>
<span class="lineNum">    4258 </span><span class="lineNoCov">              0 :         array_len = (int *)safe_emalloc(n_arrays, sizeof(int), 0);</span>
<span class="lineNum">    4259 </span><span class="lineNoCov">              0 :         array_pos = (HashPosition *)safe_emalloc(n_arrays, sizeof(HashPosition), 0);</span>
<span class="lineNum">    4260 </span>                : 
<span class="lineNum">    4261 </span><span class="lineNoCov">              0 :         for (i = 0; i &lt; n_arrays; i++) {</span>
<span class="lineNum">    4262 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(arrays[i]) != IS_ARRAY) {</span>
<span class="lineNum">    4263 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Argument #%d should be an array&quot;, i + 2);</span>
<span class="lineNum">    4264 </span><span class="lineNoCov">              0 :                         efree(arrays);</span>
<span class="lineNum">    4265 </span><span class="lineNoCov">              0 :                         efree(args);</span>
<span class="lineNum">    4266 </span><span class="lineNoCov">              0 :                         efree(array_len);</span>
<span class="lineNum">    4267 </span><span class="lineNoCov">              0 :                         efree(array_pos);</span>
<span class="lineNum">    4268 </span><span class="lineNoCov">              0 :                         return;</span>
<span class="lineNum">    4269 </span>                :                 }
<span class="lineNum">    4270 </span><span class="lineNoCov">              0 :                 SEPARATE_ZVAL_IF_NOT_REF(arrays[i]);</span>
<span class="lineNum">    4271 </span><span class="lineNoCov">              0 :                 args[i] = *arrays[i];</span>
<span class="lineNum">    4272 </span><span class="lineNoCov">              0 :                 array_len[i] = zend_hash_num_elements(Z_ARRVAL_PP(arrays[i]));</span>
<span class="lineNum">    4273 </span><span class="lineNoCov">              0 :                 if (array_len[i] &gt; maxlen) {</span>
<span class="lineNum">    4274 </span><span class="lineNoCov">              0 :                         maxlen = array_len[i];</span>
<span class="lineNum">    4275 </span>                :                 }
<span class="lineNum">    4276 </span><span class="lineNoCov">              0 :                 zend_hash_internal_pointer_reset_ex(Z_ARRVAL_PP(arrays[i]), &amp;array_pos[i]);</span>
<span class="lineNum">    4277 </span>                :         }
<span class="lineNum">    4278 </span>                : 
<span class="lineNum">    4279 </span><span class="lineNoCov">              0 :         efree(arrays);</span>
<span class="lineNum">    4280 </span>                : 
<span class="lineNum">    4281 </span>                :         /* Short-circuit: if no callback and only one array, just return it. */
<span class="lineNum">    4282 </span><span class="lineNoCov">              0 :         if (!ZEND_FCI_INITIALIZED(fci) &amp;&amp; n_arrays == 1) {</span>
<span class="lineNum">    4283 </span><span class="lineNoCov">              0 :                 RETVAL_ZVAL(args[0], 1, 0);</span>
<span class="lineNum">    4284 </span><span class="lineNoCov">              0 :                 efree(array_len);</span>
<span class="lineNum">    4285 </span><span class="lineNoCov">              0 :                 efree(array_pos);</span>
<span class="lineNum">    4286 </span><span class="lineNoCov">              0 :                 efree(args);</span>
<span class="lineNum">    4287 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4288 </span>                :         }
<span class="lineNum">    4289 </span>                : 
<span class="lineNum">    4290 </span><span class="lineNoCov">              0 :         array_init_size(return_value, maxlen);</span>
<span class="lineNum">    4291 </span><span class="lineNoCov">              0 :         params = (zval ***)safe_emalloc(n_arrays, sizeof(zval **), 0);</span>
<span class="lineNum">    4292 </span><span class="lineNoCov">              0 :         MAKE_STD_ZVAL(null);</span>
<span class="lineNum">    4293 </span><span class="lineNoCov">              0 :         ZVAL_NULL(null);</span>
<span class="lineNum">    4294 </span>                : 
<span class="lineNum">    4295 </span>                :         /* We iterate through all the arrays at once. */
<span class="lineNum">    4296 </span><span class="lineNoCov">              0 :         for (k = 0; k &lt; maxlen; k++) {</span>
<span class="lineNum">    4297 </span>                :                 uint str_key_len;
<span class="lineNum">    4298 </span>                :                 ulong num_key;
<span class="lineNum">    4299 </span>                :                 char *str_key;
<span class="lineNum">    4300 </span><span class="lineNoCov">              0 :                 int key_type = 0;</span>
<span class="lineNum">    4301 </span>                : 
<span class="lineNum">    4302 </span>                :                 /* If no callback, the result will be an array, consisting of current
<span class="lineNum">    4303 </span>                :                  * entries from all arrays. */
<span class="lineNum">    4304 </span><span class="lineNoCov">              0 :                 if (!ZEND_FCI_INITIALIZED(fci)) {</span>
<span class="lineNum">    4305 </span><span class="lineNoCov">              0 :                         MAKE_STD_ZVAL(result);</span>
<span class="lineNum">    4306 </span><span class="lineNoCov">              0 :                         array_init_size(result, n_arrays);</span>
<span class="lineNum">    4307 </span>                :                 }
<span class="lineNum">    4308 </span>                : 
<span class="lineNum">    4309 </span><span class="lineNoCov">              0 :                 for (i = 0; i &lt; n_arrays; i++) {</span>
<span class="lineNum">    4310 </span>                :                         /* If this array still has elements, add the current one to the
<span class="lineNum">    4311 </span>                :                          * parameter list, otherwise use null value. */
<span class="lineNum">    4312 </span><span class="lineNoCov">              0 :                         if (k &lt; array_len[i]) {</span>
<span class="lineNum">    4313 </span><span class="lineNoCov">              0 :                                 zend_hash_get_current_data_ex(Z_ARRVAL_P(args[i]), (void **)&amp;params[i], &amp;array_pos[i]);</span>
<span class="lineNum">    4314 </span>                : 
<span class="lineNum">    4315 </span>                :                                 /* It is safe to store only last value of key type, because
<span class="lineNum">    4316 </span>                :                                  * this loop will run just once if there is only 1 array. */
<span class="lineNum">    4317 </span><span class="lineNoCov">              0 :                                 if (n_arrays == 1) {</span>
<span class="lineNum">    4318 </span><span class="lineNoCov">              0 :                                         key_type = zend_hash_get_current_key_ex(Z_ARRVAL_P(args[0]), &amp;str_key, &amp;str_key_len, &amp;num_key, 0, &amp;array_pos[i]);</span>
<span class="lineNum">    4319 </span>                :                                 }
<span class="lineNum">    4320 </span><span class="lineNoCov">              0 :                                 zend_hash_move_forward_ex(Z_ARRVAL_P(args[i]), &amp;array_pos[i]);</span>
<span class="lineNum">    4321 </span>                :                         } else {
<span class="lineNum">    4322 </span><span class="lineNoCov">              0 :                                 params[i] = &amp;null;</span>
<span class="lineNum">    4323 </span>                :                         }
<span class="lineNum">    4324 </span>                : 
<span class="lineNum">    4325 </span><span class="lineNoCov">              0 :                         if (!ZEND_FCI_INITIALIZED(fci)) {</span>
<span class="lineNum">    4326 </span><span class="lineNoCov">              0 :                                 zval_add_ref(params[i]);</span>
<span class="lineNum">    4327 </span><span class="lineNoCov">              0 :                                 add_next_index_zval(result, *params[i]);</span>
<span class="lineNum">    4328 </span>                :                         }
<span class="lineNum">    4329 </span>                :                 }
<span class="lineNum">    4330 </span>                : 
<span class="lineNum">    4331 </span><span class="lineNoCov">              0 :                 if (ZEND_FCI_INITIALIZED(fci)) {</span>
<span class="lineNum">    4332 </span><span class="lineNoCov">              0 :                         fci.retval_ptr_ptr = &amp;result;</span>
<span class="lineNum">    4333 </span><span class="lineNoCov">              0 :                         fci.param_count = n_arrays;</span>
<span class="lineNum">    4334 </span><span class="lineNoCov">              0 :                         fci.params = params;</span>
<span class="lineNum">    4335 </span><span class="lineNoCov">              0 :                         fci.no_separation = 0;</span>
<span class="lineNum">    4336 </span>                : 
<span class="lineNum">    4337 </span><span class="lineNoCov">              0 :                         if (zend_call_function(&amp;fci, &amp;fci_cache TSRMLS_CC) != SUCCESS || !result) {</span>
<span class="lineNum">    4338 </span><span class="lineNoCov">              0 :                                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;An error occurred while invoking the map callback&quot;);</span>
<span class="lineNum">    4339 </span><span class="lineNoCov">              0 :                                 efree(array_len);</span>
<span class="lineNum">    4340 </span><span class="lineNoCov">              0 :                                 efree(args);</span>
<span class="lineNum">    4341 </span><span class="lineNoCov">              0 :                                 efree(array_pos);</span>
<span class="lineNum">    4342 </span>                :                                 zval_dtor(return_value);
<span class="lineNum">    4343 </span><span class="lineNoCov">              0 :                                 zval_ptr_dtor(&amp;null);</span>
<span class="lineNum">    4344 </span><span class="lineNoCov">              0 :                                 efree(params);</span>
<span class="lineNum">    4345 </span><span class="lineNoCov">              0 :                                 RETURN_NULL();</span>
<span class="lineNum">    4346 </span>                :                         }
<span class="lineNum">    4347 </span>                :                 }
<span class="lineNum">    4348 </span>                : 
<span class="lineNum">    4349 </span><span class="lineNoCov">              0 :                 if (n_arrays &gt; 1) {</span>
<span class="lineNum">    4350 </span><span class="lineNoCov">              0 :                         add_next_index_zval(return_value, result);</span>
<span class="lineNum">    4351 </span>                :                 } else {
<span class="lineNum">    4352 </span><span class="lineNoCov">              0 :                         if (key_type == HASH_KEY_IS_STRING) {</span>
<span class="lineNum">    4353 </span><span class="lineNoCov">              0 :                                 add_assoc_zval_ex(return_value, str_key, str_key_len, result);</span>
<span class="lineNum">    4354 </span>                :                         } else {
<span class="lineNum">    4355 </span><span class="lineNoCov">              0 :                                 add_index_zval(return_value, num_key, result);</span>
<span class="lineNum">    4356 </span>                :                         }
<span class="lineNum">    4357 </span>                :                 }
<span class="lineNum">    4358 </span>                :         }
<span class="lineNum">    4359 </span>                : 
<span class="lineNum">    4360 </span><span class="lineNoCov">              0 :         zval_ptr_dtor(&amp;null);</span>
<span class="lineNum">    4361 </span><span class="lineNoCov">              0 :         efree(params);</span>
<span class="lineNum">    4362 </span><span class="lineNoCov">              0 :         efree(array_len);</span>
<span class="lineNum">    4363 </span><span class="lineNoCov">              0 :         efree(array_pos);</span>
<span class="lineNum">    4364 </span><span class="lineNoCov">              0 :         efree(args);</span>
<span class="lineNum">    4365 </span>                : }
<span class="lineNum">    4366 </span>                : /* }}} */
<span class="lineNum">    4367 </span>                : 
<a name="4368"><span class="lineNum">    4368 </span>                : /* {{{ proto bool array_key_exists(mixed key, array search)</a>
<span class="lineNum">    4369 </span>                :    Checks if the given key or index exists in the array */
<span class="lineNum">    4370 </span><span class="lineCov">            462 : PHP_FUNCTION(array_key_exists)</span>
<span class="lineNum">    4371 </span>                : {
<span class="lineNum">    4372 </span>                :         zval *key;                                      /* key to check for */
<span class="lineNum">    4373 </span>                :         HashTable *array;                       /* array to check in */
<span class="lineNum">    4374 </span>                : 
<span class="lineNum">    4375 </span><span class="lineCov">            462 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;zH&quot;, &amp;key, &amp;array) == FAILURE) {</span>
<span class="lineNum">    4376 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4377 </span>                :         }
<span class="lineNum">    4378 </span>                : 
<span class="lineNum">    4379 </span><span class="lineCov">            462 :         switch (Z_TYPE_P(key)) {</span>
<span class="lineNum">    4380 </span>                :                 case IS_STRING:
<span class="lineNum">    4381 </span><span class="lineCov">            462 :                         if (zend_symtable_exists(array, Z_STRVAL_P(key), Z_STRLEN_P(key) + 1)) {</span>
<span class="lineNum">    4382 </span><span class="lineCov">              1 :                                 RETURN_TRUE;</span>
<span class="lineNum">    4383 </span>                :                         }
<span class="lineNum">    4384 </span><span class="lineCov">            461 :                         RETURN_FALSE;</span>
<span class="lineNum">    4385 </span>                :                 case IS_LONG:
<span class="lineNum">    4386 </span><span class="lineNoCov">              0 :                         if (zend_hash_index_exists(array, Z_LVAL_P(key))) {</span>
<span class="lineNum">    4387 </span><span class="lineNoCov">              0 :                                 RETURN_TRUE;</span>
<span class="lineNum">    4388 </span>                :                         }
<span class="lineNum">    4389 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">    4390 </span>                :                 case IS_NULL:
<span class="lineNum">    4391 </span><span class="lineNoCov">              0 :                         if (zend_hash_exists(array, &quot;&quot;, 1)) {</span>
<span class="lineNum">    4392 </span><span class="lineNoCov">              0 :                                 RETURN_TRUE;</span>
<span class="lineNum">    4393 </span>                :                         }
<span class="lineNum">    4394 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">    4395 </span>                : 
<span class="lineNum">    4396 </span>                :                 default:
<span class="lineNum">    4397 </span><span class="lineNoCov">              0 :                         php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;The first argument should be either a string or an integer&quot;);</span>
<span class="lineNum">    4398 </span><span class="lineNoCov">              0 :                         RETURN_FALSE;</span>
<span class="lineNum">    4399 </span>                :         }
<span class="lineNum">    4400 </span>                : }
<span class="lineNum">    4401 </span>                : /* }}} */
<span class="lineNum">    4402 </span>                : 
<a name="4403"><span class="lineNum">    4403 </span>                : /* {{{ proto array array_chunk(array input, int size [, bool preserve_keys])</a>
<span class="lineNum">    4404 </span>                :    Split array into chunks */
<span class="lineNum">    4405 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_chunk)</span>
<span class="lineNum">    4406 </span>                : {
<span class="lineNum">    4407 </span><span class="lineNoCov">              0 :         int argc = ZEND_NUM_ARGS(), key_type, num_in;</span>
<span class="lineNum">    4408 </span><span class="lineNoCov">              0 :         long size, current = 0;</span>
<span class="lineNum">    4409 </span>                :         char *str_key;
<span class="lineNum">    4410 </span>                :         uint str_key_len;
<span class="lineNum">    4411 </span>                :         ulong num_key;
<span class="lineNum">    4412 </span><span class="lineNoCov">              0 :         zend_bool preserve_keys = 0;</span>
<span class="lineNum">    4413 </span><span class="lineNoCov">              0 :         zval *input = NULL;</span>
<span class="lineNum">    4414 </span><span class="lineNoCov">              0 :         zval *chunk = NULL;</span>
<span class="lineNum">    4415 </span>                :         zval **entry;
<span class="lineNum">    4416 </span>                :         HashPosition pos;
<span class="lineNum">    4417 </span>                : 
<span class="lineNum">    4418 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(argc TSRMLS_CC, &quot;al|b&quot;, &amp;input, &amp;size, &amp;preserve_keys) == FAILURE) {</span>
<span class="lineNum">    4419 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4420 </span>                :         }
<span class="lineNum">    4421 </span>                :         /* Do bounds checking for size parameter. */
<span class="lineNum">    4422 </span><span class="lineNoCov">              0 :         if (size &lt; 1) {</span>
<span class="lineNum">    4423 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Size parameter expected to be greater than 0&quot;);</span>
<span class="lineNum">    4424 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4425 </span>                :         }
<span class="lineNum">    4426 </span>                : 
<span class="lineNum">    4427 </span><span class="lineNoCov">              0 :         num_in = zend_hash_num_elements(Z_ARRVAL_P(input));</span>
<span class="lineNum">    4428 </span>                : 
<span class="lineNum">    4429 </span><span class="lineNoCov">              0 :         if (size &gt; num_in) {</span>
<span class="lineNum">    4430 </span><span class="lineNoCov">              0 :                 size = num_in &gt; 0 ? num_in : 1;</span>
<span class="lineNum">    4431 </span>                :         }
<span class="lineNum">    4432 </span>                : 
<span class="lineNum">    4433 </span><span class="lineNoCov">              0 :         array_init_size(return_value, ((num_in - 1) / size) + 1);</span>
<span class="lineNum">    4434 </span>                : 
<span class="lineNum">    4435 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    4436 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(input), (void**)&amp;entry, &amp;pos) == SUCCESS) {</span>
<span class="lineNum">    4437 </span>                :                 /* If new chunk, create and initialize it. */
<span class="lineNum">    4438 </span><span class="lineNoCov">              0 :                 if (!chunk) {</span>
<span class="lineNum">    4439 </span><span class="lineNoCov">              0 :                         MAKE_STD_ZVAL(chunk);</span>
<span class="lineNum">    4440 </span><span class="lineNoCov">              0 :                         array_init_size(chunk, size);</span>
<span class="lineNum">    4441 </span>                :                 }
<span class="lineNum">    4442 </span>                : 
<span class="lineNum">    4443 </span>                :                 /* Add entry to the chunk, preserving keys if necessary. */
<span class="lineNum">    4444 </span><span class="lineNoCov">              0 :                 zval_add_ref(entry);</span>
<span class="lineNum">    4445 </span>                : 
<span class="lineNum">    4446 </span><span class="lineNoCov">              0 :                 if (preserve_keys) {</span>
<span class="lineNum">    4447 </span><span class="lineNoCov">              0 :                         key_type = zend_hash_get_current_key_ex(Z_ARRVAL_P(input), &amp;str_key, &amp;str_key_len, &amp;num_key, 0, &amp;pos);</span>
<span class="lineNum">    4448 </span><span class="lineNoCov">              0 :                         switch (key_type) {</span>
<span class="lineNum">    4449 </span>                :                                 case HASH_KEY_IS_STRING:
<span class="lineNum">    4450 </span><span class="lineNoCov">              0 :                                         add_assoc_zval_ex(chunk, str_key, str_key_len, *entry);</span>
<span class="lineNum">    4451 </span><span class="lineNoCov">              0 :                                         break;</span>
<span class="lineNum">    4452 </span>                :                                 default:
<span class="lineNum">    4453 </span><span class="lineNoCov">              0 :                                         add_index_zval(chunk, num_key, *entry);</span>
<span class="lineNum">    4454 </span>                :                                         break;
<span class="lineNum">    4455 </span>                :                         }
<span class="lineNum">    4456 </span>                :                 } else {
<span class="lineNum">    4457 </span><span class="lineNoCov">              0 :                         add_next_index_zval(chunk, *entry);</span>
<span class="lineNum">    4458 </span>                :                 }
<span class="lineNum">    4459 </span>                : 
<span class="lineNum">    4460 </span>                :                 /* If reached the chunk size, add it to the result array, and reset the
<span class="lineNum">    4461 </span>                :                  * pointer. */
<span class="lineNum">    4462 </span><span class="lineNoCov">              0 :                 if (!(++current % size)) {</span>
<span class="lineNum">    4463 </span><span class="lineNoCov">              0 :                         add_next_index_zval(return_value, chunk);</span>
<span class="lineNum">    4464 </span><span class="lineNoCov">              0 :                         chunk = NULL;</span>
<span class="lineNum">    4465 </span>                :                 }
<span class="lineNum">    4466 </span>                : 
<span class="lineNum">    4467 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(input), &amp;pos);</span>
<span class="lineNum">    4468 </span>                :         }
<span class="lineNum">    4469 </span>                : 
<span class="lineNum">    4470 </span>                :         /* Add the final chunk if there is one. */
<span class="lineNum">    4471 </span><span class="lineNoCov">              0 :         if (chunk) {</span>
<span class="lineNum">    4472 </span><span class="lineNoCov">              0 :                 add_next_index_zval(return_value, chunk);</span>
<span class="lineNum">    4473 </span>                :         }
<span class="lineNum">    4474 </span>                : }
<span class="lineNum">    4475 </span>                : /* }}} */
<span class="lineNum">    4476 </span>                : 
<a name="4477"><span class="lineNum">    4477 </span>                : /* {{{ proto array array_combine(array keys, array values)</a>
<span class="lineNum">    4478 </span>                :    Creates an array by using the elements of the first parameter as keys and the elements of the second as the corresponding values */
<span class="lineNum">    4479 </span><span class="lineNoCov">              0 : PHP_FUNCTION(array_combine)</span>
<span class="lineNum">    4480 </span>                : {
<span class="lineNum">    4481 </span>                :         zval *values, *keys;
<span class="lineNum">    4482 </span>                :         HashPosition pos_values, pos_keys;
<span class="lineNum">    4483 </span>                :         zval **entry_keys, **entry_values;
<span class="lineNum">    4484 </span>                :         int num_keys, num_values;
<span class="lineNum">    4485 </span>                : 
<span class="lineNum">    4486 </span><span class="lineNoCov">              0 :         if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;aa&quot;, &amp;keys, &amp;values) == FAILURE) {</span>
<span class="lineNum">    4487 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4488 </span>                :         }
<span class="lineNum">    4489 </span>                : 
<span class="lineNum">    4490 </span><span class="lineNoCov">              0 :         num_keys = zend_hash_num_elements(Z_ARRVAL_P(keys));</span>
<span class="lineNum">    4491 </span><span class="lineNoCov">              0 :         num_values = zend_hash_num_elements(Z_ARRVAL_P(values));</span>
<span class="lineNum">    4492 </span>                : 
<span class="lineNum">    4493 </span><span class="lineNoCov">              0 :         if (num_keys != num_values) {</span>
<span class="lineNum">    4494 </span><span class="lineNoCov">              0 :                 php_error_docref(NULL TSRMLS_CC, E_WARNING, &quot;Both parameters should have an equal number of elements&quot;);</span>
<span class="lineNum">    4495 </span><span class="lineNoCov">              0 :                 RETURN_FALSE;</span>
<span class="lineNum">    4496 </span>                :         }
<span class="lineNum">    4497 </span>                : 
<span class="lineNum">    4498 </span><span class="lineNoCov">              0 :         array_init_size(return_value, num_keys);</span>
<span class="lineNum">    4499 </span>                : 
<span class="lineNum">    4500 </span><span class="lineNoCov">              0 :         if (!num_keys) {</span>
<span class="lineNum">    4501 </span><span class="lineNoCov">              0 :                 return;</span>
<span class="lineNum">    4502 </span>                :         }
<span class="lineNum">    4503 </span>                : 
<span class="lineNum">    4504 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(keys), &amp;pos_keys);</span>
<span class="lineNum">    4505 </span><span class="lineNoCov">              0 :         zend_hash_internal_pointer_reset_ex(Z_ARRVAL_P(values), &amp;pos_values);</span>
<span class="lineNum">    4506 </span><span class="lineNoCov">              0 :         while (zend_hash_get_current_data_ex(Z_ARRVAL_P(keys), (void **)&amp;entry_keys, &amp;pos_keys) == SUCCESS &amp;&amp;</span>
<span class="lineNum">    4507 </span><span class="lineNoCov">              0 :                 zend_hash_get_current_data_ex(Z_ARRVAL_P(values), (void **)&amp;entry_values, &amp;pos_values) == SUCCESS</span>
<span class="lineNum">    4508 </span>                :         ) {
<span class="lineNum">    4509 </span><span class="lineNoCov">              0 :                 if (Z_TYPE_PP(entry_keys) == IS_LONG) {</span>
<span class="lineNum">    4510 </span><span class="lineNoCov">              0 :                         zval_add_ref(entry_values);</span>
<span class="lineNum">    4511 </span><span class="lineNoCov">              0 :                         add_index_zval(return_value, Z_LVAL_PP(entry_keys), *entry_values);</span>
<span class="lineNum">    4512 </span>                :                 } else {
<span class="lineNum">    4513 </span><span class="lineNoCov">              0 :                         zval key, *key_ptr = *entry_keys;</span>
<span class="lineNum">    4514 </span>                : 
<span class="lineNum">    4515 </span><span class="lineNoCov">              0 :                         if (Z_TYPE_PP(entry_keys) != IS_STRING) {</span>
<span class="lineNum">    4516 </span><span class="lineNoCov">              0 :                                 key = **entry_keys;</span>
<span class="lineNum">    4517 </span>                :                                 zval_copy_ctor(&amp;key);
<span class="lineNum">    4518 </span><span class="lineNoCov">              0 :                                 convert_to_string(&amp;key);</span>
<span class="lineNum">    4519 </span><span class="lineNoCov">              0 :                                 key_ptr = &amp;key;</span>
<span class="lineNum">    4520 </span>                :                         }
<span class="lineNum">    4521 </span>                : 
<span class="lineNum">    4522 </span><span class="lineNoCov">              0 :                         zval_add_ref(entry_values);</span>
<span class="lineNum">    4523 </span><span class="lineNoCov">              0 :                         add_assoc_zval_ex(return_value, Z_STRVAL_P(key_ptr), Z_STRLEN_P(key_ptr) + 1, *entry_values);</span>
<span class="lineNum">    4524 </span>                : 
<span class="lineNum">    4525 </span><span class="lineNoCov">              0 :                         if (key_ptr != *entry_keys) {</span>
<span class="lineNum">    4526 </span>                :                                 zval_dtor(&amp;key);
<span class="lineNum">    4527 </span>                :                         }
<span class="lineNum">    4528 </span>                :                 }
<span class="lineNum">    4529 </span>                : 
<span class="lineNum">    4530 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(keys), &amp;pos_keys);</span>
<span class="lineNum">    4531 </span><span class="lineNoCov">              0 :                 zend_hash_move_forward_ex(Z_ARRVAL_P(values), &amp;pos_values);</span>
<span class="lineNum">    4532 </span>                :         }
<span class="lineNum">    4533 </span>                : }
<span class="lineNum">    4534 </span>                : /* }}} */
<span class="lineNum">    4535 </span>                : 
<span class="lineNum">    4536 </span>                : /*
<span class="lineNum">    4537 </span>                :  * Local variables:
<span class="lineNum">    4538 </span>                :  * tab-width: 4
<span class="lineNum">    4539 </span>                :  * c-basic-offset: 4
<span class="lineNum">    4540 </span>                :  * End:
<span class="lineNum">    4541 </span>                :  * vim600: noet sw=4 ts=4 fdm=marker
<span class="lineNum">    4542 </span>                :  * vim&lt;600: noet sw=4 ts=4
<span class="lineNum">    4543 </span>                :  */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
  <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.7</a></td></tr>
  </table>
  <br>

</body>
</html>
